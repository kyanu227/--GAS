<link
  href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;900&family=Noto+Sans+JP:wght@400;700;900&display=swap"
  rel="stylesheet">

<div id="app-container" class="app-wrapper theme-default">
  <div class="app-bg-overlay"></div>

  <div class="pt-4 px-3">
    <div class="container-fluid" style="max-width: 600px;">

      <div class="status-card shadow-2xl position-relative overflow-hidden p-4 text-white">
        <div class="card-curve-bg"></div>
        <div class="card-shine-effect"></div>

        <div class="position-relative z-1">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="rank-pill px-3 py-1 d-flex align-items-center gap-2 shadow-sm">
              <i id="rank-icon" class="bi bi-stars"></i>
              <span id="my-rank-text" class="small fw-bold ls-2 text-uppercase">LOADING</span>
            </div>

            <button class="btn btn-link text-inherit p-0 opacity-75 hover-scale"
              onclick="loadMyPageData(window.GLOBAL_PASSCODE)">
              <i class="bi bi-arrow-clockwise fs-5"></i>
            </button>
          </div>

          <div class="mb-4 text-content">
            <h1 class="display-6 fw-900 mb-0 text-truncate text-shadow-lg" id="my-name">...</h1>
          </div>

          <div class="row align-items-end text-content">
            <div class="col-6">
              <div class="opacity-75 small mb-1 fw-bold">Estimated</div>
              <div class="fs-2 fw-900 font-num lh-1 text-glow">
                <span class="fs-5 opacity-75">¥</span><span id="my-money">0</span>
              </div>
            </div>
            <div class="col-6 text-end">
              <div class="d-flex justify-content-end align-items-end gap-2 mb-2">
                <span class="fs-4 fw-bold font-num lh-1" id="my-score">0</span>
                <span class="small opacity-75 fw-bold">pt</span>
              </div>
              <div class="progress progress-glass" style="height: 6px;">
                <div id="rank-progress" class="progress-bar shadow-glow" role="progressbar" style="width: 0%;"></div>
              </div>
              <div class="small opacity-75 mt-1 font-num fw-bold">Next +<span id="score-diff">0</span></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

</div>

<style>
  /* --- 基本設定 --- */
  :root {
    --app-font: 'Inter', 'Noto Sans JP', sans-serif;
  }

  body {
    font-family: var(--app-font);
    margin: 0;
    background-color: #f3f4f6;
  }

  .app-wrapper {
    min-height: 100vh;
    display: flex;
    flex-direction: column;
  }

  .fw-900 {
    font-weight: 900;
  }

  .font-num {
    font-family: 'Inter', sans-serif;
    font-feature-settings: "tnum";
    letter-spacing: -0.5px;
  }

  .text-shadow-lg {
    text-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
  }

  .text-shadow-sm {
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
  }

  .no-scrollbar::-webkit-scrollbar {
    display: none;
  }

  .custom-scroll::-webkit-scrollbar {
    width: 4px;
  }

  .custom-scroll::-webkit-scrollbar-thumb {
    background-color: rgba(128, 128, 128, 0.3);
    border-radius: 2px;
  }

  /* テーマカラー定義 */
  .theme-default {
    --app-bg: #f3f4f6;
    --card-bg: linear-gradient(135deg, #0f2027 0%, #203a43 100%);
    --log-bg: #fff;
    --text-main: #333;
    --text-card: #fff;
    --accent: #3b82f6;
    --border: rgba(0, 0, 0, 0.1);
    --glass-bg: rgba(0, 0, 0, 0.05);
    --glass-active: rgba(0, 0, 0, 0.1);
    --tab-inactive-bg: #f8f9fa;
  }

  .rank-platinum {
    --app-bg: #0a0a0a;
    --card-bg: radial-gradient(circle at 100% 0%, #333 0%, #000 100%);
    --log-bg: #141414;
    --text-main: #f0f0f0;
    --text-card: #d4af37;
    --accent: #d4af37;
    --border: rgba(212, 175, 55, 0.3);
    --glass-bg: rgba(255, 255, 255, 0.1);
    --glass-active: rgba(212, 175, 55, 0.6);
    --tab-inactive-bg: #222;
  }

  .rank-platinum h1,
  .rank-platinum .text-glow {
    background: linear-gradient(to bottom, #fff 30%, #f3e5ab 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }

  .rank-platinum .progress-bar {
    background: linear-gradient(90deg, #d4af37, #f1c40f);
  }

  .rank-gold {
    --app-bg: #fdfcf5;
    --card-bg: linear-gradient(135deg, #f0e6cc 0%, #e5c365 40%, #b38728 100%);
    --log-bg: #fffbf0;
    --text-main: #4a3b00;
    --text-card: #4a3b00;
    --accent: #b8860b;
    --border: rgba(184, 134, 11, 0.2);
    --glass-bg: rgba(184, 134, 11, 0.1);
    --glass-active: rgba(184, 134, 11, 0.3);
    --tab-inactive-bg: rgba(184, 134, 11, 0.05);
  }

  .rank-silver {
    --app-bg: #f0f4f8;
    --card-bg: linear-gradient(135deg, #ffffff 0%, #eef2f3 30%, #aebcce 100%);
    --log-bg: #ffffff;
    --text-main: #1e293b;
    --text-card: #1e293b;
    --accent: #334155;
    --border: rgba(51, 65, 85, 0.15);
    --glass-bg: rgba(51, 65, 85, 0.05);
    --glass-active: rgba(51, 65, 85, 0.2);
    --tab-inactive-bg: #f1f5f9;
  }

  .rank-bronze {
    --app-bg: #fdf8f6;
    --card-bg: linear-gradient(135deg, #e67e52 0%, #b3542b 60%, #873e23 100%);
    --log-bg: #fff;
    --text-main: #5d4037;
    --text-card: #fff;
    --accent: #d84315;
    --border: rgba(216, 67, 21, 0.2);
    --glass-bg: rgba(216, 67, 21, 0.05);
    --glass-active: rgba(216, 67, 21, 0.2);
    --tab-inactive-bg: #fbe9e7;
  }

  .rank-regular {
    --app-bg: #f3f4f6;
    --card-bg: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
    --log-bg: #fff;
    --text-main: #333;
    --text-card: #fff;
    --accent: #1e3c72;
    --border: rgba(0, 0, 0, 0.1);
    --glass-bg: rgba(0, 0, 0, 0.05);
    --glass-active: rgba(30, 60, 114, 0.2);
    --tab-inactive-bg: #eee;
  }

  /* コンポーネント */
  .app-wrapper {
    background-color: var(--app-bg);
    transition: background-color 0.8s ease;
  }

  .app-bg-overlay {
    position: absolute;
    inset: 0;
    pointer-events: none;
    background: radial-gradient(circle at 50% 0%, rgba(255, 255, 255, 0.05) 0%, transparent 60%);
  }

  .text-content,
  .text-inherit {
    color: var(--text-card);
  }

  .text-main {
    color: var(--text-main);
  }

  .accent-color {
    color: var(--accent);
  }

  .border-theme {
    border-color: var(--border) !important;
  }

  /* ステータスカード */
  .status-card {
    background: var(--card-bg);
    border-radius: 28px;
    box-shadow: 0 30px 60px -15px rgba(0, 0, 0, 0.35);
    border: 1px solid var(--border);
    position: relative;
    z-index: 10;
    color: var(--text-card);

    /* ▼▼▼ 修正箇所: 高さを確保し、内容を中央揃えにする設定 ▼▼▼ */
    min-height: 240px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    /* ▲▲▲ 修正ここまで ▲▲▲ */
  }

  .card-curve-bg {
    position: absolute;
    inset: 0;
    opacity: 0.15;
    pointer-events: none;
    background-image: url("data:image/svg+xml,%3Csvg width='100%25' height='100%25' viewBox='0 0 100 100' preserveAspectRatio='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M0 100 C 20 0 50 0 100 100' stroke='white' stroke-width='0.8' fill='none' opacity='0.3'/%3E%3Cpath d='M0 100 C 30 30 70 30 100 100' stroke='white' stroke-width='0.8' fill='none' opacity='0.2'/%3E%3C/svg%3E");
    background-size: cover;
    mix-blend-mode: overlay;
  }

  .card-shine-effect {
    position: absolute;
    top: -100%;
    left: -100%;
    width: 300%;
    height: 300%;
    background: linear-gradient(115deg, transparent 35%, rgba(255, 255, 255, 0.3) 45%, transparent 55%);
    animation: shine 6s infinite cubic-bezier(0.4, 0, 0.2, 1);
    pointer-events: none;
  }

  @keyframes shine {
    0% {
      transform: translate(0, 0);
    }

    100% {
      transform: translate(40%, 40%);
    }
  }

  .rank-pill {
    border-radius: 30px;
    background: rgba(255, 255, 255, 0.15);
    backdrop-filter: blur(10px);
    border: 1px solid var(--border);
  }

  .progress-glass {
    background: rgba(0, 0, 0, 0.25);
    border-radius: 10px;
    overflow: hidden;
    box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.2);
  }

  .progress-bar {
    background-color: var(--text-card);
  }

  /* ログパネル・リスト */
  .log-panel {
    background: var(--log-bg);
    border: 1px solid var(--border);
    transition: background 0.5s ease;
  }

  .glass-btn {
    background: var(--glass-bg);
    color: var(--text-main);
    border: 1px solid var(--border);
    transition: all 0.2s;
  }

  .glass-btn:hover {
    background: var(--glass-active);
  }

  .hover-scale:active {
    transform: scale(0.95);
    transition: 0.2s;
  }

  .nav-pills .nav-link {
    color: var(--text-main);
    opacity: 0.6;
    background: transparent;
    border-radius: 6px;
    transition: all 0.2s;
  }

  .nav-pills .nav-link:hover {
    background-color: var(--glass-bg);
  }

  .nav-pills .nav-link.active {
    background-color: var(--glass-active);
    color: var(--accent);
    font-weight: 800;
    opacity: 1;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    border: 1px solid var(--border);
  }

  .chip-filter {
    padding: 6px 14px;
    border-radius: 20px;
    border: 1px solid var(--border);
    background: var(--tab-inactive-bg);
    color: var(--text-main);
    font-size: 0.8rem;
    font-weight: 600;
    white-space: nowrap;
    transition: all 0.2s;
    opacity: 0.8;
  }

  .chip-filter:hover {
    opacity: 1;
    transform: translateY(-1px);
  }

  .chip-filter.active {
    background: var(--accent);
    color: #fff;
    border-color: var(--accent);
    opacity: 1;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
  }

  .list-group-item {
    background-color: transparent !important;
    border: none;
    border-bottom: 1px solid var(--border);
    padding: 12px 16px;
    display: flex;
    align-items: center;
    color: var(--text-main);
    transition: background 0.1s;
  }

  .list-group-item:last-child {
    border-bottom: none;
  }

  .check-wrapper {
    width: 0;
    overflow: hidden;
    transition: width 0.2s ease;
    display: flex;
    align-items: center;
  }

  .mode-edit .check-wrapper {
    width: 36px;
    margin-right: 4px;
  }

  .custom-check {
    width: 20px;
    height: 20px;
    cursor: pointer;
    accent-color: #dc3545;
  }

  .tank-badge-mini {
    font-family: monospace;
    font-weight: 700;
    font-size: 0.8rem;
    background: var(--tab-inactive-bg);
    padding: 2px 6px;
    border-radius: 4px;
    color: var(--text-main);
    border: 1px solid var(--border);
  }

  .fade-in-right {
    animation: fadeInRight 0.3s ease;
  }

  @keyframes fadeInRight {
    from {
      opacity: 0;
      transform: translateX(10px);
    }

    to {
      opacity: 1;
      transform: translateX(0);
    }
  }

  .last-no-border:last-child {
    border-bottom: none !important;
  }
</style>

<script>
  var cache = { today: [], weekly: [], all: [] };
  var currentFilter = 'ALL';
  var currentTabId = 'summary';
  var selectedDate = 'ALL';
  var isEditMode = false;

  function loadMyPageData(passcode) {
    var pass = passcode || ((typeof window.GLOBAL_PASSCODE !== 'undefined') ? window.GLOBAL_PASSCODE : "");
    google.script.run
      .withSuccessHandler(renderMyPage)
      .withFailureHandler(e => alert("読み込みエラー: " + e.message))
      .getMyStats(pass);
  }

  function renderMyPage(data) {
    if (!data) return;

    document.getElementById('my-name').innerText = data.name;
    animateValue("my-money", 0, data.estimatedMoney, 1000);
    document.getElementById('my-score').innerText = data.currentScore.toLocaleString();

    if (data.nextRankScore > 0) {
      var diff = data.nextRankScore - data.currentScore;
      document.getElementById('score-diff').innerText = diff > 0 ? diff.toLocaleString() : 0;
      var percent = Math.min(100, (data.currentScore / data.nextRankScore) * 100);
      document.getElementById('rank-progress').style.width = percent + "%";
    } else {
      document.getElementById('score-diff').innerText = "MAX";
      document.getElementById('rank-progress').style.width = "100%";
    }

    // ※ 管理者バッジの処理は削除済み

    updateTheme(data.rank);
    cache.today = data.todayLog || [];
    cache.weekly = data.weeklyLog || [];
  }

  function updateTheme(rank) {
    var app = document.getElementById('app-container');
    var txt = document.getElementById('my-rank-text');
    var icon = document.getElementById('rank-icon');
    app.className = 'app-wrapper theme-default';
    var rankClass = 'rank-regular';
    var iconClass = 'bi-stars';
    if (rank === 'プラチナ') { rankClass = 'rank-platinum'; iconClass = 'bi-gem'; }
    else if (rank === 'ゴールド') { rankClass = 'rank-gold'; iconClass = 'bi-trophy-fill'; }
    else if (rank === 'シルバー') { rankClass = 'rank-silver'; iconClass = 'bi-award-fill'; }
    else if (rank === 'ブロンズ') { rankClass = 'rank-bronze'; iconClass = 'bi-shield-fill'; }
    app.classList.add(rankClass);
    txt.innerText = rank || 'REGULAR';
    icon.className = 'bi ' + iconClass;
  }

  function switchTab(tabId) {
    currentTabId = tabId;
  }



  function animateValue(id, start, end, duration) {
    var obj = document.getElementById(id);
    var range = end - start;
    var current = start;
    var increment = end > start ? Math.ceil(end / 20) : 0;
    var stepTime = Math.abs(Math.floor(duration / (range / increment))) || 10;
    var timer = setInterval(function () {
      current += increment;
      if (current >= end) { current = end; clearInterval(timer); }
      obj.innerHTML = current.toLocaleString();
    }, stepTime);
  }

  loadMyPageData(window.GLOBAL_PASSCODE);
</script>