<!-- Admin_Part_Staff.html -->
<h4 class="section-title">STAFF MANAGEMENT</h4>

<div class="admin-card p-0 overflow-hidden mt-3">
    <div class="p-3 border-bottom border-secondary d-flex justify-content-between align-items-center">
        <h6 class="mb-0 text-red" id="staff-target-month">当月分 スタッフ稼働ランキング</h6>
        <span class="badge bg-danger" id="staff-active-today">本日稼働: --名</span>
    </div>

    <table class="table table-dark-custom mb-0">
        <thead>
            <tr>
                <th style="width: 50px;">Rank</th>
                <th>名前</th>
                <th class="text-end">獲得報酬</th>
                <th class="text-center">今月の作業数</th>
                <th class="text-center">破損率</th>
                <th class="text-center">エラー率</th>
                <th>主なアクション</th>
                <th>本日の状態</th>
            </tr>
        </thead>
        <tbody id="staff-ranking-body">
            <tr>
                <td colspan="5" class="text-center py-4 text-muted">読み込み中...</td>
            </tr>
        </tbody>
    </table>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        loadDetailedStaff();
    });

    function loadDetailedStaff() {
        google.script.run
            .withSuccessHandler(function (data) {
                if (!data.success) {
                    document.getElementById('staff-ranking-body').innerHTML = '<tr><td colspan="5" class="text-center text-danger">取得エラー</td></tr>';
                    return;
                }

                document.getElementById('staff-target-month').innerText = data.targetMonth + " 稼働ランキング";
                document.getElementById('staff-active-today').innerText = "本日稼働: " + data.activeStaffCount + "名";

                var tbody = document.getElementById('staff-ranking-body');
                tbody.innerHTML = '';

                if (data.staffRankings.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">データがありません</td></tr>';
                    return;
                }

                data.staffRankings.forEach(function (staff, index) {
                    var tr = document.createElement('tr');

                    var rankHtml = (index < 3)
                        ? '<i class="bi bi-trophy-fill text-warning"></i> ' + (index + 1)
                        : (index + 1);

                    var statusHtml = staff.isActiveToday
                        ? '<span class="text-success"><i class="bi bi-circle-fill" style="font-size:8px;"></i> 稼働中</span>'
                        : '<span class="text-muted">退勤</span>';

                    var moneyHtml = '<span class="text-info fw-bold fs-6">¥' + (staff.earnedAmount || 0).toLocaleString() + '</span>';
                    var damageHtml = staff.damageCoef > 0 ? '<span class="badge bg-danger">' + staff.damageCoef + '%</span>' : '<span class="text-muted">0%</span>';
                    var errorHtml = staff.errorRatio > 0 ? '<span class="badge bg-warning text-dark">' + staff.errorRatio + '%</span>' : '<span class="text-muted">0%</span>';

                    // 主なアクションの文字列を生成 (上位3つくらいをカンマ区切り)
                    var actionsArr = [];
                    for (var k in staff.actionsBreakdown) {
                        actionsArr.push({ name: k, count: staff.actionsBreakdown[k] });
                    }
                    actionsArr.sort(function (a, b) { return b.count - a.count; });
                    var actionStr = actionsArr.slice(0, 3).map(function (obj) { return obj.name + ' (' + obj.count + ')'; }).join(', ');

                    tr.innerHTML = `
            <td class="text-center fw-bold">${rankHtml}</td>
            <td>${staff.name}</td>
            <td class="text-end">${moneyHtml}</td>
            <td class="text-center fs-5 fw-bold text-white">${staff.totalActions}</td>
            <td class="text-center">${damageHtml}</td>
            <td class="text-center">${errorHtml}</td>
            <td class="small text-muted">${actionStr}</td>
            <td>${statusHtml}</td>
          `;
                    tbody.appendChild(tr);
                });
            })
            .getAdminStaffData();
    }
</script>