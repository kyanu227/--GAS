<h4 class="section-title">金銭・ランク設定</h4>

<div class="row">
    <!-- 単価設定 -->
    <div class="col-12 mb-4">
        <div class="admin-card">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h6 class="text-success fw-bold m-0"><i class="bi bi-tag-fill me-2"></i>作業単価マスタ</h6>
                <div>
                    <button class="btn btn-sm btn-outline-light me-2" onclick="initMoneySettings()"><i
                            class="bi bi-arrow-clockwise"></i></button>
                    <button class="btn btn-sm btn-outline-success fw-bold" onclick="addMoneyPriceRow()"><i
                            class="bi bi-plus-lg"></i> 追加</button>
                </div>
            </div>
            <div class="table-responsive">
                <table class="table table-dark-custom align-middle small text-center" id="table-money-price">
                    <thead>
                        <tr>
                            <th style="min-width:120px;">アクション</th>
                            <th style="min-width:80px;">基本経費</th>
                            <th style="min-width:80px;">獲得スコア</th>
                            <!-- rank headers will be injected here -->
                            <th id="th-money-price-delete"></th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="9" class="py-4 text-muted">
                                <div class="spinner-border spinner-border-sm text-secondary me-2"></div>読み込み中...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ランク条件設定 -->
    <div class="col-12 mb-4">
        <div class="admin-card border-primary">
            <h6 class="text-primary fw-bold mb-3"><i class="bi bi-trophy-fill me-2"></i>ランク昇格条件 (必要スコア)</h6>
            <div class="table-responsive">
                <table class="table table-dark-custom align-middle small w-auto" id="table-money-rank">
                    <thead>
                        <tr>
                            <th class="text-center" style="min-width:120px;">ランク名</th>
                            <th class="text-center" style="min-width:150px;">必要スコア(以上)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="2" class="py-3 text-muted text-center">読み込み中...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <small class="text-muted">※スコアが高い順に判定されます。レギュラーの「0」は変更しないでください。</small>
        </div>
    </div>
</div>

<div class="mt-2 mb-5">
    <button class="btn btn-danger w-100 fw-bold py-3 fs-5" onclick="saveMoneySettings(this)">
        <i class="bi bi-save me-2"></i> 金銭・ランク設定を保存する
    </button>
</div>

<script>
    var globalRankHeaders = []; // To store headers for add/save

    function initMoneySettings() {
        var tbodyPrice = document.querySelector('#table-money-price tbody');
        var tbodyRank = document.querySelector('#table-money-rank tbody');
        if (tbodyPrice) tbodyPrice.innerHTML = '<tr><td colspan="15" class="text-center text-muted py-4"><span class="spinner-border text-secondary spinner-border-sm me-2"></span>Loading...</td></tr>';
        if (tbodyRank) tbodyRank.innerHTML = '<tr><td colspan="2" class="text-center text-muted py-3">Loading...</td></tr>';

        google.script.run
            .withSuccessHandler(function (data) {
                if (data && data.success === false) { alert("エラー:\n" + data.message); return; }
                if (data.prices && data.ranks) renderMoneySettings(data.prices, data.ranks, data.rankHeaders);
            })
            .withFailureHandler(function (error) { alert("データ読み込みエラー:\n" + error.message); })
            .getMoneySettingsData();
    }

    function renderMoneySettings(prices, ranks, rankHeaders) {
        var tbodyPrice = document.querySelector('#table-money-price tbody');
        var tbodyRank = document.querySelector('#table-money-rank tbody');
        if (!tbodyPrice || !tbodyRank) return;

        globalRankHeaders = rankHeaders || ['レギュラー', 'ブロンズ', 'シルバー', 'ゴールド', 'プラチナ'];

        // Inject THs dynamically into the table head
        var theadTr = document.querySelector('#table-money-price thead tr');
        var deleteTh = document.getElementById('th-money-price-delete');

        // Remove old dynamic THs
        document.querySelectorAll('.th-dynamic-rank').forEach(th => th.remove());

        // Insert new THs
        globalRankHeaders.forEach(rName => {
            var th = document.createElement('th');
            th.className = 'th-dynamic-rank';
            th.innerText = rName;
            theadTr.insertBefore(th, deleteTh);
        });

        tbodyPrice.innerHTML = '';
        tbodyRank.innerHTML = '';

        if (prices) prices.forEach(p => tbodyPrice.appendChild(createMoneyPriceRow(p)));
        if (prices && prices.length === 0) addMoneyPriceRow();

        if (ranks) {
            ranks.forEach(r => {
                var tr = document.createElement('tr');
                tr.innerHTML = `
        <td class="text-center fw-bold bg-dark text-light border-secondary align-middle"><input type="hidden" class="val-rank-name" value="${r.name}">${r.name}</td>
        <td class="align-middle bg-dark border-secondary"><input type="number" class="form-control form-control-sm bg-dark text-light border-secondary text-end val-rank-score" value="${r.minScore}" ${r.name === 'レギュラー' ? 'readonly' : ''}></td>
      `;
                tbodyRank.appendChild(tr);
            });
        }
    }

    function createMoneyPriceRow(item) {
        var tr = document.createElement('tr');

        var html = `
    <td class="bg-dark border-secondary align-middle"><input type="text" class="form-control form-control-sm bg-dark text-light border-secondary val-action fw-bold" value="${item.action || ''}"></td>
    <td class="bg-dark border-secondary align-middle"><input type="number" class="form-control form-control-sm bg-dark text-light border-secondary text-end val-base" value="${item.base || 0}"></td>
    <td class="bg-dark border-secondary align-middle"><input type="number" class="form-control form-control-sm bg-dark text-success border-success text-end val-score fw-bold" value="${item.score || 0}"></td>`;

        globalRankHeaders.forEach(rName => {
            var val = (item.rankAdd && item.rankAdd[rName] !== undefined) ? item.rankAdd[rName] : 0;
            html += `<td class="bg-dark border-secondary align-middle"><input type="number" data-rank="${rName}" class="form-control form-control-sm bg-dark text-light border-secondary text-end val-rank-bonus" value="${val}"></td>`;
        });

        html += `<td class="bg-dark border-secondary text-center align-middle"><button class="btn btn-sm btn-link text-danger p-0 m-0" onclick="this.closest('tr').remove()"><i class="bi bi-x-circle fs-5"></i></button></td>`;

        tr.innerHTML = html;
        return tr;
    }

    function addMoneyPriceRow() {
        var emptyRankAdd = {};
        globalRankHeaders.forEach(r => emptyRankAdd[r] = 0);
        document.querySelector('#table-money-price tbody').appendChild(createMoneyPriceRow({ action: '', base: 0, score: 0, rankAdd: emptyRankAdd }));
    }

    function saveMoneySettings(btn) {
        var prices = [];
        document.querySelectorAll('#table-money-price tbody tr').forEach(tr => {
            var act = tr.querySelector('.val-action').value.trim();
            if (act) {
                var rankAdd = {};
                tr.querySelectorAll('.val-rank-bonus').forEach(input => {
                    rankAdd[input.getAttribute('data-rank')] = Number(input.value);
                });

                prices.push({
                    action: act,
                    base: Number(tr.querySelector('.val-base').value),
                    score: Number(tr.querySelector('.val-score').value),
                    rankAdd: rankAdd
                });
            }
        });

        var ranks = [];
        document.querySelectorAll('#table-money-rank tbody tr').forEach(tr => {
            ranks.push({
                name: tr.querySelector('.val-rank-name').value,
                minScore: Number(tr.querySelector('.val-rank-score').value)
            });
        });

        if (confirm("金銭設定とランク条件を更新しますか？\n（この設定は即座にシステムに反映されます）")) {

            var originalText = btn.innerHTML;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>保存中...';
            btn.disabled = true;

            google.script.run
                .withSuccessHandler(res => {
                    alert(res.message);
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                    if (res.success) initMoneySettings();
                })
                .withFailureHandler(err => {
                    alert("保存エラー: " + err.message);
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                })
                .updateMoneySettings({ prices: prices, ranks: ranks });
        }
    }
</script>