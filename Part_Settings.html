<div class="container-fluid mt-3 mb-5" style="max-width: 900px;">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h5 class="fw-bold text-secondary"><i class="bi bi-gear-fill me-2"></i> è¨­å®šå¤‰æ›´ </h5>
    <div class="d-flex align-items-center">
      <span id="current-role-badge" class="badge bg-secondary me-2">èª­è¾¼ä¸­...</span>
      <button class="btn btn-sm btn-outline-secondary" onclick="initSettings()">
        <i class="bi bi-arrow-clockwise"></i> å†èª­è¾¼
      </button>
    </div>
  </div>

  <ul class="nav nav-tabs mb-3" id="settingsTab" role="tablist">
    <li class="nav-item" role="presentation"><button class="nav-link active fw-bold" id="tab-staff-btn"
        data-bs-toggle="tab" data-bs-target="#tab-staff" type="button" role="tab"><i class="bi bi-people me-1"></i>
        æ‹…å½“è€…</button></li>
    <li class="nav-item" role="presentation"><button class="nav-link fw-bold" id="tab-dest-btn" data-bs-toggle="tab"
        data-bs-target="#tab-dest" type="button" role="tab"><i class="bi bi-building me-1"></i> è²¸å‡ºå…ˆ</button></li>
    <li class="nav-item" role="presentation"><button class="nav-link fw-bold" id="tab-order-btn" data-bs-toggle="tab"
        data-bs-target="#tab-order" type="button" role="tab"><i class="bi bi-box-seam me-1"></i> ç™ºæ³¨å“ç›®</button></li>
    <li class="nav-item" role="presentation"><button class="nav-link fw-bold text-danger" id="tab-notify-btn"
        data-bs-toggle="tab" data-bs-target="#tab-notify" type="button" role="tab"><i class="bi bi-bell-fill me-1"></i>
        é€šçŸ¥ãƒ»ã‚·ã‚¹ãƒ†ãƒ </button></li>
    <li class="nav-item" role="presentation" id="tab-login-li" style="display:none;"><button
        class="nav-link fw-bold text-dark" id="tab-login-btn" data-bs-toggle="tab" data-bs-target="#tab-login"
        type="button" role="tab"><i class="bi bi-shield-lock-fill me-1"></i> ãƒ­ã‚°ã‚¤ãƒ³è¨­å®š</button></li>
  </ul>

  <div class="tab-content bg-white p-3 border border-top-0 rounded-bottom shadow-sm" id="settingsTabContent">

    <div class="tab-pane fade show active" id="tab-staff" role="tabpanel">
      <div class="d-flex justify-content-between mb-2">
        <small class="text-muted align-self-end">â€»ã€Œåœæ­¢ã€ã«ã™ã‚‹ã¨ãƒ­ã‚°ã‚¤ãƒ³ä¸å¯ã«ãªã‚Šã¾ã™ã€‚</small>
        <button class="btn btn-sm btn-success fw-bold" onclick="addStaffRow()"><i class="bi bi-plus-lg"></i> è¿½åŠ 
        </button>
      </div>
      <div class="table-responsive mb-3">
        <table class="table table-bordered table-hover align-middle" id="table-staff">
          <thead class="bg-light text-center small text-muted">
            <tr>
              <th>åå‰</th>
              <th style="min-width:200px;">Email</th>
              <th class="col-passcode" style="display:none;">ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰</th>
              <th>æ¨©é™</th>
              <th>ãƒ©ãƒ³ã‚¯</th>
              <th>çŠ¶æ…‹</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <button class="btn btn-primary w-100 fw-bold" onclick="saveStaff()"><i class="bi bi-save"></i> æ‹…å½“è€…ãƒªã‚¹ãƒˆã‚’ä¿å­˜ </button>
    </div>

    <div class="tab-pane fade" id="tab-dest" role="tabpanel">
      <div class="d-flex justify-content-between mb-2">
        <small class="text-muted align-self-end">â€»ã€Œåœæ­¢ã€ã«ã™ã‚‹ã¨é¸æŠè‚¢ã‹ã‚‰æ¶ˆãˆã¾ã™ã€‚</small>
        <button class="btn btn-sm btn-success fw-bold" onclick="addDestRow()"><i class="bi bi-plus-lg"></i> è¿½åŠ  </button>
      </div>
      <div class="table-responsive mb-3">
        <table class="table table-bordered table-hover align-middle" id="table-dest">
          <thead class="bg-light text-center small text-muted">
            <tr>
              <th>è¡¨ç¤ºå</th>
              <th>æ­£å¼åç§°</th>
              <th>10Lå˜ä¾¡</th>
              <th>12Lå˜ä¾¡</th>
              <th>çŠ¶æ…‹</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <button class="btn btn-primary w-100 fw-bold" onclick="saveDest()"><i class="bi bi-save"></i> è²¸å‡ºå…ˆãƒªã‚¹ãƒˆã‚’ä¿å­˜ </button>
    </div>

    <div class="tab-pane fade" id="tab-order" role="tabpanel">
      <div class="alert alert-light border small text-muted mb-3">
        <strong><i class="bi bi-info-circle"></i> ãƒ’ãƒ³ãƒˆ</strong><br>ã‚¿ãƒ³ã‚¯: Aåˆ—=ç¨®é¡, Båˆ—=å®¹é‡ã€‚<br>å‚™å“: Aåˆ—=è¡¨ç¤ºé †, Båˆ—=å“åã€‚
      </div>
      <div class="table-responsive mb-3">
        <table class="table table-bordered table-hover align-middle" id="table-order">
          <thead class="bg-light text-center small text-muted">
            <tr>
              <th>ç¨®é¡ / é †</th>
              <th>å®¹é‡ / å“å</th>
              <th>å˜ä¾¡</th>
              <th></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="d-flex justify-content-between mb-4">
        <div>
          <button class="btn btn-sm btn-outline-primary fw-bold me-2" onclick="addOrderRow('tank')"><i
              class="bi bi-plus-lg"></i> ã‚¿ãƒ³ã‚¯è¿½åŠ </button>
          <button class="btn btn-sm btn-outline-success fw-bold" onclick="addOrderRow('supply')"><i
              class="bi bi-plus-lg"></i> å‚™å“è¿½åŠ </button>
        </div>
      </div>
      <button class="btn btn-primary w-100 fw-bold" onclick="saveOrder()"><i class="bi bi-save"></i> ç™ºæ³¨ãƒã‚¹ã‚¿ã‚’ä¿å­˜ </button>
    </div>

    <div class="tab-pane fade" id="tab-notify" role="tabpanel">

      <div id="admin-line-settings-area" style="display:none;" class="mb-4 pb-3 border-bottom">
        <h6 class="fw-bold text-success"><i class="bi bi-line me-2"></i>LINEé€šçŸ¥è¨­å®š (Messaging API)</h6>
        <div class="small text-muted mb-2">
          LINEã‚°ãƒ«ãƒ¼ãƒ—ã”ã¨ã«ã€Œã©ã®é€šçŸ¥ã‚’å—ã‘å–ã‚‹ã‹ã€ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚<br>
          â€»è¤‡æ•°ã®é …ç›®ã«ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
        </div>

        <div id="line-config-container"></div>

        <button class="btn btn-sm btn-outline-success" onclick="addLineConfigRow()"><i class="bi bi-plus-lg"></i> é€ä¿¡å…ˆã‚’è¿½åŠ 
        </button>
      </div>

      <div class="mb-4 pb-3 border-bottom">
        <h6 class="fw-bold text-primary"><i class="bi bi-envelope me-2"></i>é€šçŸ¥å…ˆãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</h6>
        <div class="mb-2" id="email-list-container"></div>
        <button class="btn btn-sm btn-outline-secondary" onclick="addEmailRow('')"><i class="bi bi-plus"></i> è¿½åŠ 
        </button>
      </div>

      <div class="mb-3">
        <h6 class="fw-bold text-secondary"><i class="bi bi-clock-history me-2"></i>æœŸé™ãƒ»æœ‰åŠ¹æœŸé–“è¨­å®š</h6>
        <div class="row g-3 align-items-center mb-2">
          <div class="col-auto"><label class="col-form-label small">ã‚¢ãƒ©ãƒ¼ãƒˆè¡¨ç¤ºé–‹å§‹:</label></div>
          <div class="col-auto">
            <div class="input-group input-group-sm">
              <span class="input-group-text">æœŸé™ã®</span>
              <input type="number" id="conf-alert-months" class="form-control text-center fw-bold" value="6"
                style="width:60px;">
              <span class="input-group-text">ãƒ¶æœˆå‰ã‹ã‚‰</span>
            </div>
          </div>
        </div>
        <div class="row g-3 align-items-center">
          <div class="col-auto"><label class="col-form-label small">è€åœ§æ¤œæŸ»æœ‰åŠ¹æœŸé–“:</label></div>
          <div class="col-auto">
            <div class="input-group input-group-sm">
              <span class="input-group-text">å®Œäº†ç™»éŒ²ã‹ã‚‰</span>
              <input type="number" id="conf-validity-years" class="form-control text-center fw-bold" value="3"
                style="width:60px;">
              <span class="input-group-text">å¹´å¾Œã¾ã§</span>
            </div>
          </div>
        </div>
      </div>

      <button class="btn btn-danger w-100 fw-bold" onclick="saveNotify()"><i class="bi bi-cloud-upload"></i> ã‚·ã‚¹ãƒ†ãƒ è¨­å®šã‚’ä¿å­˜
      </button>
    </div>

    <div class="tab-pane fade" id="tab-login" role="tabpanel">
      <div class="card shadow-sm mb-4">
        <div class="card-header bg-dark text-white fw-bold"><i class="bi bi-shield-lock me-2"></i>ãƒ­ã‚°ã‚¤ãƒ³èªè¨¼ãƒ¢ãƒ¼ãƒ‰è¨­å®š</div>
        <div class="card-body">
          <div class="d-grid gap-2 mb-3">
            <div class="btn-group" role="group">
              <input type="radio" class="btn-check" name="loginMode" id="modeGoogle" value="GOOGLE" autocomplete="off">
              <label class="btn btn-outline-primary fw-bold py-3" for="modeGoogle"><i class="bi bi-google me-1"></i>
                Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆå„ªå…ˆ</label>
              <input type="radio" class="btn-check" name="loginMode" id="modePasscode" value="PASSCODE"
                autocomplete="off">
              <label class="btn btn-outline-danger fw-bold py-3" for="modePasscode"><i class="bi bi-key-fill me-1"></i>
                ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰å¿…é ˆ</label>
            </div>
          </div>
          <div class="text-end"><button class="btn btn-dark" onclick="saveLoginSettings()"><i
                class="bi bi-save me-1"></i> è¨­å®šã‚’ä¿å­˜</button></div>
        </div>
      </div>
    </div>

  </div>
  <div style="height:100px;"></div>
</div>

<script>
  // --- ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° ---
  var GLOBAL_USER_ROLE = "";
  var USER_PASSCODE = "";

  // --- ãƒ˜ãƒ«ãƒ‘ãƒ¼ ---
  function getCurrentUserPasscode() {
    if (USER_PASSCODE) return USER_PASSCODE;
    var stored = localStorage.getItem('app_user_passcode');
    if (stored) { USER_PASSCODE = stored; return stored; }
    return "";
  }

  // --- åˆæœŸåŒ– ---
  function initSettings() {
    document.querySelector('#table-staff tbody').innerHTML = '<tr><td colspan="6" class="text-center py-4"><span class="spinner-border text-primary"></span></td></tr>';
    var pass = getCurrentUserPasscode();
    google.script.run
      .withSuccessHandler(renderSettings)
      .withFailureHandler(function (error) { alert("åˆæœŸãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:\n" + error.message); })
      .getSettingsInitData(pass);
  }

  function renderSettings(data) {
    if (data && data.success === false) { alert("ã‚¨ãƒ©ãƒ¼:\n" + data.message); return; }
    if (data.currentUser) { GLOBAL_USER_ROLE = data.currentUser.role; updateRoleBadge(data.currentUser); }
    updateStaffTableHeader();
    if (data.staff) renderStaffTable(data.staff);
    if (data.dest) renderDestTable(data.dest);
    if (data.orderMaster) renderOrderTable(data.orderMaster);
    if (data.notify) renderNotifySettings(data.notify);

    var isFullAdmin = checkIsFullAdmin();
    if (isFullAdmin) {
      document.getElementById('tab-login-li').style.display = 'block';
      if (data.loginMode) {
        if (data.loginMode === 'PASSCODE') document.getElementById('modePasscode').checked = true;
        else document.getElementById('modeGoogle').checked = true;
      }
    }
  }

  function updateRoleBadge(user) {
    var container = document.querySelector('.d-flex.align-items-center.mb-3 .d-flex');
    var oldBadge = document.getElementById('current-role-badge');
    if (oldBadge) oldBadge.remove();
    var badge = document.createElement('span');
    badge.id = 'current-role-badge';
    badge.className = "badge me-2";
    var roleText = user.role || "ä¸€èˆ¬";
    var methodText = (user.authMethod === 'PASSCODE') ? 'ğŸ”‘' : 'ğŸ“§';
    badge.innerText = methodText + " " + user.name + " (" + roleText + ")";
    if (roleText.indexOf("ç®¡ç†è€…") !== -1 && roleText.indexOf("æº–") === -1) badge.classList.add("bg-danger");
    else if (roleText.indexOf("æº–ç®¡ç†è€…") !== -1) badge.classList.add("bg-warning", "text-dark");
    else badge.classList.add("bg-secondary");
    if (container) container.insertBefore(badge, container.firstChild);
  }

  function checkIsFullAdmin() {
    var role = GLOBAL_USER_ROLE || "";
    return (role.indexOf('ç®¡ç†è€…') !== -1 && role.indexOf('æº–') === -1) || role.toLowerCase().indexOf('admin') !== -1;
  }
  function checkIsSemiAdmin() { return (GLOBAL_USER_ROLE || "").indexOf('æº–ç®¡ç†è€…') !== -1; }

  // --- Staff Table Functions ---
  function updateStaffTableHeader() {
    var displayStyle = (checkIsFullAdmin() || checkIsSemiAdmin()) ? 'table-cell' : 'none';
    document.querySelectorAll('.col-passcode').forEach(th => th.style.display = displayStyle);
  }
  function renderStaffTable(list) {
    var tbody = document.querySelector('#table-staff tbody'); tbody.innerHTML = '';
    list.forEach(function (item) { tbody.appendChild(createStaffRow(item)); });
  }
  function createStaffRow(item) {
    var tr = document.createElement('tr');
    var isFull = checkIsFullAdmin();
    var isSemi = checkIsSemiAdmin();
    var isStopped = (item.status === 'åœæ­¢');
    if (isStopped) tr.classList.add('table-secondary', 'text-muted');

    var btnHtml = isStopped
      ? '<button class="btn btn-sm btn-outline-primary p-1" onclick="toggleRowStatus(this, \'ç¨¼åƒ\')"><i class="bi bi-arrow-counterclockwise"></i></button>'
      : '<button class="btn btn-sm btn-link text-danger p-0" onclick="toggleRowStatus(this, \'åœæ­¢\')"><i class="bi bi-x-circle-fill fs-5"></i></button>';

    var passVal = item.passcode || '';
    var passInputHtml = '';
    var targetIsAdmin = (item.role && item.role.indexOf('ç®¡ç†è€…') !== -1 && item.role.indexOf('æº–') === -1);

    if (isFull) {
      passInputHtml = `<div class="input-group input-group-sm"><input type="text" class="form-control val-passcode text-center font-monospace" value="${passVal}" placeholder="Pass" maxlength="6" ${isStopped ? 'disabled' : ''}><button class="btn btn-outline-primary" type="button" tabindex="-1" onclick="toggleVisibility(this, 'val-passcode')"><i class="bi bi-eye"></i></button></div>`;
    } else if (isSemi) {
      if (targetIsAdmin) passInputHtml = `<input type="text" class="form-control form-control-sm text-center text-muted" placeholder="é–²è¦§ä¸å¯" disabled>`;
      else passInputHtml = `<div class="input-group input-group-sm"><input type="password" class="form-control val-passcode text-center font-monospace" value="${passVal}" placeholder="Pass" maxlength="6" ${isStopped ? 'disabled' : ''}><button class="btn btn-outline-secondary" type="button" tabindex="-1" onclick="toggleVisibility(this, 'val-passcode')"><i class="bi bi-eye-slash"></i></button></div>`;
    } else {
      passInputHtml = `<input type="hidden" class="val-passcode" value="${passVal}">`;
    }

    var adminStyle = isFull ? '' : 'visibility: hidden;';
    var passDisplay = (isFull || isSemi) ? 'table-cell' : 'none';

    tr.innerHTML = `
    <td><input type="text" class="form-control form-control-sm val-name fw-bold" value="${item.name || ''}" ${isStopped ? 'disabled' : ''}></td>
    <td><input type="email" class="form-control form-control-sm val-email font-monospace" value="${item.email || ''}" ${isStopped ? 'disabled' : ''}></td>
    <td class="col-passcode" style="display:${passDisplay};">${passInputHtml}</td>
    <td><div style="${adminStyle}"><select class="form-select form-select-sm val-role" ${isStopped ? 'disabled' : ''}><option value="ä¸€èˆ¬" ${item.role === 'ä¸€èˆ¬' ? 'selected' : ''}>ä¸€èˆ¬</option><option value="æº–ç®¡ç†è€…" ${item.role === 'æº–ç®¡ç†è€…' ? 'selected' : ''}>æº–ç®¡ç†è€…</option><option value="ç®¡ç†è€…" ${item.role === 'ç®¡ç†è€…' ? 'selected' : ''}>ç®¡ç†è€…</option></select></div></td>
    <td><div style="${adminStyle}"><select class="form-select form-select-sm val-rank" ${isStopped ? 'disabled' : ''}><option value="ãƒ¬ã‚®ãƒ¥ãƒ©ãƒ¼" ${item.rank === 'ãƒ¬ã‚®ãƒ¥ãƒ©ãƒ¼' ? 'selected' : ''}>ãƒ¬ã‚®ãƒ¥ãƒ©ãƒ¼</option><option value="ãƒ–ãƒ­ãƒ³ã‚º" ${item.rank === 'ãƒ–ãƒ­ãƒ³ã‚º' ? 'selected' : ''}>ãƒ–ãƒ­ãƒ³ã‚º</option><option value="ã‚·ãƒ«ãƒãƒ¼" ${item.rank === 'ã‚·ãƒ«ãƒãƒ¼' ? 'selected' : ''}>ã‚·ãƒ«ãƒãƒ¼</option><option value="ã‚´ãƒ¼ãƒ«ãƒ‰" ${item.rank === 'ã‚´ãƒ¼ãƒ«ãƒ‰' ? 'selected' : ''}>ã‚´ãƒ¼ãƒ«ãƒ‰</option><option value="ãƒ—ãƒ©ãƒãƒŠ" ${item.rank === 'ãƒ—ãƒ©ãƒãƒŠ' ? 'selected' : ''}>ãƒ—ãƒ©ãƒãƒŠ</option></select></div></td>
    <td class="text-center align-middle"><input type="hidden" class="val-status" value="${item.status || 'ç¨¼åƒ'}">${btnHtml}</td>
  `;
    return tr;
  }
  function toggleVisibility(btn, targetClass) {
    var input = btn.closest('tr').querySelector('.' + targetClass);
    var icon = btn.querySelector('i');
    if (input.type === 'password') { input.type = 'text'; icon.className = 'bi bi-eye'; btn.classList.replace('btn-outline-secondary', 'btn-outline-primary'); }
    else { input.type = 'password'; icon.className = 'bi bi-eye-slash'; btn.classList.replace('btn-outline-primary', 'btn-outline-secondary'); }
  }
  function addStaffRow() { document.querySelector('#table-staff tbody').appendChild(createStaffRow({ name: '', email: '', passcode: '', role: 'ä¸€èˆ¬', rank: 'ãƒ¬ã‚®ãƒ¥ãƒ©ãƒ¼', status: 'ç¨¼åƒ' })); }
  function saveStaff() {
    var list = [];
    document.querySelectorAll('#table-staff tbody tr').forEach(function (tr) {
      var name = tr.querySelector('.val-name').value.trim();
      if (name) list.push({ name: name, email: tr.querySelector('.val-email').value.trim(), passcode: tr.querySelector('.val-passcode') ? tr.querySelector('.val-passcode').value.trim() : "", role: tr.querySelector('.val-role').value, rank: tr.querySelector('.val-rank').value, status: tr.querySelector('.val-status').value });
    });
    if (confirm("æ›´æ–°ã—ã¾ã™ã‹ï¼Ÿ")) google.script.run.withSuccessHandler(function (res) { alert(res.message); initSettings(); }).updateStaffMaster({ list: list, userPasscode: getCurrentUserPasscode() });
  }
  function toggleRowStatus(btn, newStatus) {
    var tr = btn.closest('tr');
    var inputs = tr.querySelectorAll('input:not([type=hidden]), select, button:not([onclick*="toggleRowStatus"])');
    tr.querySelector('.val-status').value = newStatus;
    var isStopped = (newStatus === 'åœæ­¢');
    if (isStopped) { tr.classList.add('table-secondary', 'text-muted'); inputs.forEach(el => el.disabled = true); btn.className = "btn btn-sm btn-outline-primary p-1"; btn.innerHTML = '<i class="bi bi-arrow-counterclockwise"></i>'; btn.setAttribute('onclick', "toggleRowStatus(this, 'ç¨¼åƒ')"); }
    else { tr.classList.remove('table-secondary', 'text-muted'); inputs.forEach(el => { if (!checkIsFullAdmin() && (el.classList.contains('val-role') || el.classList.contains('val-rank'))) return; el.disabled = false; }); btn.className = "btn btn-sm btn-link text-danger p-0"; btn.innerHTML = '<i class="bi bi-x-circle-fill fs-5"></i>'; btn.setAttribute('onclick', "toggleRowStatus(this, 'åœæ­¢')"); }
  }

  // --- Dest & Order Functions ---
  function renderDestTable(list) { var tbody = document.querySelector('#table-dest tbody'); tbody.innerHTML = ''; list.forEach(item => tbody.appendChild(createDestRow(item))); }
  function createDestRow(item) {
    var tr = document.createElement('tr');
    var isStopped = (item.status === 'åœæ­¢');
    if (isStopped) tr.classList.add('table-secondary', 'text-muted');
    tr.innerHTML = `<td><input type="text" class="form-control form-control-sm val-name fw-bold" value="${item.name || ''}" ${isStopped ? 'disabled' : ''}></td><td><input type="text" class="form-control form-control-sm val-formal" value="${item.formalName || ''}" ${isStopped ? 'disabled' : ''}></td><td><input type="number" class="form-control form-control-sm val-price10 text-end" value="${item.price10 || 0}" ${isStopped ? 'disabled' : ''}></td><td><input type="number" class="form-control form-control-sm val-price12 text-end" value="${item.price12 || 0}" ${isStopped ? 'disabled' : ''}></td><td class="text-center align-middle"><input type="hidden" class="val-status" value="${item.status || 'ç¨¼åƒ'}">${isStopped ? '<button class="btn btn-sm btn-outline-primary p-1" onclick="toggleRowStatus(this,\'ç¨¼åƒ\')"><i class="bi bi-arrow-counterclockwise"></i></button>' : '<button class="btn btn-sm btn-link text-danger p-0" onclick="toggleRowStatus(this,\'åœæ­¢\')"><i class="bi bi-x-circle-fill fs-5"></i></button>'}</td>`;
    return tr;
  }
  function addDestRow() { document.querySelector('#table-dest tbody').appendChild(createDestRow({ name: '', formalName: '', price10: 0, price12: 0, status: 'ç¨¼åƒ' })); }
  function saveDest() { var list = []; document.querySelectorAll('#table-dest tbody tr').forEach(tr => { if (tr.querySelector('.val-name').value.trim()) list.push({ name: tr.querySelector('.val-name').value.trim(), formalName: tr.querySelector('.val-formal').value.trim(), price10: tr.querySelector('.val-price10').value, price12: tr.querySelector('.val-price12').value, status: tr.querySelector('.val-status').value }); }); if (confirm("æ›´æ–°ã—ã¾ã™ã‹ï¼Ÿ")) google.script.run.withSuccessHandler(res => alert(res.message)).updateDestMaster({ list: list }); }

  function renderOrderTable(list) {
    var tbody = document.querySelector('#table-order tbody'); tbody.innerHTML = '';
    var tanks = list.filter(i => isNaN(i.colA));
    var supplies = list.filter(i => !isNaN(i.colA));
    supplies.sort((a, b) => Number(a.colA) - Number(b.colA));
    if (tanks.length > 0) { tbody.insertAdjacentHTML('beforeend', '<tr class="table-info"><td colspan="4" class="small fw-bold text-primary">ã‚¿ãƒ³ã‚¯</td></tr>'); tanks.forEach(i => tbody.appendChild(createOrderRow(i, 'tank'))); }
    tbody.insertAdjacentHTML('beforeend', '<tr class="table-secondary"><td colspan="4" class="small fw-bold text-dark">å‚™å“</td></tr>');
    if (supplies.length === 0 && tanks.length === 0) addOrderRow('supply'); else supplies.forEach(i => tbody.appendChild(createOrderRow(i, 'supply')));
  }
  function createOrderRow(item, type) {
    var tr = document.createElement('tr'); tr.setAttribute('data-type', type);
    tr.innerHTML = `<td><input type="text" class="form-control form-control-sm val-cola text-center" value="${item.colA || ''}"></td><td><input type="text" class="form-control form-control-sm val-colb fw-bold" value="${item.colB || ''}"></td><td><input type="number" class="form-control form-control-sm val-price text-end" value="${item.price || 0}"></td><td class="text-center"><button class="btn btn-sm btn-link text-danger p-0" onclick="this.closest('tr').remove()"><i class="bi bi-x-circle-fill fs-5"></i></button></td>`;
    return tr;
  }
  function addOrderRow(type) { var tbody = document.querySelector('#table-order tbody'); var r = createOrderRow({ colA: '', colB: '', price: 0 }, type); if (type === 'tank') { var h = tbody.querySelector('.table-info'); if (h) h.after(r); else tbody.prepend(r); } else tbody.appendChild(r); }
  function saveOrder() { var list = []; document.querySelectorAll('#table-order tbody tr').forEach(tr => { if (!tr.classList.contains('table-info') && !tr.classList.contains('table-secondary') && tr.querySelector('.val-colb').value.trim()) list.push({ colA: tr.querySelector('.val-cola').value.trim(), colB: tr.querySelector('.val-colb').value.trim(), price: tr.querySelector('.val-price').value }); }); if (confirm("æ›´æ–°ã—ã¾ã™ã‹ï¼Ÿ")) google.script.run.withSuccessHandler(res => alert(res.message)).updateOrderMaster({ list: list }); }

  // --- Notify (Multiple Checkboxes Support) ---
  function renderNotifySettings(conf) {
    if (!conf) return;
    document.getElementById('conf-alert-months').value = conf.alertMonths;
    document.getElementById('conf-validity-years').value = conf.validityYears;

    var lineContainer = document.getElementById('line-config-container');
    lineContainer.innerHTML = '';

    if (checkIsFullAdmin()) {
      document.getElementById('admin-line-settings-area').style.display = 'block';
      if (conf.lineConfigs && Array.isArray(conf.lineConfigs) && conf.lineConfigs.length > 0) {
        conf.lineConfigs.forEach(item => addLineConfigRow(item));
      } else {
        // æ—§äº’æ›(string target)ãŒã‚ã‚Œã°é…åˆ—ã«ç›´ã—ã¦è¡¨ç¤º
        if (conf.lineToken) {
          var t = conf.target || 'ALL';
          // ä»¥å‰ã®targetãŒæ–‡å­—åˆ—ã ã£ãŸå ´åˆã‚‚ã€UIä¸Šã¯é…åˆ—ã¨ã—ã¦æ‰±ã†
          var targets = (t === 'ALL') ? ['INSPECTION', 'DAILY', 'SALES', 'STAFF'] : [t];
          addLineConfigRow({ name: 'Default', token: conf.lineToken, groupId: conf.lineGroupId, targets: targets });
        } else {
          addLineConfigRow();
        }
      }
    } else {
      document.getElementById('admin-line-settings-area').style.display = 'none';
    }

    var eContainer = document.getElementById('email-list-container');
    eContainer.innerHTML = '';
    if (conf.emails) conf.emails.forEach(e => addEmailRow(e));
  }

  // â˜…ä¿®æ­£: ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹æ–¹å¼ã®LINEè¡Œè¿½åŠ 
  function addLineConfigRow(data) {
    var item = data || { name: '', token: '', groupId: '', targets: [] };
    // targetsãŒæœªå®šç¾©ã¾ãŸã¯æ–‡å­—åˆ—ãªã‚‰é…åˆ—åŒ–
    var currentTargets = Array.isArray(item.targets) ? item.targets : (item.target ? [item.target] : []);
    if (item.target === 'ALL') currentTargets = ['INSPECTION', 'DAILY', 'SALES', 'STAFF'];

    var div = document.createElement('div');
    div.className = "card p-3 mb-3 bg-light border";

    // ãƒã‚§ãƒƒã‚¯çŠ¶æ…‹ã®åˆ¤å®š
    const isChecked = (val) => currentTargets.includes(val) ? 'checked' : '';

    div.innerHTML = `
    <div class="d-flex justify-content-between mb-2 align-items-center">
      <input type="text" class="form-control form-control-sm val-line-name fw-bold" placeholder="åç§° (ä¾‹: æ•´å‚™ç­)" value="${item.name || ''}" style="max-width:200px;">
      <button class="btn btn-sm btn-outline-danger" onclick="this.closest('.card').remove()"><i class="bi bi-trash"></i> å‰Šé™¤</button>
    </div>
    <div class="mb-2">
      <textarea class="form-control form-control-sm font-monospace val-line-token" rows="2" placeholder="ãƒãƒ£ãƒãƒ«ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ (å¿…é ˆ)">${item.token || ''}</textarea>
    </div>
    <div class="input-group input-group-sm mb-2">
      <span class="input-group-text">GroupID</span>
      <input type="text" class="form-control font-monospace val-line-group" placeholder="C... (ä»»æ„)" value="${item.groupId || ''}">
    </div>
    <div class="border-top pt-2">
      <div class="small fw-bold text-muted mb-1">é€šçŸ¥å¯¾è±¡ã‚’é¸æŠ:</div>
      <div class="d-flex flex-wrap gap-3">
        <div class="form-check">
          <input class="form-check-input val-check-target" type="checkbox" value="INSPECTION" id="chk-insp-${Date.now()}" ${isChecked('INSPECTION')}>
          <label class="form-check-label small" for="chk-insp-${Date.now()}">è€åœ§æ¤œæŸ»</label>
        </div>
        <div class="form-check">
          <input class="form-check-input val-check-target" type="checkbox" value="DAILY" id="chk-daily-${Date.now()}" ${isChecked('DAILY')}>
          <label class="form-check-label small" for="chk-daily-${Date.now()}">æ—¥å ±</label>
        </div>
        <div class="form-check">
          <input class="form-check-input val-check-target" type="checkbox" value="SALES" id="chk-sales-${Date.now()}" ${isChecked('SALES')}>
          <label class="form-check-label small" for="chk-sales-${Date.now()}">å£²ä¸Š</label>
        </div>
        <div class="form-check">
          <input class="form-check-input val-check-target" type="checkbox" value="STAFF" id="chk-staff-${Date.now()}" ${isChecked('STAFF')}>
          <label class="form-check-label small" for="chk-staff-${Date.now()}">ã‚¹ã‚¿ãƒƒãƒ•</label>
        </div>
      </div>
    </div>
  `;
    document.getElementById('line-config-container').appendChild(div);
  }

  function addEmailRow(val) { var d = document.createElement('div'); d.className = 'input-group mb-2'; d.innerHTML = `<input type="email" class="form-control val-email" value="${val}" placeholder="user@example.com"><button class="btn btn-outline-danger" onclick="this.parentElement.remove()"><i class="bi bi-x"></i></button>`; document.getElementById('email-list-container').appendChild(d); }

  function saveNotify() {
    var alertMonths = parseInt(document.getElementById('conf-alert-months').value) || 6;
    var validityYears = parseInt(document.getElementById('conf-validity-years').value) || 3;
    var emails = [];
    document.querySelectorAll('#email-list-container .val-email').forEach(el => { if (el.value.trim()) emails.push(el.value.trim()); });

    var lineConfigs = [];
    if (checkIsFullAdmin()) {
      document.querySelectorAll('#line-config-container .card').forEach(card => {
        var name = card.querySelector('.val-line-name').value.trim();
        var token = card.querySelector('.val-line-token').value.trim();
        var groupId = card.querySelector('.val-line-group').value.trim();

        // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®å€¤ã‚’é…åˆ—ã¨ã—ã¦åé›†
        var targets = [];
        card.querySelectorAll('.val-check-target:checked').forEach(chk => {
          targets.push(chk.value);
        });

        if (token) {
          lineConfigs.push({ name: name, token: token, groupId: groupId, targets: targets });
        }
      });
    }

    if (confirm("æ›´æ–°ã—ã¾ã™ã‹ï¼Ÿ")) google.script.run.withSuccessHandler(res => alert(res.message)).updateNotifySettings({ alertMonths: alertMonths, validityYears: validityYears, emails: emails, lineConfigs: lineConfigs });
  }

  // --- Login ---
  function saveLoginSettings() {
    var sel = document.querySelector('input[name="loginMode"]:checked');
    if (!sel) return;
    if (confirm("ãƒ­ã‚°ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã—ã¾ã™ã‹ï¼Ÿ")) google.script.run.withSuccessHandler(res => { if (res.success) { alert(res.message); if (typeof GLOBAL_LOGIN_MODE !== 'undefined') GLOBAL_LOGIN_MODE = sel.value; } else alert("ã‚¨ãƒ©ãƒ¼: " + res.message); }).saveLoginSettings({ mode: sel.value, userPasscode: getCurrentUserPasscode() });
  }
</script>