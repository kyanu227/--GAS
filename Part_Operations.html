<!DOCTYPE html>
<html>

<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
  <style>
    /* ç”»é¢ä¸‹éƒ¨ã®ä½™ç™½ç¢ºä¿ */
    body {
      background-color: #f8f9fa;
      padding-bottom: 180px;
    }

    body.dial-lock {
      overflow: hidden !important;
      position: fixed !important;
      width: 100% !important;
      overscroll-behavior-y: none !important;
    }

    .selection-panel {
      display: flex;
      gap: 10px;
    }

    .check-card-input {
      display: none;
    }

    .check-card-label {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 6px 5px;
      /* reduced from 10px */
      border: 1px solid #ced4da;
      border-radius: 8px;
      background: #fff;
      cursor: pointer;
      transition: all 0.2s ease;
      height: 100%;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }

    .check-unused .check-card-input:checked+.check-card-label {
      background-color: #e8f5e9;
      border-color: #198754;
      color: #198754;
      box-shadow: 0 0 0 1px #198754;
    }

    .check-defect .check-card-input:checked+.check-card-label {
      background-color: #fff5f5;
      border-color: #dc3545;
      color: #dc3545;
      box-shadow: 0 0 0 1px #dc3545;
    }

    .bulk-card {
      background: #fff;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      padding: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }

    .bulk-id {
      font-size: 1.2rem;
      font-weight: bold;
      font-family: monospace;
      color: #333;
    }

    .bulk-tag-btn {
      font-size: 0.8rem;
      padding: 4px 10px;
      border: 1px solid #ced4da;
      background: #fff;
      color: #6c757d;
      border-radius: 20px;
      margin-left: 5px;
      font-weight: bold;
    }

    .bulk-tag-btn.active-unused {
      background: #198754;
      color: #fff;
      border-color: #198754;
    }

    .bulk-tag-btn.active-defect {
      background: #dc3545;
      color: #fff;
      border-color: #dc3545;
    }

    .queue-card {
      background: white;
      border-left: 6px solid #6c757d;
      border-radius: 8px;
      padding: 10px;
      margin-bottom: 8px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }

    .queue-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 5px;
    }

    .queue-id {
      font-size: 1.2rem;
      font-weight: bold;
      font-family: monospace;
    }

    .quick-note-btn {
      font-size: 0.7rem;
      padding: 3px 8px;
      margin-right: 4px;
      margin-top: 4px;
      border: 1px solid #dc3545;
      color: #dc3545;
      background: white;
      border-radius: 15px;
    }

    .quick-note-btn:active {
      background: #dc3545;
      color: white;
    }

    .submit-float {
      position: fixed;
      bottom: calc(90px + env(safe-area-inset-bottom));
      left: 5%;
      width: 90%;
      padding: 15px;
      font-size: 1.2rem;
      font-weight: bold;
      border-radius: 50px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
      z-index: 1000;
      transition: transform 0.1s;
      border: none;
      color: white;
    }

    .submit-float:active {
      transform: scale(0.98);
    }



    /* Rotary Linear Drumroll Mode Styles */
    .rotary-container {
      position: absolute;
      right: 0;
      top: 60px;
      /* Below OK button */
      bottom: 5px;
      width: 120px;
      pointer-events: none;
      z-index: 100;
      overflow: hidden;
    }

    .rotary-item {
      position: absolute;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(4px);
      -webkit-backdrop-filter: blur(4px);
      color: #666;
      font-size: 1.5rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: center;
      left: 35px;
      /* Center horizontally in the 120px container */
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      border: 1px solid rgba(0, 0, 0, 0.05);
      transition: top 0.2s cubic-bezier(0.25, 1, 0.5, 1), background-color 0.2s, transform 0.2s, color 0.1s, opacity 0.2s, box-shadow 0.2s;
      user-select: none;
      cursor: pointer;
      pointer-events: auto;
    }

    .rotary-item.active {
      transform: scale(1.5) translateY(-5px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.25);
      border-color: transparent;
      z-index: 110;
    }

    .rotary-touch-area {
      position: absolute;
      right: 0;
      top: 0;
      bottom: 0;
      width: 120px;
      /* Match rotary-container width exactly */
      z-index: 90;
      /* Above container bg, below rotary-items */
      touch-action: none !important;
      -webkit-touch-callout: none;
      overscroll-behavior: none;
    }

    #rotary-queue-display {
      position: absolute;
      left: 10px;
      top: 10px;
      bottom: 10px;
      right: 130px;
      /* rotary-container width + gap */
      overflow-y: auto;
      background: #fff;
      border-radius: 12px;
      padding: 10px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
      touch-action: pan-y;
      padding-bottom: 70px;
    }

    #dial-submit-btn {
      position: absolute;
      bottom: 10px;
      left: 10px;
      right: 10px;
      width: calc(100% - 20px);
      border-radius: 50px;
      padding: 12px;
      font-size: 1.1rem;
      font-weight: bold;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.25);
      z-index: 150;
      transition: transform 0.15s;
    }

    #dial-submit-btn:active {
      transform: scale(0.96);
    }

    .op-setting-panel {
      min-height: 50px;
      /* Prevent layout shift when switching modes */
    }

    @keyframes popPulse {
      0% {
        transform: scale(1);
      }

      50% {
        transform: scale(1.1);
      }

      100% {
        transform: scale(1);
      }
    }

    .pop-anim {
      animation: popPulse 0.2s ease-out;
    }
  </style>
</head>

<body>

  <!-- op-container: flexbox column filling available height -->
  <div id="op-container" class="container-fluid mt-3 d-flex flex-column"
    style="height: calc(100dvh - 120px - env(safe-area-inset-bottom));">
    <div class="d-flex justify-content-between align-items-center mb-2 flex-shrink-0">
      <div id="ui-mode-toggle" style="display:none;">
        <div class="btn-group btn-group-sm" role="group">
          <input type="radio" class="btn-check" name="uiMode" id="ui-standard" value="standard" autocomplete="off"
            checked onchange="toggleUIMode()">
          <label class="btn btn-outline-secondary shadow-sm" for="ui-standard"><i class="bi bi-card-list"></i>
            ãƒªã‚¹ãƒˆ</label>
          <input type="radio" class="btn-check" name="uiMode" id="ui-dial" value="dial" autocomplete="off"
            onchange="toggleUIMode()">
          <label class="btn btn-outline-secondary shadow-sm" for="ui-dial"><i class="bi bi-vinyl"></i> ãƒ€ã‚¤ãƒ¤ãƒ«</label>
        </div>
      </div>
      <button id="btn-refresh" class="btn btn-sm btn-outline-secondary border-0" onclick="refreshMasterData()">
        <i class="bi bi-arrow-clockwise"></i> ãƒªã‚¹ãƒˆæ›´æ–°
      </button>
    </div>

    <!-- Settings panels (top for list, moved to bottom by JS for dial) -->
    <div id="op-settings-card" class="card p-3 mb-2 border-0 shadow-sm flex-shrink-0" style="background:#fff;">
      <div id="op-settings-lend" class="op-setting-panel" style="display:none;">
        <label class="form-label fw-bold small text-primary mb-1">è²¸å‡ºå…ˆ</label>
        <div class="d-flex gap-2">
          <select id="op-dest-select" class="form-select form-select-sm fw-bold flex-grow-1">
            <option value="" disabled selected>èª­ã¿è¾¼ã¿ä¸­...</option>
          </select>
          <button id="btn-self-use" class="btn btn-sm btn-outline-secondary" onclick="toggleSelfUse()"
            style="white-space: nowrap;">
            <i class="bi bi-building"></i> è‡ªç¤¾
          </button>
        </div>
        <div id="self-use-badge" class="mt-2 text-end" style="display:none;">
          <span class="badge bg-info text-dark"><i class="bi bi-check-circle-fill"></i> è‡ªç¤¾åˆ©ç”¨ã¨ã—ã¦è¨˜éŒ²</span>
        </div>
      </div>
      <div id="op-settings-return" class="op-setting-panel" style="display:none;">
        <div class="selection-panel">
          <div class="check-unused flex-fill">
            <input type="checkbox" id="op-check-unused" class="check-card-input" onchange="toggleReturnCheck('unused')">
            <label for="op-check-unused" class="check-card-label">
              <i class="bi bi-fuel-pump-fill fs-4 mb-0"></i>
              <span class="fw-bold small">æœªä½¿ç”¨</span>
            </label>
          </div>
          <div class="check-defect flex-fill">
            <input type="checkbox" id="op-check-defect" class="check-card-input" onchange="toggleReturnCheck('defect')">
            <label for="op-check-defect" class="check-card-label">
              <i class="bi bi-exclamation-triangle-fill fs-4 mb-0"></i>
              <span class="fw-bold small">æœªå……å¡«</span>
            </label>
          </div>
        </div>
      </div>
      <div id="op-settings-fill" class="op-setting-panel" style="display:none;">
        <div class="text-muted small mt-2 mb-1">
          <i class="bi bi-info-circle text-warning"></i> å……å¡«ã—ãŸã‚¿ãƒ³ã‚¯ã®IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚
        </div>
      </div>
      <div id="op-settings-bulk-return" class="op-setting-panel" style="display:none;">
        <div class="d-flex justify-content-between align-items-end mb-2">
          <h6 class="fw-bold text-secondary mb-0"><i class="bi bi-building-down"></i> è‡ªç¤¾ä½¿ç”¨ä¸­ã‚¿ãƒ³ã‚¯</h6>
          <button class="btn btn-sm btn-outline-secondary py-0" style="font-size:0.8rem;"
            onclick="loadBulkReturnList()"><i class="bi bi-arrow-clockwise"></i> å†å–å¾—</button>
        </div>
        <div id="bulk-return-list" class="d-grid gap-1 mt-3">
          <div class="text-center text-muted p-3"><span class="spinner-border spinner-border-sm"></span> å–å¾—ä¸­...</div>
        </div>
      </div>
    </div>

    <!-- Input area (standard mode) -->
    <div id="op-inputs"></div>

    <!-- Dial mode (fills remaining space) -->
    <div id="op-dial-mode" class="flex-grow-1" style="display:none; position:relative; overflow:hidden; min-height:0;">
      <div id="rotary-queue-display">
        <div class="d-flex justify-content-between align-items-end mb-2 border-bottom pb-2">
          <span class="fw-bold text-dark small"><i class="bi bi-list-check"></i> é€ä¿¡ãƒªã‚¹ãƒˆ (<span
              id="rotary-queue-count">0</span>)</span>
          <button class="btn btn-sm btn-outline-secondary py-0" style="font-size:0.75rem;"
            onclick="clearOpQueue()">å…¨æ¶ˆå»</button>
        </div>
        <div id="rotary-queue-list" class="d-grid gap-2">
          <div class="text-muted small text-center mt-3">ã¾ã ã‚­ãƒ¥ãƒ¼ã«è¿½åŠ ã•ã‚Œã¦ã„ã¾ã›ã‚“</div>
        </div>
        <button id="dial-submit-btn" class="btn btn-primary border-0" style="display:none;" onclick="submitOp()">
          <i class="bi bi-send-fill"></i> <span id="dial-submit-label">é€ä¿¡</span>
        </button>
      </div>
      <div id="dial-ok-wrapper" style="position: absolute; right: 10px; top: 10px; width: 100px; z-index: 130;">
        <button id="dial-ok-btn" class="btn fw-bold shadow-sm px-2 py-2 w-100" onclick="submitActiveOk()"
          style="font-size: 0.95rem; border-radius: 8px; color:#fff; background:#0d6efd;">
          <span id="dial-ok-label">OKå…¥åŠ›</span>
        </button>
      </div>
      <input type="tel" id="rotary-hidden-input" style="position:absolute; top:-1000px; left:-1000px; opacity:0;"
        maxlength="2" oninput="checkRotaryInput(this)">
      <div id="rotary-touch-area" class="rotary-touch-area"></div>
      <div id="rotary-wheel-container" class="rotary-container">
        <div id="dial-wheel"></div>
      </div>
    </div>

    <!-- Standard queue box -->
    <div id="op-queue-box" class="mt-2" style="display:none;">
      <div class="d-flex justify-content-between align-items-end mb-2">
        <span class="fw-bold text-dark small"><i class="bi bi-list-check"></i> é€ä¿¡ãƒªã‚¹ãƒˆ (<span
            id="op-queue-count">0</span>)</span>
        <button class="btn btn-sm btn-outline-secondary py-0" style="font-size:0.8rem;"
          onclick="clearOpQueue()">å…¨æ¶ˆå»</button>
      </div>
      <div id="op-queue-list" class="d-grid gap-2"></div>
    </div>
  </div>

  <button id="op-submit-btn" class="submit-float" style="display:none;" onclick="submitOp()">
    <i class="bi bi-send-fill"></i> <span id="op-submit-label">é€ä¿¡</span>
  </button>


  <script>
    var opQueue = [];
    var opMode = '';
    var isSelfUseMode = false;
    var opPrefixes = [];
    var bulkReturnTanks = [];

    window.onload = function () {
      google.script.url.getLocation(function (location) {
        var action = (location.parameter && location.parameter.action) ? location.parameter.action : "è²¸å‡º";
        initOperations(action);
        loadAllMasterData();
      });
    };

    function loadAllMasterData() {
      google.script.run.withSuccessHandler(function (data) {
        var sel = document.getElementById('op-dest-select');
        if (sel) {
          sel.innerHTML = '';
          var def = document.createElement('option');
          def.text = "ğŸ‘‡ è²¸å‡ºå…ˆã‚’é¸æŠ"; def.value = ""; def.selected = true; def.disabled = true;
          sel.appendChild(def);
          if (data.destList && data.destList.length > 0) {
            data.destList.forEach(function (d) { sel.appendChild(new Option(d, d)); });
          } else { sel.appendChild(new Option("â€»ãƒªã‚¹ãƒˆãªã—", "")); }
        }

        if (data.repairOptions && data.repairOptions.length > 0) {
          repairOptionsCache = data.repairOptions;
          if (opMode === 'ä¿®ç†æ¸ˆã¿') renderRepairCheckboxes();
        } else {
          var roContainer = document.getElementById('repair-options-container');
          if (roContainer) roContainer.innerHTML = '<div class="text-muted p-2 small">â€»ä¿®ç†é …ç›®ãªã—</div>';
        }

        if (data.prefixes && data.prefixes.length > 0) {
          opPrefixes = data.prefixes;
          var btn = document.getElementById('op-submit-btn');
          var currentColor = btn ? btn.style.backgroundColor : '#6c757d';
          renderOpInputs(currentColor || '#6c757d');
        }
      }).getOperationsInitData();
    }

    function initOperations(mode) {
      opMode = mode;
      opQueue = [];
      renderOpQueue();
      var panels = document.getElementsByClassName('op-setting-panel');
      for (var i = 0; i < panels.length; i++) panels[i].style.display = 'none';
      isSelfUseMode = false;
      updateSelfUseUI();

      var color = '#6c757d';
      var btnText = 'é€ä¿¡';

      if (mode === 'è²¸å‡º') {
        document.getElementById('op-settings-lend').style.display = 'block';
        color = '#0d6efd'; btnText = 'è²¸å‡ºå®Ÿè¡Œ';
      } else if (mode === 'è¿”å´') {
        document.getElementById('op-settings-return').style.display = 'block';
        color = '#198754'; btnText = 'è¿”å´å®Ÿè¡Œ';
      } else if (mode === 'å……å¡«') {
        document.getElementById('op-settings-fill').style.display = 'block';
        color = '#fd7e14'; btnText = 'å……å¡«å®Œäº†';
      } else if (mode === 'è‡ªç¤¾ä¸€æ‹¬') {
        document.getElementById('op-settings-bulk-return').style.display = 'block';
        color = '#0dcaf0'; btnText = 'ä¸€æ‹¬è¿”å´';
        loadBulkReturnList();
      }

      var btn = document.getElementById('op-submit-btn');
      var dialBtn = document.getElementById('dial-submit-btn');
      var hasItems = false;

      if (mode === 'è‡ªç¤¾ä¸€æ‹¬') {
        hasItems = (bulkReturnTanks.length > 0);
      } else {
        hasItems = (opQueue && opQueue.length > 0);
      }

      var isDialActive = document.getElementById('ui-dial').checked;

      if (btn) {
        btn.style.display = (hasItems && !isDialActive && mode !== 'è‡ªç¤¾ä¸€æ‹¬') ? 'block' : 'none';
        if (mode === 'è‡ªç¤¾ä¸€æ‹¬') btn.style.display = hasItems ? 'block' : 'none';
        btn.style.backgroundColor = color;
        document.getElementById('op-submit-label').innerText = btnText;
      }

      if (dialBtn) {
        dialBtn.style.display = (hasItems && isDialActive && mode !== 'è‡ªç¤¾ä¸€æ‹¬') ? 'block' : 'none';
        dialBtn.style.backgroundColor = color;
        var dialLabel = document.getElementById('dial-submit-label');
        if (dialLabel) dialLabel.innerText = btnText;
      }
      document.querySelectorAll('.nav-item').forEach(el => {
        el.classList.remove('active');
        if (el.dataset.mode === mode) el.classList.add('active');
      });

      if (mode === 'è‡ªç¤¾ä¸€æ‹¬') {
        document.getElementById('op-inputs').style.display = 'none';
        var dm = document.getElementById('op-dial-mode');
        if (dm) dm.style.display = 'none';
        document.getElementById('op-queue-box').style.display = 'none';
        document.body.classList.remove('dial-lock');
      } else {
        renderOpInputs(color);
        applyUIMode();
        renderOpQueue();
      }

      var uiToggle = document.getElementById('ui-mode-toggle');
      if (uiToggle) {
        uiToggle.style.display = ['è‡ªç¤¾ä¸€æ‹¬'].includes(mode) ? 'none' : 'block';
      }
    }

    function toggleUIMode() {
      applyUIMode();
    }
    function applyUIMode() {
      if (opMode === 'è‡ªç¤¾ä¸€æ‹¬') return;
      var isDial = document.getElementById('ui-dial').checked;
      var btn = document.getElementById('op-submit-btn');
      var dialBtn = document.getElementById('dial-submit-btn');
      var color = btn ? btn.style.backgroundColor : '#6c757d';
      var hasItems = (opQueue && opQueue.length > 0);
      var settingsCard = document.getElementById('op-settings-card');
      var container = document.getElementById('op-container');
      var opInputs = document.getElementById('op-inputs');
      var queueBox = document.getElementById('op-queue-box');

      if (isDial) {
        // Save scroll position before locking (position:fixed resets it)
        var scrollPos = window.pageYOffset || document.documentElement.scrollTop;
        document.getElementById('op-inputs').style.display = 'none';
        document.getElementById('op-dial-mode').style.display = 'flex';
        document.body.classList.add('dial-lock');
        document.body.style.top = '-' + scrollPos + 'px';
        document.body.dataset.scrollPos = scrollPos;
        // Document-level touch blocker for Safari
        if (!window._dialTouchBlocker) {
          window._dialTouchBlocker = function (e) {
            if (!document.body.classList.contains('dial-lock')) return;
            // Allow scrolling inside queue display
            var target = e.target;
            while (target && target !== document.body) {
              if (target.id === 'rotary-queue-display') return;
              target = target.parentElement;
            }
            if (e.cancelable) e.preventDefault();
          };
          document.addEventListener('touchmove', window._dialTouchBlocker, { passive: false });
        }
        if (btn) btn.style.display = 'none';
        if (dialBtn) dialBtn.style.display = hasItems ? 'block' : 'none';
        // Move settings card to BOTTOM (after queue-box)
        if (settingsCard && queueBox) container.appendChild(settingsCard);
        registerDialTouch();
        renderDialMode(color);
      } else {
        document.getElementById('op-dial-mode').style.display = 'none';
        document.getElementById('op-inputs').style.display = 'block';
        // Restore scroll position before removing dial-lock
        var savedPos = parseInt(document.body.dataset.scrollPos || '0');
        document.body.classList.remove('dial-lock');
        document.body.style.top = '';
        window.scrollTo(0, savedPos);
        if (dialBtn) dialBtn.style.display = 'none';
        if (btn) btn.style.display = hasItems ? 'block' : 'none';
        // Move settings card back to TOP (before op-inputs)
        if (settingsCard && opInputs) container.insertBefore(settingsCard, opInputs);
        isDraggingDial = false;
        currentScrollY = 0;
      }
    }

    function refreshMasterData() {
      if (!confirm("æœ€æ–°ã®ãƒªã‚¹ãƒˆã‚’å–å¾—ã—ã¾ã™ã‹ï¼Ÿ")) return;
      var btn = document.getElementById('btn-refresh');
      var orgHtml = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> æ›´æ–°ä¸­';
      google.script.run.withSuccessHandler(function (res) {
        loadAllMasterData(); btn.disabled = false; btn.innerHTML = orgHtml;
      }).withFailureHandler(function (e) {
        alert("æ›´æ–°ã‚¨ãƒ©ãƒ¼: " + e.message); btn.disabled = false; btn.innerHTML = orgHtml;
      }).clearMasterCaches();
    }

    function toggleSelfUse() { isSelfUseMode = !isSelfUseMode; updateSelfUseUI(); renderOpQueue(); }
    function updateSelfUseUI() {
      var sel = document.getElementById('op-dest-select');
      var btn = document.getElementById('btn-self-use');
      var badge = document.getElementById('self-use-badge');
      if (sel && btn && badge) {
        if (isSelfUseMode) {
          sel.disabled = true; btn.className = 'btn btn-info text-dark fw-bold'; badge.style.display = 'block';
          document.getElementById('op-submit-label').innerText = 'åˆ©ç”¨é–‹å§‹';
        } else {
          sel.disabled = false; btn.className = 'btn btn-outline-secondary'; badge.style.display = 'none';
          document.getElementById('op-submit-label').innerText = 'è²¸å‡ºå®Ÿè¡Œ';
        }
      }
    }
    function toggleReturnCheck(type) {
      var unused = document.getElementById('op-check-unused');
      var defect = document.getElementById('op-check-defect');
      if (type === 'unused' && unused.checked) defect.checked = false;
      else if (type === 'defect' && defect.checked) unused.checked = false;
    }

    function loadBulkReturnList() {
      var container = document.getElementById('bulk-return-list');
      if (!container) return;
      container.innerHTML = '<div class="text-center text-muted p-3"><span class="spinner-border spinner-border-sm"></span> å–å¾—ä¸­...</div>';

      google.script.run.withSuccessHandler(function (list) {
        bulkReturnTanks = list.map(item => ({ id: item.id, statusTag: 'normal', note: '' }));
        renderBulkReturnList();
      }).withFailureHandler(function (e) {
        container.innerHTML = '<div class="alert alert-danger py-2 small">å–å¾—ã‚¨ãƒ©ãƒ¼: ' + e.message + '</div>';
      }).getInHouseTanks();
    }

    function renderBulkReturnList() {
      var container = document.getElementById('bulk-return-list');
      if (!container) return;
      container.innerHTML = '';

      if (bulkReturnTanks.length === 0) {
        container.innerHTML = '<div class="text-center text-muted p-3 mt-4"><i class="bi bi-check-circle display-1 text-success d-block mb-3"></i><h5>è¿”å´ã™ã‚‹ã‚¿ãƒ³ã‚¯ã¯ã‚ã‚Šã¾ã›ã‚“</h5><p class="small">ç¾åœ¨è‡ªç¤¾åˆ©ç”¨ä¸­ã®ã‚¿ãƒ³ã‚¯ã¯0ä»¶ã§ã™ã€‚</p></div>';
        var btn = document.getElementById('op-submit-btn');
        if (btn) btn.style.display = 'none';
        return;
      }

      bulkReturnTanks.forEach(function (item, idx) {
        var unusedCls = (item.statusTag === 'unused') ? 'active-unused' : '';
        var defectCls = (item.statusTag === 'defect') ? 'active-defect' : '';

        var html = `
          <div class="bulk-card">
            <div class="bulk-id">${item.id}</div>
            <div>
              <button class="bulk-tag-btn ${unusedCls}" onclick="toggleBulkTag(${idx}, 'unused')">æœªä½¿ç”¨</button>
              <button class="bulk-tag-btn ${defectCls}" onclick="toggleBulkTag(${idx}, 'defect')">æœªå……å¡«</button>
            </div>
          </div>
        `;
        container.insertAdjacentHTML('beforeend', html);
      });

      var btn = document.getElementById('op-submit-btn');
      if (btn && opMode === 'è‡ªç¤¾ä¸€æ‹¬') {
        btn.style.display = 'block';
        document.getElementById('op-submit-label').innerText = bulkReturnTanks.length + "ä»¶ å…¨ã¦è¿”å´";
      }
    }

    function toggleBulkTag(idx, tag) {
      if (bulkReturnTanks[idx].statusTag === tag) {
        bulkReturnTanks[idx].statusTag = 'normal';
      } else {
        bulkReturnTanks[idx].statusTag = tag;
      }
      renderBulkReturnList();
    }

    function renderRepairCheckboxes() {
      var container = document.getElementById('repair-options-container');
      if (!container) return;
      container.innerHTML = '';
      repairOptionsCache.forEach(function (opt, idx) {
        var html = `<label class="repair-list-item" id="rep-item-${idx}">
     <input class="form-check-input repair-check-input" type="checkbox" value="${opt.price}" id="rep-opt-${idx}" data-name="${opt.name}" onchange="toggleRepairItem(${idx})">
     <span class="repair-name">${opt.name}</span><span class="repair-price">${opt.price} å††</span></label>`;
        container.insertAdjacentHTML('beforeend', html);
      });
      calcRepairTotal();
    }
    function toggleRepairItem(idx) {
      var chk = document.getElementById('rep-opt-' + idx);
      var item = document.getElementById('rep-item-' + idx);
      if (chk && item) {
        if (chk.checked) item.classList.add('checked'); else item.classList.remove('checked');
        calcRepairTotal();
      }
    }
    function calcRepairTotal() {
      var total = 0;
      var checks = document.querySelectorAll('#repair-options-container input[type="checkbox"]:checked');
      checks.forEach(function (c) { total += parseInt(c.value) || 0; });
      var disp = document.getElementById('repair-total-display');
      if (disp) disp.innerText = total.toLocaleString();
    }

    function renderOpInputs(color) {
      var div = document.getElementById('op-inputs');
      if (!div) return;
      div.innerHTML = '';
      div.style.display = 'block';
      if (opPrefixes.length === 0) {
        div.innerHTML = '<div class="text-center text-muted py-3"><span class="spinner-border spinner-border-sm"></span> ã‚¿ãƒ³ã‚¯IDãƒªã‚¹ãƒˆèª­ã¿è¾¼ã¿ä¸­...</div>';
        return;
      }
      opPrefixes.forEach(p => {
        div.innerHTML += `<div class="input-row-card d-flex gap-2 mb-2 align-items-center p-2 bg-white rounded shadow-sm" style="border-left: 5px solid ${color}; cursor:pointer;" onclick="var i=document.getElementById('input-${p}'); if(i && event.target.tagName !== 'BUTTON') i.focus();">
     <span class="fs-4 fw-bold" style="width:30px; text-align:center;">${p}</span>
     <input type="tel" id="input-${p}" class="form-control fw-bold text-center fs-5" maxlength="2" placeholder="--" oninput="checkOpInput('${p}', this)">
     <button class="btn text-white fw-bold" style="background:${color};" onclick="forceAddOpQueue('${p}')">OK</button></div>`;
      });
    }

    function checkOpInput(prefix, el) {
      var val = el.value.replace(/[ï¼-ï¼™]/g, s => String.fromCharCode(s.charCodeAt(0) - 0xFEE0));
      val = val.replace(/[^0-9]/g, ''); // æ•°å­—ä»¥å¤–ã‚’å‰Šé™¤
      el.value = val;
      if (val.length >= 2) {
        addOpQueue(prefix + '-' + val);
        el.value = '';
        triggerSuccessFeedback(prefix);
      }
    }

    function forceAddOpQueue(prefix) {
      var el = document.getElementById('input-' + prefix);
      if (el && el.value.length > 0) {
        addOpQueue(prefix + '-' + el.value);
        el.value = '';
        triggerSuccessFeedback(prefix);
      }
    }

    function triggerSuccessFeedback(prefix) {
      // ç”»é¢ä¸Šã®è¦–è¦šçš„ãªãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ï¼ˆãƒ•ãƒ©ãƒƒã‚·ãƒ¥ï¼‰
      var inputEl = document.getElementById('input-' + prefix);
      if (inputEl) {
        var row = inputEl.closest('.input-row-card');
        if (row) {
          row.classList.remove('flash-success');
          void row.offsetWidth;
          row.classList.add('flash-success');
        }
      }
      var dialModeBox = document.getElementById('op-dial-mode');
      if (dialModeBox && dialModeBox.style.display !== 'none') {
        var rList = document.getElementById('rotary-queue-list');
        if (rList) {
          rList.classList.remove('flash-success');
          void rList.offsetWidth;
          rList.classList.add('flash-success');
        }
      }
    }

    function addOpQueue(id) {
      if (!opQueue.some(item => item.id === id)) { opQueue.push({ id: id, note: '' }); renderOpQueue(); }
    }
    function updateItemNote(index, text) { opQueue[index].note = text; }
    function appendQuickNote(index, text) {
      var current = opQueue[index].note;
      if (current) text = current + ", " + text;
      opQueue[index].note = text;
      document.getElementById('note-input-' + index).value = text;
    }

    function renderOpQueue() {
      var list = document.getElementById('op-queue-list');
      if (!list) return;
      list.innerHTML = '';
      document.getElementById('op-queue-count').innerText = opQueue.length;
      var box = document.getElementById('op-queue-box');
      var btn = document.getElementById('op-submit-btn');
      var color = btn ? btn.style.backgroundColor : '#6c757d';

      var isDial = document.getElementById('ui-dial') && document.getElementById('ui-dial').checked;
      var dialBtn = document.getElementById('dial-submit-btn');

      if (opQueue.length > 0) {
        if (!isDial) {
          box.style.display = 'block';
          btn.style.display = 'block';
          if (dialBtn) dialBtn.style.display = 'none';
        } else {
          box.style.display = 'none';
          btn.style.display = 'none';
          if (dialBtn) dialBtn.style.display = 'block';
        }
        opQueue.slice().reverse().forEach((item, revIndex) => {
          var index = opQueue.length - 1 - revIndex;
          var quickBtns = (opMode === 'ç ´æå ±å‘Š') ? `<div class="mt-1"><button class="btn quick-note-btn" onclick="appendQuickNote(${index}, 'ãƒãƒ«ãƒ–å›ºãƒ»æ­ªã¿')">ãƒãƒ«ãƒ–å›ºãƒ»æ­ªã¿</button>...</div>` : '';
          if (opMode === 'ç ´æå ±å‘Š') {
            quickBtns = `<div class="mt-1">
         <button class="btn quick-note-btn" onclick="appendQuickNote(${index}, 'ãƒãƒ«ãƒ–å›ºãƒ»æ­ªã¿')">ãƒãƒ«ãƒ–å›ºãƒ»æ­ªã¿</button>
         <button class="btn quick-note-btn" onclick="appendQuickNote(${index}, 'ã‚¨ã‚¢æ¼ã‚Œ')">ã‚¨ã‚¢æ¼ã‚Œ</button>
         <button class="btn quick-note-btn" onclick="appendQuickNote(${index}, 'Oãƒªãƒ³ã‚°')">Oãƒªãƒ³ã‚°</button>
       </div>`;
          }
          var ph = (opMode === 'è²¸å‡º') ? 'æ‹…å½“è€…å(ä»»æ„)' : (opMode === 'ç ´æå ±å‘Š' ? 'ç ´æå†…å®¹' : 'å‚™è€ƒ(ä»»æ„)');
          list.innerHTML += `<div class="queue-card" style="border-left-color: ${color};">
       <div class="queue-card-header"><span class="queue-id">${item.id}</span>
         <button class="btn btn-link text-secondary p-0" onclick="removeOpQueue(${index})"><i class="bi bi-trash3-fill"></i></button></div>
       <div><input type="text" id="note-input-${index}" class="form-control form-control-sm" placeholder="${ph}" value="${item.note}" oninput="updateItemNote(${index}, this.value)">${quickBtns}</div></div>`;
        });
      } else {
        box.style.display = 'none';
        if (opMode !== 'è‡ªç¤¾ä¸€æ‹¬') {
          btn.style.display = 'none';
          if (dialBtn) dialBtn.style.display = 'none';
        }
      }

      // Also update the rotary specific queue if needed
      if (isDial) {
        renderRotaryQueue();
      }
    }

    function renderRotaryQueue() {
      var list = document.getElementById('rotary-queue-list');
      if (!list) return;
      list.innerHTML = '';
      var btn = document.getElementById('op-submit-btn');
      var color = btn ? btn.style.backgroundColor : '#6c757d';

      if (opQueue.length > 0) {
        opQueue.slice().reverse().forEach((item, revIndex) => {
          var index = opQueue.length - 1 - revIndex;
          list.innerHTML += `<div class="queue-card p-2 mb-1 shadow-sm" style="border-left-color: ${color};">
           <div class="d-flex justify-content-between align-items-center">
             <span class="fw-bold fs-5 font-monospace">${item.id}</span>
             <button class="btn btn-sm text-danger" onclick="removeOpQueue(${index})"><i class="bi bi-trash3-fill"></i></button>
           </div>
          </div>`;
        });
      } else {
        list.innerHTML = '<div class="text-muted small">ã¾ã ã‚­ãƒ¥ãƒ¼ã«è¿½åŠ ã•ã‚Œã¦ã„ã¾ã›ã‚“</div>';
      }
    }

    function removeOpQueue(index) { opQueue.splice(index, 1); renderOpQueue(); }
    function clearOpQueue() { opQueue = []; renderOpQueue(); }

    function submitOp() {
      if (opMode === 'è‡ªç¤¾ä¸€æ‹¬') {
        submitBulkReturn();
        return;
      }

      if (opMode === 'è²¸å‡º' && !isSelfUseMode) {
        var dest = document.getElementById('op-dest-select').value;
        if (!dest || dest === "") { alert("âš ï¸ è²¸å‡ºå…ˆãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚"); return; }
      }
      var confirmMsg = opQueue.length + 'ä»¶ é€ä¿¡ã—ã¾ã™ã‹ï¼Ÿ';
      if (opMode === 'è²¸å‡º' && isSelfUseMode) confirmMsg += '\nï¼ˆè‡ªç¤¾åˆ©ç”¨ã¨ã—ã¦è¨˜éŒ²ã•ã‚Œã¾ã™ï¼‰';
      else if (opMode === 'è²¸å‡º') confirmMsg += '\nè²¸å‡ºå…ˆ: ' + document.getElementById('op-dest-select').value;

      if (!confirm(confirmMsg)) return;

      var btn = document.getElementById('op-submit-btn');
      var orgText = document.getElementById('op-submit-label').innerText;
      btn.disabled = true; document.getElementById('op-submit-label').innerText = "é€ä¿¡ä¸­...";

      var finalDest = document.getElementById('op-dest-select') ? document.getElementById('op-dest-select').value : "";
      var finalAction = opMode;
      if (opMode === 'è²¸å‡º' && isSelfUseMode) { finalDest = "è‡ªç¤¾åˆ©ç”¨"; finalAction = "è‡ªç¤¾åˆ©ç”¨"; }

      var payload = {
        action: finalAction,
        items: opQueue,
        destination: finalDest,
        isUnused: document.getElementById('op-check-unused') ? document.getElementById('op-check-unused').checked : false,
        isDefect: document.getElementById('op-check-defect') ? document.getElementById('op-check-defect').checked : false,
        repairCost: 0,
        repairDetail: "",
        userPasscode: (typeof GLOBAL_PASSCODE !== 'undefined') ? GLOBAL_PASSCODE : ""
      };

      google.script.run.withSuccessHandler(res => {
        btn.disabled = false; document.getElementById('op-submit-label').innerText = orgText;
        clearOpQueue();
        if (isSelfUseMode) toggleSelfUse();
        if (opMode === 'è²¸å‡º') document.getElementById('op-dest-select').value = "";
        if (document.getElementById('op-check-unused')) document.getElementById('op-check-unused').checked = false;
        if (document.getElementById('op-check-defect')) document.getElementById('op-check-defect').checked = false;

        var msg = "ã€é€ä¿¡çµæœã€‘\nç·æ•°: " + (res.totalCount || 0) + " æœ¬\n----------------\n";
        if (res.successIds && res.successIds.length > 0) msg += "âœ… æˆåŠŸ (" + res.successIds.length + "æœ¬):\n" + res.successIds.join(", ") + "\n\n";
        else msg += "âœ… æˆåŠŸ: ãªã—\n\n";
        if (res.failedItems && res.failedItems.length > 0) {
          msg += "âŒ å¤±æ•— (" + res.failedItems.length + "æœ¬):\n";
          res.failedItems.forEach(item => msg += "ãƒ»" + item.id + " : " + item.reason + "\n");
        }
        alert(msg);

      }).withFailureHandler(function (e) {
        btn.disabled = false; document.getElementById('op-submit-label').innerText = orgText;
        alert("ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼: " + e);
      }).submitOperations(payload);
    }

    function submitBulkReturn() {
      if (bulkReturnTanks.length === 0) return;
      if (!confirm(bulkReturnTanks.length + "ä»¶ã®è‡ªç¤¾ã‚¿ãƒ³ã‚¯ã‚’ä¸€æ‹¬é€ä¿¡ã—ã¾ã™ã‹ï¼Ÿ\\nâ€»æœªä½¿ç”¨ãƒ»æœªå……å¡«ã®ã‚¿ã‚°ã‚’ä»˜ã‘ãŸã‚‚ã®ã¯ãã®çŠ¶æ…‹ã§è¿”å´ã•ã‚Œã¾ã™ã€‚")) return;

      var btn = document.getElementById('op-submit-btn');
      var orgText = document.getElementById('op-submit-label').innerText;
      btn.disabled = true; document.getElementById('op-submit-label').innerText = "é€ä¿¡ä¸­...";

      var payload = {
        action: 'è‡ªç¤¾ä¸€æ‹¬è¿”å´',
        items: bulkReturnTanks,
        userPasscode: (typeof GLOBAL_PASSCODE !== 'undefined') ? GLOBAL_PASSCODE : ""
      };

      google.script.run.withSuccessHandler(res => {
        btn.disabled = false; document.getElementById('op-submit-label').innerText = orgText;
        if (res.success) {
          bulkReturnTanks = [];
          renderBulkReturnList();
          alert(res.message);
        } else {
          var msg = "ã‚¨ãƒ©ãƒ¼: " + res.message + "\\n";
          if (res.failedItems) res.failedItems.forEach(i => msg += i.id + " : " + i.reason + "\\n");
          alert(msg);
        }
      }).withFailureHandler(function (e) {
        btn.disabled = false; document.getElementById('op-submit-label').innerText = orgText;
        alert("ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼: " + e);
      }).submitOperations(payload);
    }

    // â– â– â–  ãƒ­ãƒ¼ã‚¿ãƒªãƒ¼ãƒ¢ãƒ¼ãƒ‰ç”¨JS â– â– â– 
    var currentScrollY = 0;
    var ITEM_HEIGHT = 50;
    var activePrefix = '';
    var isOkMode = false;
    var dialItemsCount = 0;
    var isDraggingDial = false;
    var lastDragY = 0;
    var dialTouchRegistered = false;
    var swipeAccumulator = 0; // Tracks accumulated swipe distance for discrete snap
    var SWIPE_THRESHOLD = 60; // Pixels needed to trigger one item move
    var currentActiveIndex = 0; // Currently active item index

    function renderDialMode(color) {
      var wheel = document.getElementById('dial-wheel');
      if (!wheel) return;
      wheel.innerHTML = '';
      dialItemsCount = opPrefixes.length;
      if (dialItemsCount === 0) return;

      // Set OK button color based on mode
      var okBtn = document.getElementById('dial-ok-btn');
      var modeColor = '#0d6efd';
      if (opMode === 'è²¸å‡º') modeColor = '#0d6efd';
      else if (opMode === 'è¿”å´') modeColor = '#198754';
      else if (opMode === 'å……å¡«') modeColor = '#fd7e14';
      if (okBtn) okBtn.style.backgroundColor = modeColor;

      opPrefixes.forEach((p, i) => {
        var el = document.createElement('div');
        el.className = 'rotary-item shadow-sm';
        el.id = 'dial-item-' + i;
        el.innerText = p;
        el.dataset.prefix = p;
        el.dataset.index = i;

        el.onclick = function () {
          currentActiveIndex = i;
          snapToItem(i);
          var inp = document.getElementById('rotary-hidden-input');
          if (inp) { inp.focus(); }
        };
        wheel.appendChild(el);
      });
      // Reset scroll position to ensure clean state
      currentScrollY = 0;
      currentActiveIndex = 0;
      isDraggingDial = false;
      updateDialPositions();
    }

    function updateDialPositions() {
      var wheel = document.getElementById('dial-wheel');
      var container = document.getElementById('rotary-wheel-container');
      if (!wheel || !container) return;
      var items = wheel.getElementsByClassName('rotary-item');
      if (items.length === 0) return;

      var containerHeight = container.offsetHeight;
      if (containerHeight <= 0) return;

      // Active item sits at bottom, remaining fill upward in alphabetical order
      var activeSlotY = containerHeight - 60;
      var remainingHeight = activeSlotY - 10;
      var slotHeight = Math.max(30, remainingHeight / Math.max(1, dialItemsCount - 1));

      // Mode color
      var modeColor = '#0d6efd';
      if (opMode === 'è²¸å‡º') modeColor = '#0d6efd';
      else if (opMode === 'è¿”å´') modeColor = '#198754';
      else if (opMode === 'å……å¡«') modeColor = '#fd7e14';

      for (var i = 0; i < items.length; i++) {
        var el = items[i];
        var idx = parseInt(el.dataset.index);

        if (idx === currentActiveIndex) {
          // Active item: bottom slot, enlarged + colored
          el.style.top = activeSlotY + 'px';
          el.style.opacity = '1';
          el.classList.add('active');
          el.style.backgroundColor = modeColor;
          el.style.color = '#fff';
          el.style.boxShadow = '0 6px 15px ' + modeColor + '66';
          el.style.transform = 'scale(1.4)';
          el.style.zIndex = '110';

          var targetLabel = document.getElementById('dial-ok-label');
          if (activePrefix !== el.dataset.prefix) {
            activePrefix = el.dataset.prefix;
            if (targetLabel) {
              targetLabel.innerText = el.dataset.prefix + '-OK';
              var okBtn = document.getElementById('dial-ok-btn');
              if (okBtn) {
                okBtn.classList.remove('pop-anim');
                void okBtn.offsetWidth; // trigger reflow
                okBtn.classList.add('pop-anim');
              }
            }
          }
        } else {
          // Cyclic alphabetical order: count how many steps BACK from active
          // If active=D(3), then C(2)=1 step back, B(1)=2, A(0)=3, Z=4, Y=5...
          var stepsBack = (currentActiveIndex - idx + dialItemsCount) % dialItemsCount;
          // stepsBack 1 = immediately above active, 2 = next above, etc.
          var slotY = activeSlotY - stepsBack * slotHeight;

          el.style.top = slotY + 'px';
          el.classList.remove('active');
          el.style.backgroundColor = 'rgba(255,255,255,0.95)';
          el.style.color = '#555';
          el.style.boxShadow = '0 2px 8px rgba(0,0,0,0.1)';
          el.style.transform = 'scale(0.85)';
          el.style.zIndex = '100';

          // Fade near top edge
          if (slotY < 15) {
            el.style.opacity = Math.max(0, (slotY + 20) / 35).toString();
          } else {
            el.style.opacity = '0.8';
          }
        }
      }
    }

    function registerDialTouch() {
      if (dialTouchRegistered) return;
      var touchArea = document.getElementById('rotary-touch-area');
      if (!touchArea) return;

      touchArea.addEventListener('touchstart', function (e) {
        if (e.cancelable) e.preventDefault(); // Prevent page scroll on iOS
        isDraggingDial = true;
        var touch = e.touches[0];
        lastDragY = touch.clientY;
        swipeAccumulator = 0;
      }, { passive: false });

      touchArea.addEventListener('touchmove', function (e) {
        if (!isDraggingDial) return;
        if (e.cancelable) e.preventDefault();

        var touch = e.touches[0];
        var diffY = touch.clientY - lastDragY;
        lastDragY = touch.clientY;

        // Accumulate swipe distance
        swipeAccumulator += diffY;

        // Discrete snap: one item per threshold
        while (swipeAccumulator > SWIPE_THRESHOLD) {
          swipeAccumulator -= SWIPE_THRESHOLD;
          currentActiveIndex = (currentActiveIndex - 1 + dialItemsCount) % dialItemsCount;
          snapToItem(currentActiveIndex);
        }
        while (swipeAccumulator < -SWIPE_THRESHOLD) {
          swipeAccumulator += SWIPE_THRESHOLD;
          currentActiveIndex = (currentActiveIndex + 1) % dialItemsCount;
          snapToItem(currentActiveIndex);
        }
      }, { passive: false });

      touchArea.addEventListener('touchend', function (e) {
        isDraggingDial = false;
        swipeAccumulator = 0;
      }, { passive: true });

      dialTouchRegistered = true;
    }

    function snapToNearest() {
      var activeItem = document.querySelector('.rotary-item.active');
      if (activeItem && activeItem.dataset.index) {
        snapToItem(parseInt(activeItem.dataset.index));
      }
    }

    function snapToItem(idx) {
      var items = document.getElementById('dial-wheel').getElementsByClassName('rotary-item');
      if (!items[idx]) return;

      var baseIdx = parseInt(items[idx].dataset.index);
      var totalScrollRange = dialItemsCount * ITEM_HEIGHT;
      var targetScrollY = baseIdx * ITEM_HEIGHT;

      var diff = targetScrollY - currentScrollY;

      if (diff > totalScrollRange / 2) diff -= totalScrollRange;
      if (diff < -totalScrollRange / 2) diff += totalScrollRange;

      animateDialRotation(currentScrollY + diff);
    }

    function animateDialRotation(targetScroll) {
      var startScroll = currentScrollY;
      var diff = targetScroll - startScroll;
      if (Math.abs(diff) < 1) return;
      var steps = 15;
      var step = 0;
      var intv = setInterval(function () {
        step++;
        var t = step / steps;
        var ease = Math.sin(t * Math.PI / 2);
        currentScrollY = startScroll + diff * ease;

        var totalScrollRange = dialItemsCount * ITEM_HEIGHT;
        if (currentScrollY < 0) currentScrollY += totalScrollRange;
        currentScrollY = currentScrollY % totalScrollRange;

        updateDialPositions();
        if (step >= steps) {
          clearInterval(intv);
          currentScrollY = targetScroll;
          if (currentScrollY < 0) currentScrollY += totalScrollRange;
          currentScrollY = currentScrollY % totalScrollRange;
          updateDialPositions();
        }
      }, 16);
    }

    function submitActiveOk() {
      if (activePrefix) {
        addOpQueue(activePrefix + '-OK');
        triggerSuccessFeedback(activePrefix);
      }
    }

    function checkRotaryInput(el) {
      var val = el.value.replace(/[ï¼-ï¼™]/g, s => String.fromCharCode(s.charCodeAt(0) - 0xFEE0));
      val = val.replace(/[^0-9]/g, ''); // Numeric only
      el.value = val;
      if (val.length >= 2) {
        addOpQueue(activePrefix + '-' + val);
        el.value = '';
        triggerSuccessFeedback(activePrefix);
      }
    }
  </script>
</body>

</html>