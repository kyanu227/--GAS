<!DOCTYPE html>
<html>

<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
  <style>
    /* ç”»é¢ä¸‹éƒ¨ã®ä½™ç™½ç¢ºä¿ */
    body {
      background-color: #f8f9fa;
      padding-bottom: 180px;
    }

    .selection-panel {
      display: flex;
      gap: 10px;
    }

    .check-card-input {
      display: none;
    }

    .check-card-label {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 10px 5px;
      border: 1px solid #ced4da;
      border-radius: 8px;
      background: #fff;
      cursor: pointer;
      transition: all 0.2s ease;
      height: 100%;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }

    .check-unused .check-card-input:checked+.check-card-label {
      background-color: #e8f5e9;
      border-color: #198754;
      color: #198754;
      box-shadow: 0 0 0 1px #198754;
    }

    .check-defect .check-card-input:checked+.check-card-label {
      background-color: #fff5f5;
      border-color: #dc3545;
      color: #dc3545;
      box-shadow: 0 0 0 1px #dc3545;
    }

    .repair-list-item {
      position: relative;
      display: flex;
      align-items: center;
      padding: 10px 12px;
      margin-bottom: 6px;
      background-color: #fff;
      border: 1px solid #dee2e6;
      border-radius: 6px;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .repair-list-item:active {
      background-color: #f1f3f5;
    }

    .repair-list-item.checked {
      background-color: #f2ebff;
      border-color: #6610f2;
    }

    .repair-check-input {
      width: 1.2em;
      height: 1.2em;
      margin-right: 10px;
      cursor: pointer;
    }

    .repair-name {
      font-weight: bold;
      font-size: 0.95rem;
      color: #333;
      flex-grow: 1;
    }

    .repair-price {
      font-size: 0.85rem;
      color: #6c757d;
      white-space: nowrap;
    }

    .queue-card {
      background: white;
      border-left: 6px solid #6c757d;
      border-radius: 8px;
      padding: 10px;
      margin-bottom: 8px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }

    .queue-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 5px;
    }

    .queue-id {
      font-size: 1.2rem;
      font-weight: bold;
      font-family: monospace;
    }

    .quick-note-btn {
      font-size: 0.7rem;
      padding: 3px 8px;
      margin-right: 4px;
      margin-top: 4px;
      border: 1px solid #dc3545;
      color: #dc3545;
      background: white;
      border-radius: 15px;
    }

    .quick-note-btn:active {
      background: #dc3545;
      color: white;
    }

    .submit-float {
      position: fixed;
      bottom: calc(90px + env(safe-area-inset-bottom));
      left: 5%;
      width: 90%;
      padding: 15px;
      font-size: 1.2rem;
      font-weight: bold;
      border-radius: 50px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
      z-index: 1000;
      transition: transform 0.1s;
      border: none;
      color: white;
    }

    .submit-float:active {
      transform: scale(0.98);
    }

    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 70px;
      background-color: #fff;
      border-top: 1px solid #dee2e6;
      display: flex;
      justify-content: space-around;
      align-items: center;
      z-index: 2000;
      padding-bottom: env(safe-area-inset-bottom);
      box-sizing: content-box;
    }

    .nav-item {
      text-align: center;
      color: #6c757d;
      font-size: 0.75rem;
      flex-grow: 1;
      cursor: pointer;
      padding: 5px 0;
    }

    .nav-item i {
      display: block;
      font-size: 1.5rem;
      margin-bottom: 2px;
    }

    .nav-item.active {
      font-weight: bold;
    }

    .nav-item.active[data-mode="è²¸å‡º"] {
      color: #0d6efd;
    }

    .nav-item.active[data-mode="è¿”å´"] {
      color: #198754;
    }

    .nav-item.active[data-mode="å……å¡«"] {
      color: #ffc107;
    }

    .nav-item.active[data-mode="ç ´æå ±å‘Š"] {
      color: #dc3545;
    }

    .nav-item.active[data-mode="ä¿®ç†æ¸ˆã¿"] {
      color: #6610f2;
    }
  </style>
</head>

<body>

  <div id="op-container" class="container-fluid mt-3">
    <div class="d-flex justify-content-end mb-2">
      <button id="btn-refresh" class="btn btn-sm btn-outline-secondary border-0" onclick="refreshMasterData()">
        <i class="bi bi-arrow-clockwise"></i> ãƒªã‚¹ãƒˆæ›´æ–°
      </button>
    </div>

    <div class="card p-3 mb-3 border-0 shadow-sm" style="background:#fff;">
      <div id="op-settings-lend" class="op-setting-panel" style="display:none;">
        <label class="form-label fw-bold small text-primary mb-1">è²¸å‡ºå…ˆ</label>
        <div class="d-flex gap-2">
          <select id="op-dest-select" class="form-select fw-bold flex-grow-1">
            <option value="" disabled selected>èª­ã¿è¾¼ã¿ä¸­...</option>
          </select>
          <button id="btn-self-use" class="btn btn-outline-secondary" onclick="toggleSelfUse()"
            style="white-space: nowrap;">
            <i class="bi bi-building"></i> è‡ªç¤¾
          </button>
        </div>
        <div id="self-use-badge" class="mt-2 text-end" style="display:none;">
          <span class="badge bg-info text-dark"><i class="bi bi-check-circle-fill"></i> è‡ªç¤¾åˆ©ç”¨ã¨ã—ã¦è¨˜éŒ²</span>
        </div>
      </div>

      <div id="op-settings-return" class="op-setting-panel" style="display:none;">
        <div class="selection-panel">
          <div class="check-unused flex-fill">
            <input type="checkbox" id="op-check-unused" class="check-card-input" onchange="toggleReturnCheck('unused')">
            <label for="op-check-unused" class="check-card-label">
              <i class="bi bi-fuel-pump-fill fs-3 mb-1"></i>
              <span class="fw-bold small">æœªä½¿ç”¨</span>
              <span class="small text-muted" style="font-size:0.75rem;">æº€ã‚¿ãƒ³è¿”å´</span>
            </label>
          </div>
          <div class="check-defect flex-fill">
            <input type="checkbox" id="op-check-defect" class="check-card-input" onchange="toggleReturnCheck('defect')">
            <label for="op-check-defect" class="check-card-label">
              <i class="bi bi-exclamation-triangle-fill fs-3 mb-1"></i>
              <span class="fw-bold small">æœªå……å¡«</span>
              <span class="small text-muted" style="font-size:0.75rem;">å……å¡«å¿˜ã‚Œç­‰</span>
            </label>
          </div>
        </div>
      </div>

      <div id="op-settings-repair" class="op-setting-panel" style="display:none;">
        <h6 class="fw-bold text-secondary mb-2 small"><i class="bi bi-tools"></i> ä¿®ç†å†…å®¹ã‚’é¸æŠ</h6>
        <div id="repair-options-container" class="d-grid gap-1">
          <div class="text-muted small">ãƒªã‚¹ãƒˆèª­ã¿è¾¼ã¿ä¸­...</div>
        </div>
        <div class="mt-2 text-end fw-bold text-dark border-top pt-1">
          åˆè¨ˆ: <span id="repair-total-display" class="fs-5 text-primary font-monospace">0</span> å††
        </div>
      </div>

      <div id="op-settings-fill" class="op-setting-panel" style="display:none;">
        <div class="alert alert-warning py-2 text-center mb-0"
          style="background-color:#fff3cd; color:#664d03; border:1px solid #ffecb5; border-radius: 8px;">
          <i class="bi bi-info-circle-fill fs-5 d-inline-block me-1"></i>
          <span class="fw-bold small">å……å¡«å®Œäº†ã¨ã—ã¦è¨˜éŒ²</span>
        </div>
      </div>

      <div id="op-settings-damage" class="op-setting-panel" style="display:none;">
        <div class="alert alert-danger py-2 text-center mb-0"
          style="background-color:#f8d7da; color:#842029; border:1px solid #f5c2c7; border-radius: 8px;">
          <i class="bi bi-exclamation-triangle-fill fs-5 d-inline-block me-1"></i>
          <span class="fw-bold small">ç ´æãƒ»ä¸å‚™ã¨ã—ã¦è¨˜éŒ²</span>
        </div>
      </div>
    </div>

    <div id="op-inputs"></div>

    <div id="op-queue-box" class="mt-4" style="display:none;">
      <div class="d-flex justify-content-between align-items-end mb-2">
        <span class="fw-bold text-dark small"><i class="bi bi-list-check"></i> é€ä¿¡ãƒªã‚¹ãƒˆ (<span
            id="op-queue-count">0</span>)</span>
        <button class="btn btn-sm btn-outline-secondary py-0" style="font-size:0.8rem;"
          onclick="clearOpQueue()">å…¨æ¶ˆå»</button>
      </div>
      <div id="op-queue-list" class="d-grid gap-2"></div>
    </div>
  </div>

  <button id="op-submit-btn" class="submit-float" style="display:none;" onclick="submitOp()">
    <i class="bi bi-send-fill"></i> <span id="op-submit-label">é€ä¿¡</span>
  </button>

  <div class="bottom-nav">
    <div class="nav-item active" onclick="switchMode('è²¸å‡º')" data-mode="è²¸å‡º"><i class="bi bi-box-arrow-right"></i> è²¸å‡º
    </div>
    <div class="nav-item" onclick="switchMode('è¿”å´')" data-mode="è¿”å´"><i class="bi bi-box-arrow-in-left"></i> è¿”å´</div>
    <div class="nav-item" onclick="switchMode('å……å¡«')" data-mode="å……å¡«"><i class="bi bi-droplet-half"></i> å……å¡«</div>
    <div class="nav-item" onclick="switchMode('ä¿®ç†æ¸ˆã¿')" data-mode="ä¿®ç†æ¸ˆã¿"><i class="bi bi-tools"></i> ä¿®ç†</div>
    <div class="nav-item" onclick="switchMode('ç ´æå ±å‘Š')" data-mode="ç ´æå ±å‘Š"><i class="bi bi-exclamation-octagon"></i> ç ´æ
    </div>
  </div>

  <script>
    var opQueue = [];
    var opMode = '';
    var isSelfUseMode = false;
    var repairOptionsCache = [];
    var opPrefixes = [];

    window.onload = function () {
      google.script.url.getLocation(function (location) {
        var action = (location.parameter && location.parameter.action) ? location.parameter.action : "è²¸å‡º";
        initOperations(action);
        loadAllMasterData();
      });
    };

    function loadAllMasterData() {
      google.script.run.withSuccessHandler(function (data) {
        var sel = document.getElementById('op-dest-select');
        if (sel) {
          sel.innerHTML = '';
          var def = document.createElement('option');
          def.text = "ğŸ‘‡ è²¸å‡ºå…ˆã‚’é¸æŠ"; def.value = ""; def.selected = true; def.disabled = true;
          sel.appendChild(def);
          if (data.destList && data.destList.length > 0) {
            data.destList.forEach(function (d) { sel.appendChild(new Option(d, d)); });
          } else { sel.appendChild(new Option("â€»ãƒªã‚¹ãƒˆãªã—", "")); }
        }

        if (data.repairOptions && data.repairOptions.length > 0) {
          repairOptionsCache = data.repairOptions;
          if (opMode === 'ä¿®ç†æ¸ˆã¿') renderRepairCheckboxes();
        } else {
          var roContainer = document.getElementById('repair-options-container');
          if (roContainer) roContainer.innerHTML = '<div class="text-muted p-2 small">â€»ä¿®ç†é …ç›®ãªã—</div>';
        }

        if (data.prefixes && data.prefixes.length > 0) {
          opPrefixes = data.prefixes;
          var btn = document.getElementById('op-submit-btn');
          var currentColor = btn ? btn.style.backgroundColor : '#6c757d';
          renderOpInputs(currentColor || '#6c757d');
        }
      }).getOperationsInitData();
    }

    function initOperations(mode) {
      opMode = mode;
      opQueue = [];
      renderOpQueue();
      var panels = document.getElementsByClassName('op-setting-panel');
      for (var i = 0; i < panels.length; i++) panels[i].style.display = 'none';
      isSelfUseMode = false;
      updateSelfUseUI();

      var color = '#6c757d';
      var btnText = 'é€ä¿¡';

      if (mode === 'è²¸å‡º') {
        document.getElementById('op-settings-lend').style.display = 'block';
        color = '#0d6efd'; btnText = 'è²¸å‡ºå®Ÿè¡Œ';
      } else if (mode === 'è¿”å´') {
        document.getElementById('op-settings-return').style.display = 'block';
        color = '#198754'; btnText = 'è¿”å´å®Ÿè¡Œ';
      } else if (mode === 'å……å¡«') {
        document.getElementById('op-settings-fill').style.display = 'block';
        color = '#ffc107'; btnText = 'å……å¡«å®Œäº†';
      } else if (mode === 'ç ´æå ±å‘Š') {
        document.getElementById('op-settings-damage').style.display = 'block';
        color = '#dc3545'; btnText = 'å ±å‘Šé€ä¿¡';
      } else if (mode === 'ä¿®ç†æ¸ˆã¿') {
        document.getElementById('op-settings-repair').style.display = 'block';
        color = '#6610f2'; btnText = 'ä¿®ç†å®Œäº†';
        if (repairOptionsCache.length > 0) renderRepairCheckboxes();
      }

      var btn = document.getElementById('op-submit-btn');
      if (btn) {
        btn.style.backgroundColor = color;
        document.getElementById('op-submit-label').innerText = btnText;
      }
      document.querySelectorAll('.nav-item').forEach(el => {
        el.classList.remove('active');
        if (el.dataset.mode === mode) el.classList.add('active');
      });
      renderOpInputs(color);
    }

    function refreshMasterData() {
      if (!confirm("æœ€æ–°ã®ãƒªã‚¹ãƒˆã‚’å–å¾—ã—ã¾ã™ã‹ï¼Ÿ")) return;
      var btn = document.getElementById('btn-refresh');
      var orgHtml = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> æ›´æ–°ä¸­';
      google.script.run.withSuccessHandler(function (res) {
        loadAllMasterData(); btn.disabled = false; btn.innerHTML = orgHtml;
      }).withFailureHandler(function (e) {
        alert("æ›´æ–°ã‚¨ãƒ©ãƒ¼: " + e.message); btn.disabled = false; btn.innerHTML = orgHtml;
      }).clearMasterCaches();
    }

    function toggleSelfUse() { isSelfUseMode = !isSelfUseMode; updateSelfUseUI(); renderOpQueue(); }
    function updateSelfUseUI() {
      var sel = document.getElementById('op-dest-select');
      var btn = document.getElementById('btn-self-use');
      var badge = document.getElementById('self-use-badge');
      if (sel && btn && badge) {
        if (isSelfUseMode) {
          sel.disabled = true; btn.className = 'btn btn-info text-dark fw-bold'; badge.style.display = 'block';
          document.getElementById('op-submit-label').innerText = 'åˆ©ç”¨é–‹å§‹';
        } else {
          sel.disabled = false; btn.className = 'btn btn-outline-secondary'; badge.style.display = 'none';
          document.getElementById('op-submit-label').innerText = 'è²¸å‡ºå®Ÿè¡Œ';
        }
      }
    }
    function toggleReturnCheck(type) {
      var unused = document.getElementById('op-check-unused');
      var defect = document.getElementById('op-check-defect');
      if (type === 'unused' && unused.checked) defect.checked = false;
      else if (type === 'defect' && defect.checked) unused.checked = false;
    }
    function renderRepairCheckboxes() {
      var container = document.getElementById('repair-options-container');
      if (!container) return;
      container.innerHTML = '';
      repairOptionsCache.forEach(function (opt, idx) {
        var html = `<label class="repair-list-item" id="rep-item-${idx}">
     <input class="form-check-input repair-check-input" type="checkbox" value="${opt.price}" id="rep-opt-${idx}" data-name="${opt.name}" onchange="toggleRepairItem(${idx})">
     <span class="repair-name">${opt.name}</span><span class="repair-price">${opt.price} å††</span></label>`;
        container.insertAdjacentHTML('beforeend', html);
      });
      calcRepairTotal();
    }
    function toggleRepairItem(idx) {
      var chk = document.getElementById('rep-opt-' + idx);
      var item = document.getElementById('rep-item-' + idx);
      if (chk && item) {
        if (chk.checked) item.classList.add('checked'); else item.classList.remove('checked');
        calcRepairTotal();
      }
    }
    function calcRepairTotal() {
      var total = 0;
      var checks = document.querySelectorAll('#repair-options-container input[type="checkbox"]:checked');
      checks.forEach(function (c) { total += parseInt(c.value) || 0; });
      var disp = document.getElementById('repair-total-display');
      if (disp) disp.innerText = total.toLocaleString();
    }

    function renderOpInputs(color) {
      var div = document.getElementById('op-inputs');
      if (!div) return;
      div.innerHTML = '';
      div.style.display = 'block';
      if (opPrefixes.length === 0) {
        div.innerHTML = '<div class="text-center text-muted py-3"><span class="spinner-border spinner-border-sm"></span> ã‚¿ãƒ³ã‚¯IDãƒªã‚¹ãƒˆèª­ã¿è¾¼ã¿ä¸­...</div>';
        return;
      }
      opPrefixes.forEach(p => {
        div.innerHTML += `<div class="input-row-card d-flex gap-2 mb-2 align-items-center p-2 bg-white rounded shadow-sm" style="border-left: 5px solid ${color};">
     <span class="fs-4 fw-bold" style="width:30px; text-align:center;">${p}</span>
     <input type="tel" class="form-control fw-bold text-center fs-5" maxlength="2" placeholder="--" oninput="checkOpInput('${p}', this)">
     <button class="btn text-white fw-bold" style="background:${color};" onclick="addOpQueue('${p}-OK')">OK</button></div>`;
      });
    }

    function checkOpInput(prefix, el) {
      var val = el.value.replace(/[ï¼-ï¼™]/g, s => String.fromCharCode(s.charCodeAt(0) - 0xFEE0));
      el.value = val;
      if (val.length >= 2) { addOpQueue(prefix + '-' + val); el.value = ''; }
    }

    function addOpQueue(id) {
      if (!opQueue.some(item => item.id === id)) { opQueue.push({ id: id, note: '' }); renderOpQueue(); }
    }
    function updateItemNote(index, text) { opQueue[index].note = text; }
    function appendQuickNote(index, text) {
      var current = opQueue[index].note;
      if (current) text = current + ", " + text;
      opQueue[index].note = text;
      document.getElementById('note-input-' + index).value = text;
    }

    function renderOpQueue() {
      var list = document.getElementById('op-queue-list');
      if (!list) return;
      list.innerHTML = '';
      document.getElementById('op-queue-count').innerText = opQueue.length;
      var box = document.getElementById('op-queue-box');
      var btn = document.getElementById('op-submit-btn');
      var color = btn ? btn.style.backgroundColor : '#6c757d';

      if (opQueue.length > 0) {
        box.style.display = 'block';
        btn.style.display = 'block';
        opQueue.slice().reverse().forEach((item, revIndex) => {
          var index = opQueue.length - 1 - revIndex;
          var quickBtns = (opMode === 'ç ´æå ±å‘Š') ? `<div class="mt-1"><button class="btn quick-note-btn" onclick="appendQuickNote(${index}, 'ãƒãƒ«ãƒ–å›ºãƒ»æ­ªã¿')">ãƒãƒ«ãƒ–å›ºãƒ»æ­ªã¿</button>...</div>` : '';
          if (opMode === 'ç ´æå ±å‘Š') {
            quickBtns = `<div class="mt-1">
         <button class="btn quick-note-btn" onclick="appendQuickNote(${index}, 'ãƒãƒ«ãƒ–å›ºãƒ»æ­ªã¿')">ãƒãƒ«ãƒ–å›ºãƒ»æ­ªã¿</button>
         <button class="btn quick-note-btn" onclick="appendQuickNote(${index}, 'ã‚¨ã‚¢æ¼ã‚Œ')">ã‚¨ã‚¢æ¼ã‚Œ</button>
         <button class="btn quick-note-btn" onclick="appendQuickNote(${index}, 'Oãƒªãƒ³ã‚°')">Oãƒªãƒ³ã‚°</button>
       </div>`;
          }
          var ph = (opMode === 'è²¸å‡º') ? 'æ‹…å½“è€…å(ä»»æ„)' : (opMode === 'ç ´æå ±å‘Š' ? 'ç ´æå†…å®¹' : 'å‚™è€ƒ(ä»»æ„)');
          list.innerHTML += `<div class="queue-card" style="border-left-color: ${color};">
       <div class="queue-card-header"><span class="queue-id">${item.id}</span>
         <button class="btn btn-link text-secondary p-0" onclick="removeOpQueue(${index})"><i class="bi bi-trash3-fill"></i></button></div>
       <div><input type="text" id="note-input-${index}" class="form-control form-control-sm" placeholder="${ph}" value="${item.note}" oninput="updateItemNote(${index}, this.value)">${quickBtns}</div></div>`;
        });
      } else {
        box.style.display = 'none';
        btn.style.display = 'none';
      }
    }

    function removeOpQueue(index) { opQueue.splice(index, 1); renderOpQueue(); }
    function clearOpQueue() { opQueue = []; renderOpQueue(); }

    // â˜…â˜…â˜… ä¿®æ­£: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰é€ä¿¡å¯¾å¿œ â˜…â˜…â˜…
    function submitOp() {
      if (opMode === 'è²¸å‡º' && !isSelfUseMode) {
        var dest = document.getElementById('op-dest-select').value;
        if (!dest || dest === "") { alert("âš ï¸ è²¸å‡ºå…ˆãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚"); return; }
      }
      var confirmMsg = opQueue.length + 'ä»¶ é€ä¿¡ã—ã¾ã™ã‹ï¼Ÿ';
      if (opMode === 'è²¸å‡º' && isSelfUseMode) confirmMsg += '\nï¼ˆè‡ªç¤¾åˆ©ç”¨ã¨ã—ã¦è¨˜éŒ²ã•ã‚Œã¾ã™ï¼‰';
      else if (opMode === 'è²¸å‡º') confirmMsg += '\nè²¸å‡ºå…ˆ: ' + document.getElementById('op-dest-select').value;

      var repairCost = 0; var repairDetail = [];
      if (opMode === 'ä¿®ç†æ¸ˆã¿') {
        var checks = document.querySelectorAll('#repair-options-container input[type="checkbox"]:checked');
        checks.forEach(function (c) {
          repairCost += parseInt(c.value) || 0;
          repairDetail.push(c.getAttribute('data-name'));
        });
        confirmMsg += '\nä¿®ç†è²»ç”¨: ' + repairCost.toLocaleString() + 'å††';
      }
      if (!confirm(confirmMsg)) return;

      var btn = document.getElementById('op-submit-btn');
      var orgText = document.getElementById('op-submit-label').innerText;
      btn.disabled = true; document.getElementById('op-submit-label').innerText = "é€ä¿¡ä¸­...";

      var finalDest = document.getElementById('op-dest-select') ? document.getElementById('op-dest-select').value : "";
      var finalAction = opMode;
      if (opMode === 'è²¸å‡º' && isSelfUseMode) { finalDest = "è‡ªç¤¾åˆ©ç”¨"; finalAction = "è‡ªç¤¾åˆ©ç”¨"; }

      var payload = {
        action: finalAction,
        items: opQueue,
        destination: finalDest,
        isUnused: document.getElementById('op-check-unused') ? document.getElementById('op-check-unused').checked : false,
        isDefect: document.getElementById('op-check-defect') ? document.getElementById('op-check-defect').checked : false,
        repairCost: repairCost,
        repairDetail: repairDetail.join(", "),
        // â˜…è¿½åŠ : ä¿æŒã—ã¦ã„ã‚‹ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’é€ä¿¡
        userPasscode: (typeof GLOBAL_PASSCODE !== 'undefined') ? GLOBAL_PASSCODE : ""
      };

      google.script.run.withSuccessHandler(res => {
        btn.disabled = false; document.getElementById('op-submit-label').innerText = orgText;
        clearOpQueue();
        if (isSelfUseMode) toggleSelfUse();
        if (opMode === 'è²¸å‡º') document.getElementById('op-dest-select').value = "";
        if (document.getElementById('op-check-unused')) document.getElementById('op-check-unused').checked = false;
        if (document.getElementById('op-check-defect')) document.getElementById('op-check-defect').checked = false;
        if (opMode === 'ä¿®ç†æ¸ˆã¿') {
          document.querySelectorAll('#repair-options-container input').forEach(c => { c.checked = false; });
          document.querySelectorAll('.repair-list-item').forEach(el => el.classList.remove('checked'));
          calcRepairTotal();
        }

        var msg = "ã€é€ä¿¡çµæœã€‘\nç·æ•°: " + (res.totalCount || 0) + " æœ¬\n----------------\n";
        if (res.successIds && res.successIds.length > 0) msg += "âœ… æˆåŠŸ (" + res.successIds.length + "æœ¬):\n" + res.successIds.join(", ") + "\n\n";
        else msg += "âœ… æˆåŠŸ: ãªã—\n\n";
        if (res.failedItems && res.failedItems.length > 0) {
          msg += "âŒ å¤±æ•— (" + res.failedItems.length + "æœ¬):\n";
          res.failedItems.forEach(item => msg += "ãƒ»" + item.id + " : " + item.reason + "\n");
        }
        alert(msg);

      }).withFailureHandler(function (e) {
        btn.disabled = false; document.getElementById('op-submit-label').innerText = orgText;
        alert("ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼: " + e);
      }).submitOperations(payload);
    }
  </script>
</body>

</html>