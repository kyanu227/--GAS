<link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;900&family=Noto+Sans+JP:wght@400;700;900&display=swap"
    rel="stylesheet">

<div id="dashboard-container" class="dashboard-wrapper theme-default">
    <div class="pt-4 px-3 pb-3">
        <div class="container-fluid" style="max-width: 600px;">

            <div class="d-flex align-items-center justify-content-between mb-3 px-1">
                <h5 class="fw-bold m-0 text-main d-flex align-items-center text-shadow-sm">
                    <i class="bi bi-speedometer2 me-2 accent-color"></i>ダッシュボード
                </h5>

                <div id="dashboard-edit-controls" class="d-flex gap-2" style="display:none;">
                    <div id="dashboard-action-buttons" style="display:none;" class="fade-in-right">
                        <button class="btn btn-danger btn-sm rounded-pill fw-bold px-3 shadow-sm"
                            onclick="executeDashboardDelete()">
                            <i class="bi bi-trash-fill me-1"></i> 削除
                        </button>
                        <button class="glass-btn btn-sm rounded-circle d-flex align-items-center justify-content-center"
                            style="width:32px;height:32px;padding:0;" onclick="toggleDashboardEditMode()">
                            <i class="bi bi-x fs-5"></i>
                        </button>
                    </div>
                    <button id="btn-dashboard-edit-mode"
                        class="glass-btn btn-sm border-0 rounded-pill px-3 fw-bold shadow-sm"
                        onclick="toggleDashboardEditMode()">
                        編集
                    </button>
                </div>
            </div>

            <div id="dashboard-log-panel-container" class="card border-0 shadow-lg rounded-4 overflow-hidden log-panel"
                style="min-height: 400px; margin-bottom: 80px;">

                <div class="card-header border-bottom border-theme p-3"
                    style="background-color: var(--tab-inactive-bg);">
                    <ul class="nav nav-pills nav-fill p-1 rounded-3 border border-theme shadow-sm"
                        style="background-color: var(--log-bg);">
                        <li class="nav-item">
                            <button id="nav-btn-db-summary" class="nav-link fw-bold small text-main active"
                                onclick="switchDashboardTab('summary')">
                                <i class="bi bi-pie-chart-fill me-1"></i> 集計
                            </button>
                        </li>
                        <li class="nav-item">
                            <button id="nav-btn-db-today" class="nav-link fw-bold small text-main"
                                onclick="switchDashboardTab('today')">
                                <i class="bi bi-list-ul me-1"></i> 本日詳細
                            </button>
                        </li>
                        <li class="nav-item">
                            <button id="nav-btn-db-weekly" class="nav-link fw-bold small text-main"
                                onclick="switchDashboardTab('weekly')">
                                <i class="bi bi-calendar-week me-1"></i> 週間履歴
                            </button>
                        </li>
                    </ul>
                </div>

                <div class="card-body p-0 tab-content custom-scroll"
                    style="height: 60vh; min-height: 400px; overflow-y: auto; background-color: var(--log-bg);">

                    <div class="tab-pane fade show active" id="pane-db-summary">
                        <div class="p-3">
                            <div id="db-summary-container" class="d-flex flex-column gap-3">
                                <div class="text-center py-5">
                                    <div class="spinner-border accent-color" role="status"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="tab-pane fade" id="pane-db-today">
                        <div class="sticky-top border-bottom border-theme p-2 d-flex gap-2 overflow-auto no-scrollbar"
                            style="background-color: var(--log-bg); z-index: 5;">
                            <button class="chip-filter active" data-filter="ALL"
                                onclick="setDashboardOpFilter('ALL')">すべて</button>
                            <button class="chip-filter" data-filter="貸出"
                                onclick="setDashboardOpFilter('貸出')">貸出</button>
                            <button class="chip-filter" data-filter="返却"
                                onclick="setDashboardOpFilter('返却')">返却</button>
                            <button class="chip-filter" data-filter="充填"
                                onclick="setDashboardOpFilter('充填')">充填</button>
                        </div>
                        <div id="list-db-today" class="list-group list-group-flush pb-3"></div>
                    </div>

                    <div class="tab-pane fade" id="pane-db-weekly">
                        <div id="db-weekly-date-bar"
                            class="sticky-top border-bottom border-theme p-2 d-flex gap-2 overflow-auto no-scrollbar"
                            style="background-color: var(--log-bg); z-index: 5;">
                        </div>
                        <div id="list-db-weekly" class="list-group list-group-flush pb-3"></div>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* --- 基本設定 --- */
    .dashboard-wrapper {
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        background-color: #f3f4f6;
    }

    .font-num {
        font-family: 'Inter', sans-serif;
        font-feature-settings: "tnum";
        letter-spacing: -0.5px;
    }

    .text-shadow-sm {
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
    }

    .no-scrollbar::-webkit-scrollbar {
        display: none;
    }

    .custom-scroll::-webkit-scrollbar {
        width: 4px;
    }

    .custom-scroll::-webkit-scrollbar-thumb {
        background-color: rgba(128, 128, 128, 0.3);
        border-radius: 2px;
    }

    /* テーマカラー定義 */
    .theme-default {
        --app-bg: #f3f4f6;
        --log-bg: #fff;
        --text-main: #333;
        --text-card: #fff;
        --accent: #3b82f6;
        --border: rgba(0, 0, 0, 0.1);
        --glass-bg: rgba(0, 0, 0, 0.05);
        --glass-active: rgba(0, 0, 0, 0.1);
        --tab-inactive-bg: #f8f9fa;
    }

    .text-main {
        color: var(--text-main);
    }

    .accent-color {
        color: var(--accent);
    }

    .border-theme {
        border-color: var(--border) !important;
    }

    /* ログパネル・リスト */
    .log-panel {
        background: var(--log-bg);
        border: 1px solid var(--border);
        transition: background 0.5s ease;
    }

    .glass-btn {
        background: var(--glass-bg);
        color: var(--text-main);
        border: 1px solid var(--border);
        transition: all 0.2s;
    }

    .glass-btn:hover {
        background: var(--glass-active);
    }

    .nav-pills .nav-link {
        color: var(--text-main);
        opacity: 0.6;
        background: transparent;
        border-radius: 6px;
        transition: all 0.2s;
    }

    .nav-pills .nav-link:hover {
        background-color: var(--glass-bg);
    }

    .nav-pills .nav-link.active {
        background-color: var(--glass-active);
        color: var(--accent);
        font-weight: 800;
        opacity: 1;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        border: 1px solid var(--border);
    }

    .chip-filter {
        padding: 6px 14px;
        border-radius: 20px;
        border: 1px solid var(--border);
        background: var(--tab-inactive-bg);
        color: var(--text-main);
        font-size: 0.8rem;
        font-weight: 600;
        white-space: nowrap;
        transition: all 0.2s;
        opacity: 0.8;
    }

    .chip-filter:hover {
        opacity: 1;
        transform: translateY(-1px);
    }

    .chip-filter.active {
        background: var(--accent);
        color: #fff;
        border-color: var(--accent);
        opacity: 1;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    }

    .list-group-item {
        background-color: transparent !important;
        border: none;
        border-bottom: 1px solid var(--border);
        padding: 12px 16px;
        display: flex;
        align-items: center;
        color: var(--text-main);
        transition: background 0.1s;
    }

    .list-group-item:last-child {
        border-bottom: none;
    }

    .check-wrapper {
        width: 0;
        overflow: hidden;
        transition: width 0.2s ease;
        display: flex;
        align-items: center;
    }

    .mode-edit .check-wrapper {
        width: 36px;
        margin-right: 4px;
    }

    .custom-check {
        width: 20px;
        height: 20px;
        cursor: pointer;
        accent-color: #dc3545;
    }

    .tank-badge-mini {
        font-family: monospace;
        font-weight: 700;
        font-size: 0.8rem;
        background: var(--tab-inactive-bg);
        padding: 2px 6px;
        border-radius: 4px;
        color: var(--text-main);
        border: 1px solid var(--border);
    }

    .fade-in-right {
        animation: fadeInRight 0.3s ease;
    }
</style>

<script>
    var dbCache = { today: [], weekly: [], all: [] };
    var dbCurrentFilter = 'ALL';
    var dbCurrentTabId = 'summary';
    var dbSelectedDate = 'ALL';
    var dbIsEditMode = false;

    function loadDashboardData(passcode) {
        var pass = passcode || ((typeof window.GLOBAL_PASSCODE !== 'undefined') ? window.GLOBAL_PASSCODE : "");

        // マイページのデータを借用してダッシュボードに描画する
        google.script.run
            .withSuccessHandler(renderDashboard)
            .withFailureHandler(e => alert("読み込みエラー: " + e.message))
            .getMyStats(pass);
    }

    function renderDashboard(data) {
        if (!data) return;

        dbCache.today = data.todayLog || [];
        dbCache.weekly = data.weeklyLog || [];

        renderDashboardDateBar();
        switchDashboardTab(dbCurrentTabId);
    }

    function switchDashboardTab(tabId) {
        dbCurrentTabId = tabId;

        if (dbIsEditMode) toggleDashboardEditMode();

        document.querySelectorAll('#dashboard-log-panel-container .nav-link').forEach(btn => btn.classList.remove('active'));
        var activeBtn = document.getElementById('nav-btn-db-' + tabId);
        if (activeBtn) activeBtn.classList.add('active');

        document.querySelectorAll('#dashboard-log-panel-container .tab-pane').forEach(p => p.classList.remove('active', 'show'));
        var activePane = document.getElementById('pane-db-' + tabId);
        if (activePane) activePane.classList.add('active', 'show');

        var controls = document.getElementById('dashboard-edit-controls');
        if (tabId === 'summary') {
            controls.style.display = 'none';
        } else {
            controls.style.display = 'flex';
        }

        refreshDashboardLists();
    }

    function setDashboardOpFilter(mode, btn) {
        dbCurrentFilter = mode;
        document.querySelectorAll('#pane-db-today .chip-filter[data-filter]').forEach(b => b.classList.remove('active'));
        document.querySelectorAll(`#pane-db-today .chip-filter[data-filter="${mode}"]`).forEach(b => b.classList.add('active'));
        refreshDashboardLists();
    }

    function renderDashboardDateBar() {
        var bar = document.getElementById('db-weekly-date-bar');
        bar.innerHTML = '<button class="chip-filter active" data-date="ALL" onclick="setDashboardDateFilter(\'ALL\')">すべて</button>';
        var dates = [...new Set(dbCache.weekly.map(item => item.dateDisplay))];
        dates.forEach(d => {
            bar.insertAdjacentHTML('beforeend', `<button class="chip-filter" data-date="${d}" onclick="setDashboardDateFilter('${d}')">${d}</button>`);
        });
    }

    function setDashboardDateFilter(date) {
        dbSelectedDate = date;
        document.querySelectorAll('#db-weekly-date-bar .chip-filter').forEach(b => b.classList.remove('active'));
        var btn = document.querySelector(`#db-weekly-date-bar .chip-filter[data-date="${date}"]`);
        if (btn) btn.classList.add('active');
        refreshDashboardLists();
    }

    function refreshDashboardLists() {
        if (dbCurrentTabId === 'summary') {
            renderDashboardSummary();
        } else if (dbCurrentTabId === 'today') {
            renderDashboardLogList('list-db-today', filterDashboardLogs(dbCache.today));
        } else if (dbCurrentTabId === 'weekly') {
            var logs = filterDashboardLogs(dbCache.weekly);
            if (dbSelectedDate !== 'ALL') logs = logs.filter(l => l.dateDisplay === dbSelectedDate);
            renderDashboardLogList('list-db-weekly', logs);
        }
    }

    function filterDashboardLogs(logs) {
        if (dbCurrentFilter === 'ALL') return logs;
        return logs.filter(l => l.action.indexOf(dbCurrentFilter) !== -1);
    }

    function renderDashboardSummary() {
        var container = document.getElementById('db-summary-container');
        container.innerHTML = '';
        var logs = dbCache.today;

        if (logs.length === 0) {
            container.innerHTML = '<div class="text-center py-5 opacity-75 small text-main">本日のデータがありません</div>';
            return;
        }

        var data = {
            '貸出': { count: 0, details: {} },
            '返却': { count: 0, details: {} },
            '充填': { count: 0, details: {} },
            '破損': { count: 0, details: {} },
            '修理': { count: 0, details: {} }
        };

        logs.forEach(l => {
            var action = l.action;
            var type = null;
            if (action.includes('貸出')) type = '貸出';
            else if (action.includes('返却')) type = '返却';
            else if (action.includes('充填')) type = '充填';
            else if (action.includes('破損')) type = '破損';
            else if (action.includes('修理')) type = '修理';

            if (type) {
                data[type].count++;
                var loc = l.loc || '場所不明';
                if (type === '返却' && l.note) {
                    loc = l.note.replace(/[()]/g, '').replace('より返却', '').trim();
                }
                if (type === '貸出' || type === '返却') {
                    data[type].details[loc] = (data[type].details[loc] || 0) + 1;
                }
            }
        });

        function createSection(title, icon, colorClass, info) {
            if (info.count === 0) return '';
            var html = `<div class="mb-2 border rounded-3 overflow-hidden" style="background:var(--tab-inactive-bg); border-color:var(--border)!important;">
       <div class="p-2 px-3 d-flex justify-content-between align-items-center bg-white border-bottom border-theme">
          <div class="fw-bold ${colorClass}"><i class="bi ${icon} me-2"></i>${title}</div>
          <div class="fw-900 font-num">${info.count} <span class="small fw-normal opacity-75">本</span></div>
       </div>
       <div class="bg-white">`;
            var details = info.details;
            var keys = Object.keys(details);
            if (keys.length > 0) {
                keys.forEach(k => {
                    html += `<div class="d-flex justify-content-between px-3 py-2 border-bottom border-theme last-no-border small">
            <span class="text-main opacity-75">${k}</span>
            <span class="font-num fw-bold">${details[k]}</span>
          </div>`;
                });
            } else {
                html += `<div class="px-3 py-2 small text-muted text-end">合計 ${info.count} 本</div>`;
            }
            html += `</div></div>`;
            return html;
        }

        var html = '';
        html += createSection('貸出', 'bi-box-arrow-up', 'text-primary', data['貸出']);
        html += createSection('返却', 'bi-box-arrow-in-down', 'text-success', data['返却']);
        html += createSection('充填', 'bi-fuel-pump-fill', 'text-warning', data['充填']);
        html += createSection('破損', 'bi-exclamation-triangle-fill', 'text-danger', data['破損']);
        html += createSection('修理', 'bi-tools', 'text-info', data['修理']);
        container.innerHTML = html;
    }

    function renderDashboardLogList(elementId, logs) {
        var container = document.getElementById(elementId);
        container.innerHTML = logs.length ? '' : '<div class="text-center py-5 opacity-75 small text-main">データなし</div>';

        logs.forEach(item => {
            var color = 'secondary';
            if (item.action.indexOf('貸出') !== -1) color = 'primary';
            else if (item.action.indexOf('返却') !== -1) color = 'success';
            else if (item.action.indexOf('充填') !== -1) color = 'warning';
            var locText = item.loc;
            if (item.action.indexOf('返却') !== -1 && item.note) locText = item.note;

            container.insertAdjacentHTML('beforeend', `
       <label class="list-group-item" style="cursor:pointer;">
         <div class="check-wrapper">
           <input type="checkbox" class="custom-check dashboard-delete-check" value="${item.uuid}">
         </div>
         <div class="d-flex align-items-center w-100">
           <div class="me-3 text-center opacity-75" style="min-width:40px;">
             <div class="font-num fw-bold text-main" style="font-size:0.85rem; line-height:1;">${item.time}</div>
           </div>
           <div class="flex-grow-1">
             <div class="d-flex align-items-center mb-1">
               <span class="badge bg-${color} me-2" style="font-size:0.7rem;">${item.action}</span>
               <span class="tank-badge-mini font-num">${item.tankId}</span>
             </div>
             <div class="small fw-bold text-main text-truncate" style="max-width:180px;">
               ${locText || '-'}
             </div>
           </div>
         </div>
       </label>
     `);
        });
    }

    function toggleDashboardEditMode() {
        dbIsEditMode = !dbIsEditMode;
        var actions = document.getElementById('dashboard-action-buttons');
        var btn = document.getElementById('btn-dashboard-edit-mode');
        var panel = document.getElementById('dashboard-log-panel-container');

        if (dbIsEditMode) {
            actions.style.display = 'flex';
            btn.classList.add('glass-active');
            btn.innerText = '完了';
            panel.classList.add('mode-edit');
        } else {
            actions.style.display = 'none';
            btn.classList.remove('glass-active');
            btn.innerText = '編集';
            panel.classList.remove('mode-edit');
            document.querySelectorAll('.dashboard-delete-check').forEach(c => c.checked = false);
        }
    }

    function executeDashboardDelete() {
        var checks = document.querySelectorAll('.dashboard-delete-check:checked');
        if (checks.length === 0) return;
        if (!confirm('選択した ' + checks.length + ' 件の履歴を削除しますか？\n(在庫ステータスは戻りません)')) return;

        var uuids = Array.from(checks).map(c => c.value);
        var pass = (typeof window.GLOBAL_PASSCODE !== 'undefined') ? window.GLOBAL_PASSCODE : "";

        var btn = document.querySelector('#dashboard-action-buttons button.btn-danger');
        var originalText = btn.innerHTML;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 削除中...';
        btn.disabled = true;

        google.script.run
            .withSuccessHandler(function (res) {
                alert(res.message);
                btn.innerHTML = originalText;
                btn.disabled = false;
                toggleDashboardEditMode();
                loadDashboardData(pass);
            })
            .withFailureHandler(function (e) {
                alert("削除エラー: " + e.message);
                btn.innerHTML = originalText;
                btn.disabled = false;
            })
            .batchDeleteMyLog({ uuids: uuids, userPasscode: pass });
    }
</script>