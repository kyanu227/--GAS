<!-- Admin_Part_Sales.html -->
<h4 class="section-title">SALES ANALYTICS</h4>
<div class="row">
    <div class="col-md-4 mb-3">
        <div class="admin-card">
            <h6 class="text-red mb-3">当月 売上(暫定)</h6>
            <div class="card-value mb-1" id="sales-month-total">--</div>
            <div id="sales-mom-ratio" class="small text-muted">前月比 --%</div>
        </div>
    </div>
    <div class="col-md-4 mb-3">
        <div class="admin-card" style="border-left: 4px solid #198754;">
            <h6 class="text-success mb-3">当月 純利益</h6>
            <div class="card-value mb-1 text-success" id="sales-month-profit">--</div>
            <div class="small text-muted">売上 - (経費+報酬)</div>
        </div>
    </div>
    <div class="col-md-4 mb-3">
        <div class="admin-card" style="border-left: 4px solid #dc3545;">
            <h6 class="text-danger mb-3">未充填・未使用率</h6>
            <div class="card-value mb-1 text-danger" id="sales-error-ratio">--%</div>
            <div class="small text-muted">出庫前の不備発生率</div>
        </div>
    </div>
</div>
<div class="row">
    <div class="col-md-6 mb-3">
        <div class="admin-card">
            <h6 class="text-red mb-3">アクション別 売上割合</h6>
            <canvas id="chart-sales-action" height="150"></canvas>
        </div>
    </div>
    <div class="col-md-6 mb-3">
        <div class="admin-card">
            <h6 class="mb-3">取引先別 トップ5</h6>
            <ul class="list-group list-group-flush bg-transparent" id="sales-dest-list">
                <li class="list-group-item bg-transparent text-muted text-center pt-4">読み込み中...</li>
            </ul>
        </div>
    </div>
</div>

<script>
    // DOMロード後に呼ばれる関数
    document.addEventListener("DOMContentLoaded", function () {
        loadDetailedSales();
    });

    function loadDetailedSales() {
        google.script.run
            .withSuccessHandler(function (data) {
                if (!data.success) {
                    document.getElementById('sales-month-total').innerText = "取得エラー";
                    return;
                }

                // 1. 売上合計、利益、エラー率
                document.getElementById('sales-month-total').innerText = '¥' + data.currentMonthTotal.toLocaleString();
                document.getElementById('sales-month-profit').innerText = '¥' + data.currentMonthProfit.toLocaleString();
                document.getElementById('sales-error-ratio').innerText = data.errorRatio + '%';

                var momEl = document.getElementById('sales-mom-ratio');
                if (data.momRatio > 0) {
                    momEl.innerHTML = '<i class="bi bi-arrow-up text-success"></i> 前月比 <span class="text-success">+' + data.momRatio + '%</span>';
                } else if (data.momRatio < 0) {
                    momEl.innerHTML = '<i class="bi bi-arrow-down text-danger"></i> 前月比 <span class="text-danger">' + data.momRatio + '%</span>';
                } else {
                    momEl.innerText = "前月比 ±0%";
                }

                // 2. アクション別円グラフ
                renderActionChart(data.actionBreakdown.labels, data.actionBreakdown.data);

                // 3. 取引先リスト
                var destListEl = document.getElementById('sales-dest-list');
                destListEl.innerHTML = '';
                if (data.topDestinations.length === 0) {
                    destListEl.innerHTML = '<li class="list-group-item bg-transparent text-muted">データがありません</li>';
                } else {
                    data.topDestinations.forEach(function (item) {
                        var dmgHtml = item.damageCoef > 0 ? `<span class="badge bg-danger ms-2">破損率 ${item.damageCoef}%</span>` : `<span class="badge bg-secondary ms-2 opacity-50">破損 0%</span>`;
                        var li = document.createElement('li');
                        li.className = 'list-group-item bg-transparent border-secondary text-white d-flex justify-content-between align-items-center';
                        li.innerHTML = `
              <span>
                <i class="bi bi-building me-2 text-muted"></i>
                <span class="fw-bold fs-6">${item.name}</span>
                ${dmgHtml}
              </span>
              <span class="text-end">
                <span class="d-block fw-bold fs-5 text-info">¥${item.sales.toLocaleString()}</span>
                <small class="text-muted">${item.count}回 接触</small>
              </span>
            `;
                        destListEl.appendChild(li);
                    });
                }
            })
            .getAdminSalesData();
    }

    var actionChartObj = null;
    function renderActionChart(labels, data) {
        if (actionChartObj) actionChartObj.destroy();

        var ctx = document.getElementById('chart-sales-action');
        if (!ctx) return;

        actionChartObj = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: ['#d32f2f', '#ff5252', '#ff8a80', '#b71c1c', '#333333'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '70%',
                plugins: {
                    legend: { position: 'right', labels: { color: '#e0e0e0', boxWidth: 12 } }
                }
            }
        });
    }
</script>