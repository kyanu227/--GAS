<!DOCTYPE html>
<html>

<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
  <style>
    body {
      background-color: #f8f9fa;
      padding-bottom: 180px;
    }

    body.dial-lock {
      overflow: hidden !important;
      position: fixed !important;
      width: 100% !important;
      overscroll-behavior-y: none !important;
    }

    .selection-panel {
      display: flex;
      gap: 10px;
    }

    .check-card-input {
      display: none;
    }

    .check-card-label {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 6px 5px;
      border: 1px solid #ced4da;
      border-radius: 8px;
      background: #fff;
      cursor: pointer;
      transition: all 0.2s ease;
      height: 100%;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }

    .check-unused .check-card-input:checked+.check-card-label {
      background-color: #e8f5e9;
      border-color: #198754;
      color: #198754;
      box-shadow: 0 0 0 1px #198754;
    }

    .check-defect .check-card-input:checked+.check-card-label {
      background-color: #fff5f5;
      border-color: #dc3545;
      color: #dc3545;
      box-shadow: 0 0 0 1px #dc3545;
    }

    .bulk-card {
      background: #fff;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      padding: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }

    .bulk-id {
      font-size: 1.2rem;
      font-weight: bold;
      font-family: monospace;
      color: #333;
    }

    .bulk-tag-btn {
      font-size: 0.8rem;
      padding: 4px 10px;
      border: 1px solid #ced4da;
      background: #fff;
      color: #6c757d;
      border-radius: 20px;
      margin-left: 5px;
      font-weight: bold;
    }

    .bulk-tag-btn.active-unused {
      background: #198754;
      color: #fff;
      border-color: #198754;
    }

    .bulk-tag-btn.active-defect {
      background: #dc3545;
      color: #fff;
      border-color: #dc3545;
    }

    .queue-card {
      background: white;
      border-left: 4px solid #6c757d;
      border-radius: 10px;
      padding: 10px;
      margin-bottom: 6px;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.04);
    }

    .queue-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 5px;
    }

    .queue-id {
      font-size: 1.2rem;
      font-weight: bold;
      font-family: monospace;
    }

    .quick-note-btn {
      font-size: 0.7rem;
      padding: 3px 8px;
      margin-right: 4px;
      margin-top: 4px;
      border: 1px solid #dc3545;
      color: #dc3545;
      background: white;
      border-radius: 15px;
    }

    .quick-note-btn:active {
      background: #dc3545;
      color: white;
    }

    .op-setting-panel {
      min-height: 50px;
    }

    /* Rotary Linear Drumroll Mode Styles */
    .rotary-container {
      position: absolute;
      right: 0;
      top: 60px;
      bottom: 5px;
      width: 90px;
      pointer-events: none;
      z-index: 100;
      overflow: hidden;
    }

    .rotary-item {
      position: absolute;
      width: 46px;
      height: 46px;
      border-radius: 50%;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(240, 242, 245, 0.95));
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      color: #444;
      font-size: 1.3rem;
      font-weight: 800;
      display: flex;
      align-items: center;
      justify-content: center;
      left: 22px;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08), inset 0 1px 0 rgba(255, 255, 255, 0.8);
      border: 1px solid rgba(0, 0, 0, 0.06);
      transition: background-color 0.2s ease, color 0.2s ease, box-shadow 0.2s ease, opacity 0.2s ease;
      user-select: none;
      cursor: pointer;
      pointer-events: auto;
      letter-spacing: -0.02em;
    }

    .rotary-item.active {
      transform: scale(1.35);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2), 0 0 0 3px rgba(255, 255, 255, 0.5);
      border-color: transparent;
      z-index: 110;
      font-weight: 900;
    }

    .rotary-touch-area {
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      right: 0;
      z-index: 80;
      touch-action: none !important;
      -webkit-touch-callout: none;
      overscroll-behavior: none;
    }

    #rotary-queue-display {
      position: absolute;
      left: 8px;
      top: 8px;
      bottom: 10px;
      right: 100px;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border-radius: 16px;
      padding: 12px;
      padding-bottom: 60px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06), inset 0 0 0 1px rgba(255, 255, 255, 0.5);
      border: 1px solid rgba(0, 0, 0, 0.04);
      touch-action: pan-y;
      z-index: 95;
    }

    #dial-submit-btn {
      position: absolute;
      bottom: 14px;
      left: 12px;
      right: 104px;
      width: auto;
      border-radius: 14px;
      padding: 12px;
      font-size: 1rem;
      font-weight: 800;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.12);
      z-index: 150;
      transition: transform 0.15s, box-shadow 0.15s;
      letter-spacing: 0.02em;
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
    }

    #dial-submit-btn:active {
      transform: scale(0.96);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    }

    @keyframes popPulse {
      0% {
        transform: scale(1);
      }

      50% {
        transform: scale(1.1);
      }

      100% {
        transform: scale(1);
      }
    }

    .pop-anim {
      animation: popPulse 0.2s ease-out;
    }
  </style>
</head>

<body>

  <div id="op-container" class="container-fluid mt-3 d-flex flex-column"
    style="height: calc(100dvh - 120px - env(safe-area-inset-bottom));">
    <div class="d-flex justify-content-end align-items-center mb-2 flex-shrink-0">
      <button id="btn-refresh" class="btn btn-sm btn-outline-secondary border-0" onclick="refreshMasterData()">
        <i class="bi bi-arrow-clockwise"></i> ãƒªã‚¹ãƒˆæ›´æ–°
      </button>
    </div>

    <!-- Settings panels -->
    <div id="op-settings-card" class="card p-3 mb-2 border-0 shadow-sm flex-shrink-0" style="background:#fff;">
      <div id="op-settings-lend" class="op-setting-panel" style="display:none;">
        <label class="form-label fw-bold small text-primary mb-1">è²¸å‡ºå…ˆ</label>
        <div class="d-flex gap-2">
          <select id="op-dest-select" class="form-select form-select-sm fw-bold flex-grow-1">
            <option value="" disabled selected>èª­ã¿è¾¼ã¿ä¸­...</option>
          </select>
          <button id="btn-self-use" class="btn btn-sm btn-outline-secondary" onclick="toggleSelfUse()"
            style="white-space: nowrap;">
            <i class="bi bi-building"></i> è‡ªç¤¾
          </button>
        </div>
        <div id="self-use-badge" class="mt-2 text-end" style="display:none;">
          <span class="badge bg-info text-dark"><i class="bi bi-check-circle-fill"></i> è‡ªç¤¾åˆ©ç”¨ã¨ã—ã¦è¨˜éŒ²</span>
        </div>
      </div>
      <div id="op-settings-return" class="op-setting-panel" style="display:none;">
        <div class="selection-panel">
          <div class="check-unused flex-fill">
            <input type="checkbox" id="op-check-unused" class="check-card-input" onchange="toggleReturnCheck('unused')">
            <label for="op-check-unused" class="check-card-label">
              <i class="bi bi-fuel-pump-fill fs-4 mb-0"></i>
              <span class="fw-bold small">æœªä½¿ç”¨</span>
            </label>
          </div>
          <div class="check-defect flex-fill">
            <input type="checkbox" id="op-check-defect" class="check-card-input" onchange="toggleReturnCheck('defect')">
            <label for="op-check-defect" class="check-card-label">
              <i class="bi bi-exclamation-triangle-fill fs-4 mb-0"></i>
              <span class="fw-bold small">æœªå……å¡«</span>
            </label>
          </div>
        </div>
      </div>
      <div id="op-settings-fill" class="op-setting-panel" style="display:none;">
        <div class="text-muted small mt-2 mb-1">
          <i class="bi bi-info-circle text-warning"></i> å……å¡«ã—ãŸã‚¿ãƒ³ã‚¯ã®IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚
        </div>
      </div>
      <div id="op-settings-bulk-return" class="op-setting-panel" style="display:none;">
        <div class="d-flex justify-content-between align-items-end mb-2">
          <h6 class="fw-bold text-secondary mb-0"><i class="bi bi-building-down"></i> è‡ªç¤¾ä½¿ç”¨ä¸­ã‚¿ãƒ³ã‚¯</h6>
          <button class="btn btn-sm btn-outline-secondary py-0" style="font-size:0.8rem;"
            onclick="loadBulkReturnList()"><i class="bi bi-arrow-clockwise"></i> å†å–å¾—</button>
        </div>
        <div id="bulk-return-list" class="d-grid gap-1 mt-3">
          <div class="text-center text-muted p-3"><span class="spinner-border spinner-border-sm"></span> å–å¾—ä¸­...</div>
        </div>
      </div>
    </div>

    <!-- Dial mode (fills remaining space) -->
    <div id="op-dial-mode" class="flex-grow-1"
      style="display:none; position:relative; overflow:hidden; min-height:0; background: linear-gradient(180deg, #f0f2f5 0%, #e4e6e9 100%); border-radius: 16px 16px 0 0;">
      <div id="rotary-queue-display">
        <div class="d-flex justify-content-between align-items-center mb-2 border-bottom pb-2">
          <span class="fw-bold text-dark small">
            <i class="bi bi-list-check"></i> é€ä¿¡ãƒªã‚¹ãƒˆ
            <span id="rotary-queue-count" class="badge bg-primary ms-1"
              style="font-size: 0.85rem; padding: 0.35em 0.65em;">0</span>
          </span>
          <button class="btn btn-sm btn-outline-secondary py-0" style="font-size:0.75rem;"
            onclick="clearOpQueue()">å…¨æ¶ˆå»</button>
        </div>
        <div id="rotary-queue-list" class="d-grid gap-2">
          <div class="text-muted small text-center mt-3">ã¾ã ã‚­ãƒ¥ãƒ¼ã«è¿½åŠ ã•ã‚Œã¦ã„ã¾ã›ã‚“</div>
        </div>
      </div>
      <button id="dial-submit-btn" class="btn" style="display:none;" onclick="submitOp()">
        <i class="bi bi-send-fill"></i> <span id="dial-submit-label">é€ä¿¡</span>
      </button>
      <div id="dial-ok-wrapper" style="position: absolute; right: 5px; top: 8px; width: 80px; z-index: 130;">
        <button id="dial-ok-btn" class="btn fw-bold px-2 py-2 w-100" onclick="submitActiveOk()"
          style="font-size: 0.85rem; border-radius: 12px; color:#fff; background:#0d6efd; font-weight:800; box-shadow: 0 3px 12px rgba(0,0,0,0.15);">
          <span id="dial-ok-label">OKå…¥åŠ›</span>
        </button>
      </div>
      <input type="tel" id="rotary-hidden-input" style="position:absolute; top:-1000px; left:-1000px; opacity:0;"
        maxlength="2" oninput="checkRotaryInput(this)">
      <div id="rotary-touch-area" class="rotary-touch-area"></div>
      <div id="rotary-wheel-container" class="rotary-container">
        <div id="dial-wheel"></div>
      </div>
    </div>
  </div>


  <script>
    var opQueue = [];
    var opMode = '';
    var isSelfUseMode = false;
    var opPrefixes = [];
    var bulkReturnTanks = [];
    var repairOptionsCache = [];
    window.tankMapCache = null;

    // æ“ä½œãƒ«ãƒ¼ãƒ«å®šç¾©: è¨±å®¹ã™ã‚‹ç›´å‰ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
    const OP_RULES = {
      'è²¸å‡º': ['å……å¡«æ¸ˆã¿', 'ä¿ç®¡ä¸­'],
      'è‡ªç¤¾åˆ©ç”¨': ['å……å¡«æ¸ˆã¿', 'ä¿ç®¡ä¸­'],
      'è¿”å´': ['è²¸å‡ºä¸­', 'æœªè¿”å´', 'è‡ªç¤¾åˆ©ç”¨ä¸­'],
      'è‡ªç¤¾ä¸€æ‹¬è¿”å´': ['è‡ªç¤¾åˆ©ç”¨ä¸­'],
      'å……å¡«': ['ç©º'],
      'ç ´æå ±å‘Š': [], // Any
      'ä¿®ç†æ¸ˆã¿': ['ç ´æ', 'ä¸è‰¯', 'æ•…éšœ']
    };
    const SPECIAL_STATUSES = ["", "æ–°è¦ç™»éŒ²", "ä¸æ˜", "ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹å®Œäº†"];

    // Initialization is now managed by initAppView in index.html
    function triggerInitialDataLoad(action) {
      initOperations(action);
      loadAllMasterData();
      // ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆã‚’æ—©æœŸç™»éŒ²ï¼ˆãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å‰ã§ã‚‚åå¿œã™ã‚‹ã‚ˆã†ã«ï¼‰
      registerDialTouch();
    }

    function loadAllMasterData() {
      google.script.run.withSuccessHandler(function (data) {
        try {
          var sel = document.getElementById('op-dest-select');
          if (sel) {
            sel.innerHTML = '';
            var def = document.createElement('option');
            def.text = "ğŸ‘‡ è²¸å‡ºå…ˆã‚’é¸æŠ"; def.value = ""; def.selected = true; def.disabled = true;
            sel.appendChild(def);
            if (data.destList && data.destList.length > 0) {
              data.destList.forEach(function (d) { sel.appendChild(new Option(d, d)); });
            } else { sel.appendChild(new Option("â€»ãƒªã‚¹ãƒˆãªã—", "")); }
          }

          if (data.repairOptions && data.repairOptions.length > 0) {
            repairOptionsCache = data.repairOptions;
            if (opMode === 'ä¿®ç†æ¸ˆã¿') renderRepairCheckboxes();
          } else {
            var roContainer = document.getElementById('repair-options-container');
            if (roContainer) roContainer.innerHTML = '<div class="text-muted p-2 small">â€»ä¿®ç†é …ç›®ãªã—</div>';
          }

          if (data.prefixes && data.prefixes.length > 0) {
            opPrefixes = data.prefixes;
            var color = getModeColor();
            renderDialMode(color);
          }

          if (data.tankMap) {
            window.tankMapCache = data.tankMap;
          }

          // Re-render the queue in case data loaded after items were added
          renderOpQueue();
        } catch (e) {
          alert('Error in loadAllMasterData UI setup: ' + e.message);
        }
      }).getOperationsInitData();
    }

    function getModeColor() {
      if (opMode === 'è²¸å‡º') return '#0d6efd';
      if (opMode === 'è¿”å´') return '#198754';
      if (opMode === 'å……å¡«') return '#fd7e14';
      if (opMode === 'è‡ªç¤¾ä¸€æ‹¬') return '#0dcaf0';
      return '#6c757d';
    }

    function initOperations(mode) {
      try {
        opMode = mode;
        opQueue = [];
        renderOpQueue();
        var panels = document.getElementsByClassName('op-setting-panel');
        for (var i = 0; i < panels.length; i++) panels[i].style.display = 'none';
        isSelfUseMode = false;
        updateSelfUseUI();

        var color = getModeColor();
        var btnText = 'é€ä¿¡';

        if (mode === 'è²¸å‡º') {
          document.getElementById('op-settings-lend').style.display = 'block';
          btnText = 'è²¸å‡ºå®Ÿè¡Œ';
        } else if (mode === 'è¿”å´') {
          document.getElementById('op-settings-return').style.display = 'block';
          btnText = 'è¿”å´å®Ÿè¡Œ';
        } else if (mode === 'å……å¡«') {
          document.getElementById('op-settings-fill').style.display = 'block';
          btnText = 'å……å¡«å®Œäº†';
        } else if (mode === 'è‡ªç¤¾ä¸€æ‹¬') {
          document.getElementById('op-settings-bulk-return').style.display = 'block';
          btnText = 'ä¸€æ‹¬è¿”å´';
          loadBulkReturnList();
        }

        var dialBtn = document.getElementById('dial-submit-btn');
        var hasItems = false;

        if (mode === 'è‡ªç¤¾ä¸€æ‹¬') {
          hasItems = (bulkReturnTanks.length > 0);
        } else {
          hasItems = (opQueue && opQueue.length > 0);
        }

        if (dialBtn) {
          dialBtn.style.display = hasItems ? 'block' : 'none';
          dialBtn.style.backgroundColor = 'rgba(255,255,255,0.95)';
          dialBtn.style.color = color;
          dialBtn.style.border = '2px solid ' + color;
          var dialLabel = document.getElementById('dial-submit-label');
          if (dialLabel) dialLabel.innerText = btnText;
        }

        document.querySelectorAll('.nav-item').forEach(el => {
          el.classList.remove('active');
          if (el.dataset.mode === mode) el.classList.add('active');
        });

        if (mode === 'è‡ªç¤¾ä¸€æ‹¬') {
          var dm = document.getElementById('op-dial-mode');
          if (dm) dm.style.display = 'none';
          document.body.classList.remove('dial-lock');
        } else {
          activateDialMode(color);
        }
      } catch (e) {
        alert("Error in initOperations: " + e.message);
      }
    }

    function activateDialMode(color) {
      var scrollPos = window.pageYOffset || document.documentElement.scrollTop;
      document.getElementById('op-dial-mode').style.display = 'flex';
      document.body.classList.add('dial-lock');
      document.body.style.top = '-' + scrollPos + 'px';
      document.body.dataset.scrollPos = scrollPos;
      if (!window._dialTouchBlocker) {
        window._dialTouchBlocker = function (e) {
          if (!document.body.classList.contains('dial-lock')) return;
          var target = e.target;
          while (target && target !== document.body) {
            if (target.id === 'rotary-queue-display') return;
            if (target.id === 'offcanvasMenu') return; // ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼å†…ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’è¨±å¯
            target = target.parentElement;
          }
          if (e.cancelable) e.preventDefault();
        };
        document.addEventListener('touchmove', window._dialTouchBlocker, { passive: false });
      }
      // Move settings card to bottom
      var settingsCard = document.getElementById('op-settings-card');
      var container = document.getElementById('op-container');
      if (settingsCard && container) container.appendChild(settingsCard);
      registerDialTouch();
      renderDialMode(color);
    }

    function refreshMasterData() {
      if (!confirm("æœ€æ–°ã®ãƒªã‚¹ãƒˆã‚’å–å¾—ã—ã¾ã™ã‹ï¼Ÿ")) return;
      var btn = document.getElementById('btn-refresh');
      var orgHtml = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> æ›´æ–°ä¸­';
      google.script.run.withSuccessHandler(function (res) {
        loadAllMasterData(); btn.disabled = false; btn.innerHTML = orgHtml;
      }).withFailureHandler(function (e) {
        alert("æ›´æ–°ã‚¨ãƒ©ãƒ¼: " + e.message); btn.disabled = false; btn.innerHTML = orgHtml;
      }).clearMasterCaches();
    }

    function toggleSelfUse() { isSelfUseMode = !isSelfUseMode; updateSelfUseUI(); renderOpQueue(); }
    function updateSelfUseUI() {
      var sel = document.getElementById('op-dest-select');
      var btn = document.getElementById('btn-self-use');
      var badge = document.getElementById('self-use-badge');
      if (sel && btn && badge) {
        if (isSelfUseMode) {
          sel.disabled = true; btn.className = 'btn btn-info text-dark fw-bold'; badge.style.display = 'block';
          var dialLabel = document.getElementById('dial-submit-label');
          if (dialLabel) dialLabel.innerText = 'åˆ©ç”¨é–‹å§‹';
        } else {
          sel.disabled = false; btn.className = 'btn btn-outline-secondary'; badge.style.display = 'none';
          var dialLabel = document.getElementById('dial-submit-label');
          if (dialLabel) dialLabel.innerText = 'è²¸å‡ºå®Ÿè¡Œ';
        }
      }
    }
    function toggleReturnCheck(type) {
      var unused = document.getElementById('op-check-unused');
      var defect = document.getElementById('op-check-defect');
      if (type === 'unused' && unused.checked) defect.checked = false;
      else if (type === 'defect' && defect.checked) unused.checked = false;
    }

    function loadBulkReturnList() {
      var container = document.getElementById('bulk-return-list');
      if (!container) return;
      container.innerHTML = '<div class="text-center text-muted p-3"><span class="spinner-border spinner-border-sm"></span> å–å¾—ä¸­...</div>';

      google.script.run.withSuccessHandler(function (list) {
        bulkReturnTanks = list.map(item => ({ id: item.id, statusTag: 'normal', note: '' }));
        renderBulkReturnList();
      }).withFailureHandler(function (e) {
        container.innerHTML = '<div class="alert alert-danger py-2 small">å–å¾—ã‚¨ãƒ©ãƒ¼: ' + e.message + '</div>';
      }).getInHouseTanks();
    }

    function renderBulkReturnList() {
      var container = document.getElementById('bulk-return-list');
      if (!container) return;
      container.innerHTML = '';

      if (bulkReturnTanks.length === 0) {
        container.innerHTML = '<div class="text-center text-muted p-3 mt-4"><i class="bi bi-check-circle display-1 text-success d-block mb-3"></i><h5>è¿”å´ã™ã‚‹ã‚¿ãƒ³ã‚¯ã¯ã‚ã‚Šã¾ã›ã‚“</h5><p class="small">ç¾åœ¨è‡ªç¤¾åˆ©ç”¨ä¸­ã®ã‚¿ãƒ³ã‚¯ã¯0ä»¶ã§ã™ã€‚</p></div>';
        var dialBtn = document.getElementById('dial-submit-btn');
        if (dialBtn) dialBtn.style.display = 'none';
        return;
      }

      bulkReturnTanks.forEach(function (item, idx) {
        var unusedCls = (item.statusTag === 'unused') ? 'active-unused' : '';
        var defectCls = (item.statusTag === 'defect') ? 'active-defect' : '';

        var html = `
          <div class="bulk-card">
            <div class="bulk-id">${item.id}</div>
            <div>
              <button class="bulk-tag-btn ${unusedCls}" onclick="toggleBulkTag(${idx}, 'unused')">æœªä½¿ç”¨</button>
              <button class="bulk-tag-btn ${defectCls}" onclick="toggleBulkTag(${idx}, 'defect')">æœªå……å¡«</button>
            </div>
          </div>
        `;
        container.insertAdjacentHTML('beforeend', html);
      });

      var dialBtn = document.getElementById('dial-submit-btn');
      if (dialBtn && opMode === 'è‡ªç¤¾ä¸€æ‹¬') {
        dialBtn.style.display = 'block';
        document.getElementById('dial-submit-label').innerText = bulkReturnTanks.length + "ä»¶ å…¨ã¦è¿”å´";
      }
    }

    function toggleBulkTag(idx, tag) {
      if (bulkReturnTanks[idx].statusTag === tag) {
        bulkReturnTanks[idx].statusTag = 'normal';
      } else {
        bulkReturnTanks[idx].statusTag = tag;
      }
      renderBulkReturnList();
    }

    function renderRepairCheckboxes() {
      var container = document.getElementById('repair-options-container');
      if (!container) return;
      container.innerHTML = '';
      repairOptionsCache.forEach(function (opt, idx) {
        var html = `<label class="repair-list-item" id="rep-item-${idx}">
     <input class="form-check-input repair-check-input" type="checkbox" value="${opt.price}" id="rep-opt-${idx}" data-name="${opt.name}" onchange="toggleRepairItem(${idx})">
     <span class="repair-name">${opt.name}</span><span class="repair-price">${opt.price} å††</span></label>`;
        container.insertAdjacentHTML('beforeend', html);
      });
      calcRepairTotal();
    }
    function toggleRepairItem(idx) {
      var chk = document.getElementById('rep-opt-' + idx);
      var item = document.getElementById('rep-item-' + idx);
      if (chk && item) {
        if (chk.checked) item.classList.add('checked'); else item.classList.remove('checked');
        calcRepairTotal();
      }
    }
    function calcRepairTotal() {
      var total = 0;
      var checks = document.querySelectorAll('#repair-options-container input[type="checkbox"]:checked');
      checks.forEach(function (c) { total += parseInt(c.value) || 0; });
      var disp = document.getElementById('repair-total-display');
      if (disp) disp.innerText = total.toLocaleString();
    }

    function triggerSuccessFeedback(prefix) {
      var rList = document.getElementById('rotary-queue-list');
      if (rList) {
        rList.classList.remove('flash-success');
        void rList.offsetWidth;
        rList.classList.add('flash-success');
      }
    }

    function triggerErrorFeedback(msg) {
      // ç°¡æ˜“çš„ãªãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ã¾ãŸã¯ç”»é¢ä¸Šéƒ¨ã®ã‚¢ãƒ©ãƒ¼ãƒˆãƒãƒŠãƒ¼ã‚’è¡¨ç¤º
      var existing = document.getElementById('dial-error-toast');
      if (existing) existing.remove();
      var toast = document.createElement('div');
      toast.id = 'dial-error-toast';
      toast.className = 'alert alert-danger shadow position-fixed w-75 text-center fw-bold py-2';
      toast.style.top = '20px';
      toast.style.left = '50%';
      toast.style.transform = 'translateX(-50%)';
      toast.style.zIndex = '9999';
      toast.innerHTML = '<i class="bi bi-exclamation-octagon-fill"></i> ' + msg;

      document.body.appendChild(toast);
      setTimeout(() => { if (toast && toast.parentElement) toast.remove(); }, 3000);

      var rList = document.getElementById('rotary-queue-list');
      if (rList) {
        rList.classList.remove('flash-error');
        void rList.offsetWidth;
        rList.classList.add('flash-error');
      }
    }

    function addOpQueue(id) {
      if (!opQueue.some(item => item.id === id)) {
        // --- äº‹å‰ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³åˆ¤å®š ---
        if (window.tankMapCache) {
          var nId = id.replace(/[ï¼-ï¼™ï¼¡-ï¼ºï½-ï½š]/g, function (s) { return String.fromCharCode(s.charCodeAt(0) - 0xFEE0); }).replace(/[-âˆ’\s_ãƒ¼]/g, '').toUpperCase();
          var tankInfo = window.tankMapCache[nId];

          if (tankInfo) {
            var currentStatus = tankInfo.status;
            var isSpecial = SPECIAL_STATUSES.includes(currentStatus);

            var targetMode = opMode;
            if (opMode === 'è²¸å‡º' && isSelfUseMode) targetMode = 'è‡ªç¤¾åˆ©ç”¨';

            var allowedPrev = OP_RULES[targetMode];
            if (!isSpecial && allowedPrev && allowedPrev.length > 0 && allowedPrev.indexOf(currentStatus) === -1) {
              triggerErrorFeedback(`ä¸é©åˆãªã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ç¾åœ¨ [${currentStatus}]`);
              return false; // ãƒ–ãƒ­ãƒƒã‚¯
            }
          } else {
            triggerErrorFeedback('æœªç™»éŒ²ã®ã‚¿ãƒ³ã‚¯IDã§ã™');
            return false;
          }
        }

        opQueue.push({ id: id, note: '' });
        renderOpQueue();
        return true;
      }
      return false;
    }
    function updateItemNote(index, text) { opQueue[index].note = text; }
    function appendQuickNote(index, text) {
      var current = opQueue[index].note;
      if (current) text = current + ", " + text;
      opQueue[index].note = text;
      document.getElementById('note-input-' + index).value = text;
    }

    function renderOpQueue() {
      var list = document.getElementById('rotary-queue-list');
      if (!list) return;
      list.innerHTML = '';
      var countEl = document.getElementById('rotary-queue-count');
      if (countEl) countEl.innerText = opQueue.length;
      var color = getModeColor();
      var dialBtn = document.getElementById('dial-submit-btn');

      if (opQueue.length > 0) {
        if (dialBtn) dialBtn.style.display = 'block';
        opQueue.slice().reverse().forEach((item, revIndex) => {
          var index = opQueue.length - 1 - revIndex;

          var destHtml = '';
          if (opMode === 'è¿”å´' && window.tankMapCache) {
            var nId = item.id.replace(/[ï¼-ï¼™ï¼¡-ï¼ºï½-ï½š]/g, function (s) { return String.fromCharCode(s.charCodeAt(0) - 0xFEE0); }).replace(/[-âˆ’\s_ãƒ¼]/g, '').toUpperCase();
            var info = window.tankMapCache[nId];
            if (info && info.loc) {
              destHtml = `<div class="text-secondary text-truncate ms-2 mt-1" style="font-size: 0.70rem; max-width: 120px;"><i class="bi bi-geo-alt-fill"></i> ${info.loc}</div>`;
            }
          }

          list.innerHTML += `<div class="queue-card p-2 mb-1 shadow-sm" style="border-left-color: ${color};">
           <div class="d-flex justify-content-between align-items-center">
             <div>
               <span class="fw-bold fs-5 font-monospace">${item.id}</span>
               ${destHtml}
             </div>
             <button class="btn btn-sm text-danger" onclick="removeOpQueue(${index})"><i class="bi bi-trash3-fill"></i></button>
           </div>
          </div>`;
        });
      } else {
        var _emptyHtml = '<div class="p-4 text-center text-muted"><div class="mb-2">ã¾ã ã‚­ãƒ¥ãƒ¼ã«è¿½åŠ ã•ã‚Œã¦ã„ã¾ã›ã‚“</div>';

        if (window.tankMapCache !== null) {
          var _counts = { 'å……å¡«æ¸ˆã¿': 0, 'è²¸å‡ºä¸­': 0, 'ç©º': 0 };
          var _cacheKeys = Object.keys(window.tankMapCache);
          if (_cacheKeys.length > 0) {
            for (var i = 0; i < _cacheKeys.length; i++) {
              var s = window.tankMapCache[_cacheKeys[i]].status;
              if (_counts.hasOwnProperty(s)) {
                _counts[s]++;
              }
            }
            _emptyHtml += `
              <div class="d-flex justify-content-center gap-2 mt-3 flex-wrap">
                <span class="badge bg-success" style="font-size:0.8rem; font-weight:normal;">å……å¡«æ¸ˆã¿: ${_counts['å……å¡«æ¸ˆã¿']}æœ¬</span>
                <span class="badge bg-warning text-dark" style="font-size:0.8rem; font-weight:normal;">è²¸å‡ºä¸­: ${_counts['è²¸å‡ºä¸­']}æœ¬</span>
                <span class="badge bg-secondary" style="font-size:0.8rem; font-weight:normal;">ç©º: ${_counts['ç©º']}æœ¬</span>
              </div>
            `;
          }
        }

        _emptyHtml += '</div>';
        list.innerHTML = _emptyHtml;
        if (opMode !== 'è‡ªç¤¾ä¸€æ‹¬') {
          if (dialBtn) dialBtn.style.display = 'none';
        }
      }
    }

    function removeOpQueue(index) { opQueue.splice(index, 1); renderOpQueue(); }
    function clearOpQueue() { opQueue = []; renderOpQueue(); }

    function submitOp() {
      if (opMode === 'è‡ªç¤¾ä¸€æ‹¬') {
        submitBulkReturn();
        return;
      }

      if (opMode === 'è²¸å‡º' && !isSelfUseMode) {
        var dest = document.getElementById('op-dest-select').value;
        if (!dest || dest === "") { alert("âš ï¸ è²¸å‡ºå…ˆãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚"); return; }
      }
      var confirmMsg = opQueue.length + 'ä»¶ é€ä¿¡ã—ã¾ã™ã‹ï¼Ÿ';
      if (opMode === 'è²¸å‡º' && isSelfUseMode) confirmMsg += '\nï¼ˆè‡ªç¤¾åˆ©ç”¨ã¨ã—ã¦è¨˜éŒ²ã•ã‚Œã¾ã™ï¼‰';
      else if (opMode === 'è²¸å‡º') confirmMsg += '\nè²¸å‡ºå…ˆ: ' + document.getElementById('op-dest-select').value;

      if (!confirm(confirmMsg)) return;

      var dialBtn = document.getElementById('dial-submit-btn');
      var dialLabel = document.getElementById('dial-submit-label');
      var orgText = dialLabel ? dialLabel.innerText : 'é€ä¿¡';
      if (dialBtn) dialBtn.disabled = true;
      if (dialLabel) dialLabel.innerText = "é€ä¿¡ä¸­...";

      var finalDest = document.getElementById('op-dest-select') ? document.getElementById('op-dest-select').value : "";
      var finalAction = opMode;
      if (opMode === 'è²¸å‡º' && isSelfUseMode) { finalDest = "è‡ªç¤¾åˆ©ç”¨"; finalAction = "è‡ªç¤¾åˆ©ç”¨"; }

      var payload = {
        action: finalAction,
        items: opQueue,
        destination: finalDest,
        isUnused: document.getElementById('op-check-unused') ? document.getElementById('op-check-unused').checked : false,
        isDefect: document.getElementById('op-check-defect') ? document.getElementById('op-check-defect').checked : false,
        repairCost: 0,
        repairDetail: "",
        userPasscode: (typeof GLOBAL_PASSCODE !== 'undefined') ? GLOBAL_PASSCODE : ""
      };

      google.script.run.withSuccessHandler(res => {
        if (dialBtn) dialBtn.disabled = false;
        if (dialLabel) dialLabel.innerText = orgText;
        clearOpQueue();
        if (isSelfUseMode) toggleSelfUse();
        if (opMode === 'è²¸å‡º') document.getElementById('op-dest-select').value = "";
        if (document.getElementById('op-check-unused')) document.getElementById('op-check-unused').checked = false;
        if (document.getElementById('op-check-defect')) document.getElementById('op-check-defect').checked = false;

        var msg = "ã€é€ä¿¡çµæœã€‘\nç·æ•°: " + (res.totalCount || 0) + " æœ¬\n----------------\n";
        if (res.successIds && res.successIds.length > 0) msg += "âœ… æˆåŠŸ (" + res.successIds.length + "æœ¬):\n" + res.successIds.join(", ") + "\n\n";
        else msg += "âœ… æˆåŠŸ: ãªã—\n\n";
        if (res.failedItems && res.failedItems.length > 0) {
          msg += "âŒ å¤±æ•— (" + res.failedItems.length + "æœ¬):\n";
          res.failedItems.forEach(item => msg += "ãƒ»" + item.id + " : " + item.reason + "\n");
        }
        alert(msg);

      }).withFailureHandler(function (e) {
        if (dialBtn) dialBtn.disabled = false;
        if (dialLabel) dialLabel.innerText = orgText;
        alert("ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼: " + e);
      }).submitOperations(payload);
    }

    function submitBulkReturn() {
      if (bulkReturnTanks.length === 0) return;
      if (!confirm(bulkReturnTanks.length + "ä»¶ã®è‡ªç¤¾ã‚¿ãƒ³ã‚¯ã‚’ä¸€æ‹¬é€ä¿¡ã—ã¾ã™ã‹ï¼Ÿ\nâ€»æœªä½¿ç”¨ãƒ»æœªå……å¡«ã®ã‚¿ã‚°ã‚’ä»˜ã‘ãŸã‚‚ã®ã¯ãã®çŠ¶æ…‹ã§è¿”å´ã•ã‚Œã¾ã™ã€‚")) return;

      var dialBtn = document.getElementById('dial-submit-btn');
      var dialLabel = document.getElementById('dial-submit-label');
      var orgText = dialLabel ? dialLabel.innerText : 'é€ä¿¡';
      if (dialBtn) dialBtn.disabled = true;
      if (dialLabel) dialLabel.innerText = "é€ä¿¡ä¸­...";

      var payload = {
        action: 'è‡ªç¤¾ä¸€æ‹¬è¿”å´',
        items: bulkReturnTanks,
        userPasscode: (typeof GLOBAL_PASSCODE !== 'undefined') ? GLOBAL_PASSCODE : ""
      };

      google.script.run.withSuccessHandler(res => {
        if (dialBtn) dialBtn.disabled = false;
        if (dialLabel) dialLabel.innerText = orgText;
        if (res.success) {
          bulkReturnTanks = [];
          renderBulkReturnList();
          alert(res.message);
        } else {
          var msg = "ã‚¨ãƒ©ãƒ¼: " + res.message + "\n";
          if (res.failedItems) res.failedItems.forEach(i => msg += i.id + " : " + i.reason + "\n");
          alert(msg);
        }
      }).withFailureHandler(function (e) {
        if (dialBtn) dialBtn.disabled = false;
        if (dialLabel) dialLabel.innerText = orgText;
        alert("ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼: " + e);
      }).submitOperations(payload);
    }

    // â– â– â–  ãƒ­ãƒ¼ã‚¿ãƒªãƒ¼ãƒ¢ãƒ¼ãƒ‰ç”¨JS â– â– â– 
    var currentScrollY = 0;
    var ITEM_HEIGHT = 46;
    var activePrefix = '';
    var isOkMode = false;
    var dialItemsCount = 0;
    var isDraggingDial = false;
    var lastDragY = 0;
    var dialTouchRegistered = false;
    var swipeAccumulator = 0;
    var SWIPE_THRESHOLD = 70;
    var currentActiveIndex = 0;

    function renderDialMode(color) {
      var wheel = document.getElementById('dial-wheel');
      if (!wheel) return;
      wheel.innerHTML = '';
      dialItemsCount = opPrefixes.length;
      if (dialItemsCount === 0) return;

      var okBtn = document.getElementById('dial-ok-btn');
      var modeColor = getModeColor();
      if (okBtn) okBtn.style.backgroundColor = modeColor;

      opPrefixes.forEach((p, i) => {
        var el = document.createElement('div');
        el.className = 'rotary-item shadow-sm';
        el.id = 'dial-item-' + i;
        el.innerText = p;
        el.dataset.prefix = p;
        el.dataset.index = i;

        el.onclick = function () {
          currentActiveIndex = i;
          snapToItem(i);
          var inp = document.getElementById('rotary-hidden-input');
          if (inp) { inp.focus(); }
        };
        wheel.appendChild(el);
      });
      currentScrollY = 0;
      currentActiveIndex = 0;
      isDraggingDial = false;
      updateDialPositions();
    }

    function updateDialPositions() {
      var wheel = document.getElementById('dial-wheel');
      var container = document.getElementById('rotary-wheel-container');
      if (!wheel || !container) return;
      var items = wheel.getElementsByClassName('rotary-item');
      if (items.length === 0) return;

      var containerHeight = container.offsetHeight;
      if (containerHeight <= 0) return;

      var activeSlotY = containerHeight - 80;
      var remainingHeight = activeSlotY - 8;
      var slotHeight = Math.max(26, remainingHeight / Math.max(1, dialItemsCount - 1));

      var modeColor = getModeColor();

      for (var i = 0; i < items.length; i++) {
        var el = items[i];
        var idx = parseInt(el.dataset.index);

        if (idx === currentActiveIndex) {
          el.style.top = activeSlotY + 'px';
          el.style.opacity = '1';
          el.classList.add('active');
          el.style.backgroundColor = modeColor;
          el.style.color = '#fff';
          el.style.backgroundImage = 'linear-gradient(135deg, rgba(255,255,255,0.2) 0%, transparent 100%)';
          el.style.textShadow = '0 2px 4px rgba(0,0,0,0.3)';
          el.style.boxShadow = '0 8px 24px ' + modeColor + '88, 0 0 0 3px rgba(255,255,255,0.7)';
          el.style.transform = 'scale(1.35)';
          el.style.zIndex = '110';

          var targetLabel = document.getElementById('dial-ok-label');
          if (activePrefix !== el.dataset.prefix) {
            activePrefix = el.dataset.prefix;
            if (targetLabel) {
              targetLabel.innerText = el.dataset.prefix + '-OK';
              var okBtn = document.getElementById('dial-ok-btn');
              if (okBtn) {
                okBtn.classList.remove('pop-anim');
                void okBtn.offsetWidth;
                okBtn.classList.add('pop-anim');
              }
            }
          }
        } else {
          var stepsBack = (currentActiveIndex - idx + dialItemsCount) % dialItemsCount;
          var slotY = activeSlotY - stepsBack * slotHeight;

          el.style.top = slotY + 'px';
          el.classList.remove('active');
          el.style.backgroundColor = '';
          el.style.backgroundImage = '';
          el.style.textShadow = '';
          el.style.color = '#444';
          el.style.boxShadow = '';
          el.style.transform = 'scale(0.85)';
          el.style.zIndex = '100';

          if (slotY < 15) {
            el.style.opacity = Math.max(0, (slotY + 20) / 35).toString();
          } else {
            el.style.opacity = '0.8';
          }
        }
      }
    }

    var dialVelocity = 0;
    var dialMomentumRaf = null;
    var lastTouchTime = 0;
    var touchHistory = [];

    function registerDialTouch() {
      if (dialTouchRegistered) return;
      var touchArea = document.getElementById('op-container');
      if (!touchArea) return;

      touchArea.addEventListener('touchstart', function (e) {
        var touch = e.touches[0];
        // ãƒ€ã‚¤ãƒ¤ãƒ«ã®åå¿œé ˜åŸŸã‚’ç”»é¢ã®å³1/3ã«åˆ¶é™
        if (touch.clientX < window.innerWidth * 2 / 3) {
          isDraggingDial = false;
          return;
        }
        isDraggingDial = true;
        lastDragY = touch.clientY;
        dialVelocity = 0;
        touchHistory = [];
        if (dialMomentumRaf) { cancelAnimationFrame(dialMomentumRaf); dialMomentumRaf = null; }
        touchHistory.push({ y: touch.clientY, t: Date.now() });
      }, { passive: true });

      touchArea.addEventListener('touchmove', function (e) {
        if (!isDraggingDial) return;

        // Let's only scroll the dial strictly if the user is dragging in an area not already scrolling natively
        // However, dial lock is already ensuring `#op-container` doesn't natively scroll
        if (e.cancelable && document.body.classList.contains('dial-lock')) {
          e.preventDefault();
        }

        var touch = e.touches[0];
        var diffY = touch.clientY - lastDragY;
        lastDragY = touch.clientY;

        // Smooth live tracking: move items with finger
        var totalScrollRange = dialItemsCount * ITEM_HEIGHT;
        currentScrollY -= diffY * (ITEM_HEIGHT / SWIPE_THRESHOLD);
        if (currentScrollY < 0) currentScrollY += totalScrollRange;
        currentScrollY = currentScrollY % totalScrollRange;
        currentActiveIndex = Math.round(currentScrollY / ITEM_HEIGHT) % dialItemsCount;
        updateDialPositions();

        // Track recent touches for velocity calculation
        var now = Date.now();
        touchHistory.push({ y: touch.clientY, t: now });
        // Keep only last 100ms of history
        while (touchHistory.length > 1 && now - touchHistory[0].t > 100) {
          touchHistory.shift();
        }
      }, { passive: false });

      touchArea.addEventListener('touchend', function (e) {
        isDraggingDial = false;

        // Calculate velocity from touch history
        if (touchHistory.length >= 2) {
          var first = touchHistory[0];
          var last = touchHistory[touchHistory.length - 1];
          var dt = last.t - first.t;
          if (dt > 0 && dt < 300) {
            dialVelocity = -(last.y - first.y) / dt * 16 * (ITEM_HEIGHT / SWIPE_THRESHOLD);
          } else {
            dialVelocity = 0;
          }
        } else {
          dialVelocity = 0;
        }

        // Start momentum deceleration
        if (Math.abs(dialVelocity) > 0.5) {
          startMomentumScroll();
        } else {
          // Snap to nearest item
          snapToNearest();
        }
      }, { passive: true });

      dialTouchRegistered = true;
    }

    function startMomentumScroll() {
      // é€Ÿåº¦ã«å¿œã˜ã¦é£›ã°ã™æ–‡å­—æ•°ã‚’è¨ˆç®—ã—ã€ä¸€æ–‡å­—ã”ã¨ã«ã‚¹ãƒŠãƒƒãƒ—ã™ã‚‹
      var stepsToMove = Math.round(dialVelocity / ITEM_HEIGHT * 1.2);
      // æœ€å¤§ã§ã‚‚3æ–‡å­—åˆ†ã«åˆ¶é™ï¼ˆæ‘©æ“¦å¼·ã‚ï¼‰
      stepsToMove = Math.max(-3, Math.min(3, stepsToMove));
      if (stepsToMove === 0) {
        snapToNearest();
        return;
      }
      var targetIdx = (currentActiveIndex + stepsToMove) % dialItemsCount;
      if (targetIdx < 0) targetIdx += dialItemsCount;
      currentActiveIndex = targetIdx;
      snapToItem(targetIdx);
    }

    function snapToNearest() {
      var nearestIdx = Math.round(currentScrollY / ITEM_HEIGHT) % dialItemsCount;
      if (nearestIdx < 0) nearestIdx += dialItemsCount;
      currentActiveIndex = nearestIdx;
      snapToItem(nearestIdx);
    }

    function snapToItem(idx) {
      var totalScrollRange = dialItemsCount * ITEM_HEIGHT;
      var targetScrollY = idx * ITEM_HEIGHT;

      var diff = targetScrollY - currentScrollY;

      if (diff > totalScrollRange / 2) diff -= totalScrollRange;
      if (diff < -totalScrollRange / 2) diff += totalScrollRange;

      animateDialRotation(currentScrollY + diff);
    }

    function animateDialRotation(targetScroll) {
      if (dialMomentumRaf) { cancelAnimationFrame(dialMomentumRaf); dialMomentumRaf = null; }
      var startScroll = currentScrollY;
      var diff = targetScroll - startScroll;
      if (Math.abs(diff) < 0.5) {
        currentScrollY = targetScroll;
        var totalScrollRange = dialItemsCount * ITEM_HEIGHT;
        if (currentScrollY < 0) currentScrollY += totalScrollRange;
        currentScrollY = currentScrollY % totalScrollRange;
        updateDialPositions();
        return;
      }
      var startTime = performance.now();
      var duration = 450;
      function tick(now) {
        var elapsed = now - startTime;
        var t = Math.min(1, elapsed / duration);
        var ease = 1 - Math.pow(1 - t, 3); // easeOutCubic
        currentScrollY = startScroll + diff * ease;

        var totalScrollRange = dialItemsCount * ITEM_HEIGHT;
        if (currentScrollY < 0) currentScrollY += totalScrollRange;
        currentScrollY = currentScrollY % totalScrollRange;

        updateDialPositions();
        if (t < 1) {
          dialMomentumRaf = requestAnimationFrame(tick);
        } else {
          currentScrollY = targetScroll;
          if (currentScrollY < 0) currentScrollY += totalScrollRange;
          currentScrollY = currentScrollY % totalScrollRange;
          updateDialPositions();
          dialMomentumRaf = null;
        }
      }
      dialMomentumRaf = requestAnimationFrame(tick);
    }

    function submitActiveOk() {
      if (activePrefix) {
        var added = addOpQueue(activePrefix + '-OK');
        if (added) triggerSuccessFeedback(activePrefix);
      }
    }

    function checkRotaryInput(el) {
      var val = el.value.replace(/[ï¼-ï¼™]/g, s => String.fromCharCode(s.charCodeAt(0) - 0xFEE0));
      val = val.replace(/[^0-9]/g, '');
      el.value = val;
      if (val.length >= 2) {
        var added = addOpQueue(activePrefix + '-' + val);
        el.value = '';
        if (added) triggerSuccessFeedback(activePrefix);
      }
    }
  </script>
</body>

</html>