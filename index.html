<!DOCTYPE html>
<html lang="ja">

<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <meta name="referrer" content="no-referrer">
  <title>
    <?= appTitle ?>
  </title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // サーバーからの初期値受け取り
    var SERVER_STAFF_NAME = "<?= staffName ?>";
    var SERVER_USER_ROLE = "<?= userRole ?>";
    var SERVER_LOGIN_MODE = "<?= loginMode ?>";
    var SERVER_USER_EMAIL = "<?= (typeof userEmail !== 'undefined') ? userEmail : '' ?>";
    var SERVER_VIEW_MODE = "<?= (typeof viewMode !== 'undefined') ? viewMode : 'リスト' ?>";

    // ▼▼▼ 追加: ターゲットページの受け取り ▼▼▼
    var SERVER_TARGET_PAGE = "<?= (typeof targetPage !== 'undefined') ? targetPage : '' ?>";

    // クライアント管理変数
    var GLOBAL_STAFF_NAME = SERVER_STAFF_NAME;
    var GLOBAL_USER_ROLE = SERVER_USER_ROLE;
    var GLOBAL_LOGIN_MODE = SERVER_LOGIN_MODE;
    var GLOBAL_USER_EMAIL = SERVER_USER_EMAIL;
    var GLOBAL_PASSCODE = "";

    if (!GLOBAL_STAFF_NAME || GLOBAL_STAFF_NAME === "undefined" || GLOBAL_STAFF_NAME.trim() === "") {
      GLOBAL_STAFF_NAME = "ゲスト";
    }
  </script>
  <?!= include('Global_CSS'); ?>

  <style>
    /* 既存スタイル */
    .navbar-custom {
      background-color: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      height: 60px;
    }

    .badge-admin-luxury {
      background-color: #000 !important;
      color: #ff3333 !important;
      border: 1px solid #ff3333;
      cursor: pointer;
    }

    .offcanvas {
      z-index: 1050 !important;
    }

    .bottom-nav {
      z-index: 1020 !important;
    }

    .user-info-card {
      background-color: #f8f9fa;
      border-bottom: 1px solid #dee2e6;
    }

    .user-icon-circle {
      width: 40px;
      height: 40px;
      background-color: #0d6efd;
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* ▼▼▼ 追加: 全画面ローディング & エラー画面用スタイル ▼▼▼ */
    #initial-loader {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: #ffffff;
      z-index: 99999;
      /* 最前面 */
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      transition: opacity 0.5s ease;
    }

    #permission-denied-view {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: #f8f9fa;
      z-index: 99990;
      /* ローディングより下、アプリより上 */
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
    }

    /* アプリ内ローディング */
    #loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.8);
      z-index: 20000;
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
    }
  </style>
</head>

<body>

  <div id="initial-loader">
    <div class="spinner-border text-primary" role="status" style="width: 4rem; height: 4rem;"></div>
    <div class="mt-4 fw-bold text-secondary fs-5">認証情報を確認中...</div>
  </div>

  <div id="permission-denied-view">
    <div class="text-danger mb-3"><i class="bi bi-exclamation-triangle-fill" style="font-size: 4rem;"></i></div>
    <h2 class="fw-bold text-dark">アクセス権限がありません</h2>
    <p class="text-muted mt-2">このページを表示する権限（管理者権限など）が不足しています。</p>
    <a href="<?= scriptUrl ?>" class="btn btn-outline-secondary mt-4">通常画面へ戻る</a>
  </div>

  <div class="modal fade" id="loginModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
    aria-hidden="true" style="z-index: 11000;">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content shadow-lg border-0 bg-white">
        <div class="modal-header border-0 bg-white">
          <h5 class="modal-title fw-bold text-dark"><i class="bi bi-shield-lock-fill me-2"></i>ログイン</h5>
        </div>
        <div class="modal-body p-4 text-center">
          <p class="text-muted small mb-3">担当者パスコード（6桁）を入力してください</p>
          <input type="tel" id="login-passcode" class="form-control form-control-lg text-center fw-bold fs-2 mb-3"
            maxlength="6" placeholder="------" style="font-family:monospace;" inputmode="numeric" pattern="[0-9]*"
            autocomplete="one-time-code" autofocus oninput="checkPasscodeInput(this)">
          <div id="login-error" class="text-danger small fw-bold mb-2" style="display:none;"></div>
          <button class="btn btn-primary w-100 fw-bold py-2" onclick="doLogin()">認証する</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="settingsModal" tabindex="-1" aria-hidden="true" style="z-index: 11000;">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content shadow-lg border-0 bg-white">
        <div class="modal-header border-0 bg-white">
          <h5 class="modal-title fw-bold text-dark"><i class="bi bi-gear-fill me-2"></i>設定</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body p-4">
          <label class="form-label fw-bold small text-secondary mb-2">操作画面の表示形式</label>
          <div class="d-grid gap-2">
            <label class="d-flex align-items-center p-3 rounded border" id="setting-view-list"
              style="cursor:pointer; transition: all 0.2s;" onclick="selectViewMode('リスト')">
              <input type="radio" name="viewModeSetting" value="リスト" class="form-check-input me-3" id="vm-list">
              <div>
                <div class="fw-bold"><i class="bi bi-card-list me-1"></i> リスト形式</div>
                <div class="text-muted small">プレフィックスごとに入力欄が並ぶ標準レイアウト</div>
              </div>
            </label>
            <label class="d-flex align-items-center p-3 rounded border" id="setting-view-dial"
              style="cursor:pointer; transition: all 0.2s;" onclick="selectViewMode('ダイヤル')">
              <input type="radio" name="viewModeSetting" value="ダイヤル" class="form-check-input me-3" id="vm-dial">
              <div>
                <div class="fw-bold"><i class="bi bi-vinyl me-1"></i> ダイヤル形式</div>
                <div class="text-muted small">ロータリー式でプレフィックスを選ぶレイアウト</div>
              </div>
            </label>
          </div>
          <div id="settings-save-status" class="text-center mt-3 small" style="display:none;"></div>
          <button class="btn btn-primary w-100 fw-bold py-2 mt-3" onclick="saveSettings()">
            <i class="bi bi-check-lg me-1"></i> 保存して反映
          </button>
        </div>
      </div>
    </div>
  </div>

  <div id="loading-overlay" style="display:none;">
    <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;"></div>
    <div class="mt-3 fw-bold text-secondary">処理中...</div>
  </div>

  <nav class="navbar navbar-custom fixed-top px-3">
    <div class="container-fluid position-relative d-flex align-items-center h-100">
      <div class="d-flex align-items-center">
        <button class="hamburger-btn me-3" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasMenu">
          <i class="bi bi-list"></i>
        </button>
        <div class="d-flex align-items-center">
          <span class="fw-bold text-secondary me-2" style="font-size: 0.9rem;" id="header-staff-name">
            <?= staffName ?> さん
          </span>
        </div>
      </div>
      <div class="position-absolute top-50 start-50 translate-middle">
        <div class="fw-bold text-dark" style="font-size: 1.1rem; letter-spacing: 0.05em;" id="header-title">
          <?= appTitle ?>
        </div>
      </div>
      <div class="ms-auto">
        <button id="header-bulk-return-btn" class="btn btn-sm btn-outline-info py-1 px-3"
          style="display:none; font-size:0.85rem; font-weight:bold;" onclick="switchMode('自社管理')">
          <i class="bi bi-building-down"></i> 自社返却
        </button>
      </div>
    </div>
  </nav>

  <div class="offcanvas offcanvas-start" tabindex="-1" id="offcanvasMenu">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title fw-bold"> メニュー </h5><button type="button" class="btn-close text-reset"
        data-bs-dismiss="offcanvas"></button>
    </div>
    <div class="offcanvas-body p-0">

      <div class="p-3 user-info-card text-dark">
        <div class="d-flex align-items-center mb-3">
          <div class="user-icon-circle me-3">
            <i class="bi bi-person-fill fs-5"></i>
          </div>
          <div style="min-width: 0; flex-grow: 1;">
            <div class="fw-bold text-truncate" id="menu-user-name" style="font-size: 1rem;">ゲスト</div>
            <div class="small text-muted text-truncate" id="menu-user-email" style="font-size: 0.75rem;"></div>
          </div>
          <button class="btn btn-sm btn-outline-secondary ms-2" onclick="openSettingsModal()" title="設定">
            <i class="bi bi-gear-fill"></i>
          </button>
          <button class="btn btn-sm btn-outline-danger ms-1" onclick="doLogout()" title="ログアウト">
            <i class="bi bi-box-arrow-right"></i>
          </button>
        </div>
      </div>

      <div class="p-3 bg-light border-bottom mb-2"><small class="text-muted"> 基本操作 </small></div>
      <a class="menu-item" onclick="switchMode('貸出')"><i class="bi bi-box-arrow-up text-primary"></i> <span>
          <?= menuNames.LEND ?>
        </span></a>
      <a class="menu-item" onclick="switchMode('返却')"><i class="bi bi-box-arrow-in-down text-success"></i> <span>
          <?= menuNames.RETURN ?>
        </span></a>
      <a class="menu-item" onclick="switchMode('充填')"><i class="bi bi-fuel-pump-fill text-warning"></i> <span>
          <?= menuNames.FILL ?>
        </span></a>

      <div class="p-3 bg-light border-bottom mb-2 mt-2"><small class="text-muted"> メンテナンス・報告 </small></div>
      <a class="menu-item" onclick="switchMode('ダッシュボード')"><i class="bi bi-speedometer2 text-primary"></i>
        <span>ダッシュボード</span></a>
      <a class="menu-item" onclick="switchMode('破損報告')"><i class="bi bi-tools text-danger"></i> <span>
          <?= menuNames.DAMAGE ?>
        </span></a>
      <a class="menu-item" onclick="switchMode('修理済み')"><i class="bi bi-bandaid text-secondary"></i> <span>
          <?= menuNames.REPAIR ?>
        </span></a>
      <a class="menu-item" onclick="switchMode('耐圧検査完了')"><i class="bi bi-patch-check-fill" style="color:#6f42c1;"></i>
        <span>
          <?= menuNames.INSP ?>
        </span></a>
      <a class="menu-item" onclick="switchMode('資材発注')"><i class="bi bi-cart-plus-fill text-info"></i> <span>
          <?= menuNames.ORDER ?>
        </span></a>


      <div class="p-3 bg-light border-bottom mb-2 mt-2"><small class="text-muted"> 確認 </small></div>

      <a class="menu-item" onclick="switchMode('マイページ')"><i class="bi bi-person-vcard text-warning"></i> <span>
          <?= menuNames.MYPAGE ?>
        </span></a>
    </div>
  </div>

  <div id="global-message" class="alert shadow-sm"
    style="display:none; position: fixed; top: 70px; left: 5%; width: 90%; z-index: 2000;"></div>

  <div id="view-operations" style="display:none;">
    <?!= include(operationsView); ?>
  </div>
  <div id="view-operations-sub" style="display:none;">
    <?!= include('Part_DamageReport'); ?>
  </div>
  <div id="view-maintenance" style="display:none;">
    <?!= include('Part_Maintenance'); ?>
  </div>
  <div id="view-mypage" style="display:none;">
    <?!= include('Part_MyPage'); ?>
  </div>
  <div id="view-order" style="display:none;">
    <?!= include('Part_Order'); ?>
  </div>
  <div id="view-inhouse" style="display:none;">
    <?!= include('Part_InHouse'); ?>
  </div>
  <div id="view-dashboard" style="display:none;">
    <?!= include('Part_Dashboard'); ?>
  </div>

  <div class="bottom-nav">
    <button class="nav-btn" id="nav-btn-lend" onclick="switchMode('貸出')">
      <i class="bi bi-box-arrow-up"></i> 貸出
    </button>
    <button class="nav-btn" id="nav-btn-return" onclick="switchMode('返却')">
      <i class="bi bi-box-arrow-in-down"></i> 返却
    </button>
    <button class="nav-btn" id="nav-btn-fill" onclick="switchMode('充填')">
      <i class="bi bi-fuel-pump-fill"></i> 充填
    </button>
  </div>

  <script>
    var currentView = '';
    var offcanvas;
    var loginModal;

    // ■ Safari等のITP（クロスサイトトラッキング防止）によるlocalStorageエラー対策
    function safelyGetLocal(key) {
      try { return localStorage.getItem(key); } catch (e) {
        console.warn("localStorage is blocked:", e); return null;
      }
    }
    function safelySetLocal(key, value) {
      try { localStorage.setItem(key, value); } catch (e) {
        console.warn("localStorage is blocked:", e);
      }
    }
    function safelyRemoveLocal(key) {
      try { localStorage.removeItem(key); } catch (e) {
        console.warn("localStorage is blocked:", e);
      }
    }

    // ■ Safari ITP対策: iframe内からのトップレベルナビゲーション
    // window.top.location.href はSafariのクロスオリジンiframe内で
    // SecurityError("The operation is insecure")を発生させるため、
    // aタグのtarget="_top"クリックで安全に遷移する
    function safelyNavigateTop(url) {
      var a = document.createElement('a');
      a.href = url;
      a.target = '_top';
      a.style.display = 'none';
      document.body.appendChild(a);
      a.click();
    }

    // ■ 管理権限の判定関数
    function isUserAdmin() {
      var currentRole = GLOBAL_USER_ROLE;
      if (!currentRole || currentRole === 'undefined') {
        currentRole = "<?= userRole ?>";
      }
      var role = String(currentRole || "");
      return (role.indexOf('管理者') !== -1 || role.indexOf('準管理者') !== -1 || role.toLowerCase().indexOf('admin') !== -1);
    }

    function getCurrentUserPasscode() {
      // 古い4桁パスコードと新しい6桁の両方に対応
      var isValid = function (p) { return typeof p === 'string' && /^\d{4,6}$/.test(p.trim()); };

      if (typeof window.GLOBAL_PASSCODE !== 'undefined' && isValid(window.GLOBAL_PASSCODE)) {
        return window.GLOBAL_PASSCODE.trim();
      }
      if (typeof window.USER_PASSCODE !== 'undefined' && isValid(window.USER_PASSCODE)) {
        return window.USER_PASSCODE.trim();
      }
      var stored = safelyGetLocal('app_user_passcode');
      if (isValid(stored)) {
        return stored.trim();
      }

      // 無効なキャッシュが存在する場合は消去する
      if (stored) {
        safelyRemoveLocal('app_user_passcode');
      }
      return "";
    }

    // ■ 画面ロード時
    window.addEventListener('load', function () {
      offcanvas = new bootstrap.Offcanvas(document.getElementById('offcanvasMenu'));
      loginModal = new bootstrap.Modal(document.getElementById('loginModal'));

      var loginModalEl = document.getElementById('loginModal');
      loginModalEl.addEventListener('shown.bs.modal', function () {
        document.getElementById('login-passcode').focus();
      });

      // スワイプ操作の実装
      var touchStartX = 0;
      var touchEndX = 0;

      document.body.addEventListener('touchstart', function (e) {
        touchStartX = e.changedTouches[0].screenX;
      }, { passive: true });

      document.body.addEventListener('touchend', function (e) {
        touchEndX = e.changedTouches[0].screenX;
        handleSwipe();
      }, { passive: true });

      function handleSwipe() {
        var swipeThreshold = 80; // 80px以上スワイプで判定（誤動作防止のため感度を下げる）
        var xDiff = touchEndX - touchStartX;

        // ログイン画面表示中などはスワイプ無効
        if (document.getElementById('loginModal').classList.contains('show')) return;

        var navOrder = ['貸出', '返却', '充填']; // 自社一括を除外
        var currentIdx = navOrder.indexOf(currentView);
        if (currentIdx === -1) return; // 下部メニュー以外の画面ではスワイプ無効

        if (xDiff > swipeThreshold) {
          // 右スワイプ (前のメニュー)
          if (currentIdx > 0) switchMode(navOrder[currentIdx - 1]);
        } else if (xDiff < -swipeThreshold) {
          // 左スワイプ (次のメニュー)
          if (currentIdx < navOrder.length - 1) switchMode(navOrder[currentIdx + 1]);
        }
      }

      // ★ここから認証チェック開始
      checkAccessFlow();
    });

    function checkPasscodeInput(el) {
      if (el.value.length >= 6) {
        el.blur();
        doLogin();
      }
    }

    // ■■■ 認証フローと画面表示制御 ■■■
    function checkAccessFlow() {
      if (!GLOBAL_PASSCODE) {
        GLOBAL_PASSCODE = getCurrentUserPasscode();
      }

      var isGoogleAuth = (GLOBAL_STAFF_NAME && GLOBAL_STAFF_NAME !== 'ゲスト' && GLOBAL_STAFF_NAME !== 'undefined' && GLOBAL_STAFF_NAME.trim() !== "");
      var hasPasscode = !!GLOBAL_PASSCODE;

      if (isGoogleAuth) {
        // すでに名前が分かっているならOK
        resolveFinalView();
      } else if (hasPasscode) {
        // パスコードはあるが名前がまだ「ゲスト」の場合、サーバーに問い合わせて正式ログインする
        document.getElementById('login-passcode').value = GLOBAL_PASSCODE;
        doLogin();
      } else {
        // 何も情報がない -> ローディングを消してログインモーダルを表示
        hideInitialLoader();
        loginModal.show();
      }
    }

    // ■ 最終的な画面表示の決定
    function resolveFinalView() {
      // 権限OK -> 通常の現場アプリ画面を表示
      hideInitialLoader();

      google.script.url.getLocation(function (location) {
        var action = (location.parameter && location.parameter.action) ? location.parameter.action : "貸出";
        initAppView(action);
        if (typeof triggerInitialDataLoad === 'function') {
          triggerInitialDataLoad(action);
        }
      });
    }

    function hideInitialLoader() {
      var loader = document.getElementById('initial-loader');
      if (loader) {
        loader.style.opacity = '0';
        setTimeout(() => { loader.style.display = 'none'; }, 500);
      }
    }

    // アプリ画面の初期化
    function initAppView(startMode) {

      var nameEl = document.getElementById('header-staff-name');
      var displayName = (GLOBAL_STAFF_NAME && GLOBAL_STAFF_NAME !== 'undefined') ? GLOBAL_STAFF_NAME : "<?= staffName ?>";
      if (nameEl) nameEl.innerText = displayName + " さん";

      var menuNameEl = document.getElementById('menu-user-name');
      if (menuNameEl) menuNameEl.innerText = displayName;

      var emailText = (GLOBAL_USER_EMAIL && GLOBAL_USER_EMAIL !== 'undefined') ? GLOBAL_USER_EMAIL : "";
      var menuEmailEl = document.getElementById('menu-user-email');
      if (menuEmailEl) menuEmailEl.innerText = emailText;

      switchMode(startMode || '貸出');
    }

    function doLogin() {
      var pass = document.getElementById('login-passcode').value;
      var errEl = document.getElementById('login-error');
      errEl.style.display = 'none';

      if (!pass) return;

      // 初回ロード以外の手動ログイン時はローディングオーバーレイを出す
      var isInitial = (document.getElementById('initial-loader').style.display !== 'none');
      if (!isInitial) showLoading(true);

      google.script.run
        .withSuccessHandler(function (res) {
          if (!isInitial) showLoading(false);

          try {
            if (res.success) {
              GLOBAL_STAFF_NAME = res.user.name;
              GLOBAL_USER_ROLE = res.user.role;
              GLOBAL_PASSCODE = pass;

              // ★追加: 認証成功時にパスコードをブラウザに永続保存する
              safelySetLocal('app_user_passcode', pass);

              // ★ ビューモードをlocalStorageに保存（リダイレクトはしない）
              var userViewMode = (res.user && res.user.viewMode === 'ダイヤル') ? 'ダイヤル' : 'リスト';
              safelySetLocal('app_view_mode', userViewMode);

              loginModal.hide();
              if (!isInitial) showMessage(GLOBAL_STAFF_NAME + "さん、ログインしました", true);
              resolveFinalView();
            } else {
              // 失敗時
              hideInitialLoader(); // Forcefully hide it always if it gets here just in case!
              if (isInitial) hideInitialLoader();

              errEl.innerText = res.message;
              errEl.style.display = 'block';
              document.getElementById('login-passcode').value = '';
              loginModal.show();
            }
          } catch (err) {
            hideInitialLoader();
            if (!isInitial) showLoading(false);
            alert("ログイン処理中にエラーが発生しました: " + err.message);
          }

        })
        .withFailureHandler(function (e) {
          if (!isInitial) showLoading(false);
          hideInitialLoader(); // Forcefully hide just in case
          if (isInitial) hideInitialLoader();
          errEl.innerText = "通信エラー: " + e.message;
          errEl.style.display = 'block';
          loginModal.show();
        })
        .verifyPasscode(pass);
    }

    function showLoading(show) {
      document.getElementById('loading-overlay').style.display = show ? 'flex' : 'none';
    }

    function doLogout() {
      if (confirm("ログアウトしてパスコードの記憶を削除しますか？")) {
        safelyRemoveLocal('app_user_passcode');
        safelyRemoveLocal('app_view_mode');
        GLOBAL_PASSCODE = "";
        GLOBAL_STAFF_NAME = "ゲスト";
        GLOBAL_USER_ROLE = "";
        offcanvas.hide();
        // 画面をリロードして初期状態（ログイン画面）に戻す
        var loader = document.getElementById('initial-loader');
        if (loader) { loader.style.display = 'flex'; loader.style.opacity = '1'; }
        google.script.run
          .withSuccessHandler(function (url) { safelyNavigateTop(url); })
          .getScriptUrl();
      }
    }

    function switchMode(mode) {
      offcanvas.hide();
      document.body.classList.remove('dial-lock');
      document.getElementById('header-title').innerText = mode;

      // Show bulk return button in header only on operations views
      var bulkRetBtn = document.getElementById('header-bulk-return-btn');
      if (bulkRetBtn) bulkRetBtn.style.display = ['貸出', '返却', '充填'].includes(mode) ? 'inline-block' : 'none';

      var navOrder = ['貸出', '返却', '充填'];
      var oldIdx = navOrder.indexOf(currentView);
      var newIdx = navOrder.indexOf(mode);
      var animClass = 'view-slide-left'; // default
      if (oldIdx !== -1 && newIdx !== -1 && oldIdx !== newIdx) {
        animClass = (newIdx > oldIdx) ? 'view-slide-left' : 'view-slide-right';
      }

      currentView = mode; // 現在のビューを記憶（スワイプ用）

      ['view-operations', 'view-operations-sub', 'view-maintenance', 'view-mypage', 'view-order', 'view-inhouse', 'view-dashboard'].forEach(id => {
        var el = document.getElementById(id);
        if (el) el.style.display = 'none';
      });

      document.querySelectorAll('.nav-btn').forEach(b => b.className = 'nav-btn');

      var targetEl = null;

      if (['貸出', '返却', '充填'].includes(mode)) {
        targetEl = document.getElementById('view-operations');
        if (mode === '貸出') document.getElementById('nav-btn-lend').classList.add('active-lend');
        if (mode === '返却') document.getElementById('nav-btn-return').classList.add('active-return');
        if (mode === '充填') document.getElementById('nav-btn-fill').classList.add('active-fill');
        if (typeof initOperations === 'function') initOperations(mode);
      }
      else if (['破損報告'].includes(mode)) {
        targetEl = document.getElementById('view-operations-sub');
        if (typeof initOperationsSub === 'function') initOperationsSub();
      }
      else if (['修理済み', '耐圧検査完了'].includes(mode)) {
        targetEl = document.getElementById('view-maintenance');
        if (typeof initMaintenance === 'function') initMaintenance(mode);
      }
      else if (mode === 'マイページ') {
        targetEl = document.getElementById('view-mypage');
        if (typeof loadMyPageData === 'function') loadMyPageData(GLOBAL_PASSCODE);
      }
      else if (mode === '資材発注') {
        targetEl = document.getElementById('view-order');
        if (typeof initOrder === 'function') initOrder();
      }
      else if (mode === '自社管理') {
        targetEl = document.getElementById('view-inhouse');
        if (typeof initInHouse === 'function') initInHouse();
      }
      else if (mode === 'ダッシュボード') {
        targetEl = document.getElementById('view-dashboard');
        if (typeof loadDashboardData === 'function') loadDashboardData(GLOBAL_PASSCODE);
      }

      if (targetEl) {
        targetEl.style.display = 'block';
        targetEl.classList.remove('view-slide-left', 'view-slide-right');
        void targetEl.offsetWidth; // trigger reflow
        targetEl.classList.add(animClass);
        // アニメーション完了後にクラスを削除し、iOSのposition:fixedバグ（containing blockの残留）を防ぐ
        setTimeout(function () {
          targetEl.classList.remove('view-slide-left', 'view-slide-right');
        }, 350);
      }
    }

    function showMessage(msg, isSuccess) {
      var el = document.getElementById('global-message');
      el.innerText = msg;
      el.className = isSuccess ? 'alert alert-success shadow-sm' : 'alert alert-danger shadow-sm';
      el.style.display = 'block';
      setTimeout(() => { el.style.display = 'none'; }, 3000);
    }

    // ■ 設定モーダル
    var settingsModal;
    function openSettingsModal() {
      offcanvas.hide();
      if (!settingsModal) {
        settingsModal = new bootstrap.Modal(document.getElementById('settingsModal'));
      }
      var currentMode = SERVER_VIEW_MODE || 'リスト';
      if (currentMode === 'ダイヤル') {
        document.getElementById('vm-dial').checked = true;
      } else {
        document.getElementById('vm-list').checked = true;
      }
      updateViewModeHighlight();
      document.getElementById('settings-save-status').style.display = 'none';
      settingsModal.show();
    }

    function selectViewMode(mode) {
      if (mode === 'ダイヤル') {
        document.getElementById('vm-dial').checked = true;
      } else {
        document.getElementById('vm-list').checked = true;
      }
      updateViewModeHighlight();
    }

    function updateViewModeHighlight() {
      var listLabel = document.getElementById('setting-view-list');
      var dialLabel = document.getElementById('setting-view-dial');
      var isDialChecked = document.getElementById('vm-dial').checked;
      listLabel.style.borderColor = isDialChecked ? '#dee2e6' : '#0d6efd';
      listLabel.style.background = isDialChecked ? '#fff' : '#e8f0fe';
      dialLabel.style.borderColor = isDialChecked ? '#0d6efd' : '#dee2e6';
      dialLabel.style.background = isDialChecked ? '#e8f0fe' : '#fff';
    }

    function reloadWithViewMode(viewMode) {
      if (!viewMode) return;
      var url = "<?= scriptUrl ?>";
      var asciiMode = (viewMode === 'ダイヤル') ? 'dial' : 'list';
      if (asciiMode !== 'list') {
        url += (url.indexOf('?') === -1 ? '?' : '&') + 'viewMode=' + asciiMode;
      }
      safelyNavigateTop(url);
    }

    function saveSettings() {
      var selectedMode = document.getElementById('vm-dial').checked ? 'ダイヤル' : 'リスト';
      var passcode = getCurrentUserPasscode();
      var hasGoogleName = (typeof window.GLOBAL_STAFF_NAME !== 'undefined' && window.GLOBAL_STAFF_NAME && window.GLOBAL_STAFF_NAME !== 'ゲスト');

      if (!passcode && !hasGoogleName) {
        alert("認証情報が見つかりません。再ログインしてください。");
        return;
      }

      var statusEl = document.getElementById('settings-save-status');
      statusEl.innerHTML = '<span class="spinner-border spinner-border-sm"></span> 保存中...';
      statusEl.className = 'text-center mt-3 small text-muted';
      statusEl.style.display = 'block';

      google.script.run
        .withSuccessHandler(function (res) {
          if (res.success) {
            statusEl.innerHTML = '<i class="bi bi-check-circle-fill text-success"></i> ' + res.message;
            statusEl.className = 'text-center mt-3 small text-success fw-bold';
            safelySetLocal('app_view_mode', selectedMode);
            setTimeout(function () {
              settingsModal.hide();
              reloadWithViewMode(selectedMode);
            }, 800);
          } else {
            statusEl.innerHTML = '<i class="bi bi-exclamation-circle text-danger"></i> ' + res.message;
            statusEl.className = 'text-center mt-3 small text-danger';
          }
        })
        .withFailureHandler(function (e) {
          statusEl.innerHTML = '<i class="bi bi-exclamation-circle text-danger"></i> エラー: ' + e.message;
          statusEl.className = 'text-center mt-3 small text-danger';
        })
        .saveViewMode(passcode, selectedMode, typeof window.GLOBAL_STAFF_NAME !== 'undefined' ? window.GLOBAL_STAFF_NAME : "");
    }
  </script>
</body>

</html>