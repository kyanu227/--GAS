<!DOCTYPE html>
<html>

<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <style>
    body {
      background-color: #f8f9fa;
      padding-bottom: 160px;
    }

    .bulk-card {
      background: #fff;
      border: 1px solid #dee2e6;
      border-radius: 10px;
      padding: 10px 14px;
      margin-bottom: 8px;
      transition: background-color 0.2s, border-left-color 0.2s;
    }

    .bulk-id {
      font-size: 1.15rem;
      font-weight: 800;
      font-family: monospace;
      color: #212529;
      margin: 0;
    }

    .bulk-card.tag-unused {
      background: #f0fff4 !important;
      border-left: 5px solid #198754 !important;
    }

    .bulk-card.tag-defect {
      background: #fff5f5 !important;
      border-left: 5px solid #dc3545 !important;
    }


    .mini-slider-track {
      width: 156px;
      height: 32px;
      background: #e9ecef;
      border-radius: 16px;
      box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
      display: flex;
      position: relative;
    }

    .mini-slider-thumb {
      position: absolute;
      top: 2px;
      bottom: 2px;
      width: calc(33.333% - 4px);
      background: #fff;
      border-radius: 14px;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.15);
      transition: left 0.15s cubic-bezier(0.25, 0.8, 0.25, 1);
      z-index: 0;
    }

    .mini-slider-section {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1;
      font-size: 0.65rem;
    }

    .inhouse-prefix-header {
      background: #f0f4ff;
      border-left: 4px solid #0d6efd;
      padding: 4px 10px;
      font-weight: bold;
      font-size: 0.85rem;
      color: #0d6efd;
      border-radius: 4px;
      margin-bottom: 4px;
      margin-top: 10px;
    }

    .submit-float {
      position: fixed;
      bottom: calc(75px + env(safe-area-inset-bottom));
      left: 5%;
      width: 90%;
      padding: 15px;
      font-size: 1.2rem;
      font-weight: bold;
      border-radius: 50px;
      border: none;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
      z-index: 900;
      background-color: #0dcaf0;
      color: #000;
    }

    .submit-float:disabled {
      opacity: 0.6;
    }
  </style>
</head>

<body>

  <div class="container-fluid mt-3">

    <!-- ヘッダー -->
    <div class="d-flex justify-content-between align-items-center mb-3">
      <div>
        <span class="fw-bold fs-6">自社使用中タンク</span>
        <span class="badge bg-info text-dark ms-2" id="ih-count-badge">0件</span>
      </div>
      <button class="btn btn-sm btn-outline-secondary" onclick="ihLoad()">
        <i class="bi bi-arrow-clockwise"></i> 再取得
      </button>
    </div>

    <!-- 一括タグパネル（スワイプ） -->
    <div class="d-flex mb-3" id="ih-bulk-tag-panel" style="display:none !important;">
      <div class="bulk-card position-relative w-100 m-0 py-3 d-flex"
        style="box-shadow: 0 2px 8px rgba(0,0,0,0.05); border-color:#d5d9dd; cursor: pointer;"
        ontouchstart="sStart(event)" ontouchend="sEnd(event, 'global')">
        <input type="hidden" id="inhouse-swipe-slider" value="1">
        <div class="d-flex justify-content-between align-items-center w-100 position-relative"
          style="pointer-events: none; z-index: 1;">
          <div class="fw-bold text-secondary ps-2">全体を一括操作</div>
          <div class="mini-slider-track" style="width: 176px; pointer-events: none;">
            <div class="mini-slider-thumb" id="global-swipe-thumb" style="left: calc(33.333% + 2px);"></div>
            <div class="mini-slider-section"><span id="swipe-label-defect" class="text-muted fw-bolder">未充填</span></div>
            <div class="mini-slider-section"><span id="swipe-label-normal" class="text-dark fw-bolder">通常</span></div>
            <div class="mini-slider-section"><span id="swipe-label-unused" class="text-muted fw-bolder">未使用</span></div>
          </div>
        </div>
      </div>
    </div>

    <!-- タンク一覧 -->
    <div id="ih-list">
      <div class="text-center text-muted p-4">
        <span class="spinner-border spinner-border-sm"></span> 読み込み中...
      </div>
    </div>

  </div>

  <!-- 固定フッター送信ボタン -->
  <button class="submit-float" id="ih-submit-btn" style="display:none;" onclick="ihSubmit()">
    <span id="ih-submit-label">全て返却</span>
  </button>

</body>

<script>
  var inHouseTanks = [];
  var swipeStartX = null;

  function sStart(e) {
    swipeStartX = e.touches ? e.touches[0].clientX : e.clientX;
  }

  function sEnd(e, idx) {
    if (e.type === 'touchend' && swipeStartX !== null) {
      if (Math.abs(e.changedTouches[0].clientX - swipeStartX) < 10) {
        swipeStartX = null;
        return;
      }
    }

    var el = document.getElementById(idx === 'global' ? 'inhouse-swipe-slider' : 'card-slider-' + idx);
    var currentV = el ? parseInt(el.value, 10) : 1;
    var endX = e.changedTouches ? e.changedTouches[0].clientX : e.clientX;
    var newV = currentV;
    var diffX = swipeStartX !== null ? (endX - swipeStartX) : 0;

    if (diffX >= 30) {
      newV = Math.min(2, currentV + 1);
    } else if (diffX <= -30) {
      newV = Math.max(0, currentV - 1);
    }

    if (newV !== currentV && el) {
      el.value = newV;
      if (idx === 'global') handleInHouseSwipe(newV);
      else ihCardSwipe(idx, newV, false);
    }
    swipeStartX = null;
  }

  function initInHouse() {
    inHouseTanks = [];
    ihRenderList();
    ihLoad();
  }

  function ihLoad() {
    var listEl = document.getElementById('ih-list');
    listEl.innerHTML = '<div class="text-center text-muted p-4"><span class="spinner-border spinner-border-sm"></span> 取得中...</div>';
    document.getElementById('ih-submit-btn').style.display = 'none';
    document.getElementById('ih-bulk-tag-panel').style.display = 'none';

    google.script.run
      .withSuccessHandler(function (list) {
        inHouseTanks = ihSortTanks(
          list.map(function (item) { return { id: item.id, statusTag: 'normal' }; })
        );
        var slider = document.getElementById('inhouse-swipe-slider');
        if (slider) {
          slider.value = 1;
          handleInHouseSwipe(1);
        }
        ihRenderList();
      })
      .withFailureHandler(function (e) {
        listEl.innerHTML = '<div class="alert alert-danger py-2 small">取得エラー: ' + e.message + '</div>';
      })
      .getInHouseTanks();
  }

  function ihSortTanks(tanks) {
    return tanks.slice().sort(function (a, b) {
      var mA = String(a.id).replace(/[-\s]/g, '').toUpperCase().match(/^([A-Z]+)(\d+)$/);
      var mB = String(b.id).replace(/[-\s]/g, '').toUpperCase().match(/^([A-Z]+)(\d+)$/);
      if (!mA && !mB) return 0;
      if (!mA) return 1;
      if (!mB) return -1;
      if (mA[1] !== mB[1]) return mA[1] < mB[1] ? -1 : 1;
      return parseInt(mA[2], 10) - parseInt(mB[2], 10);
    });
  }

  function ihRenderList() {
    var listEl = document.getElementById('ih-list');
    var countBadge = document.getElementById('ih-count-badge');
    var submitBtn = document.getElementById('ih-submit-btn');
    var bulkPanel = document.getElementById('ih-bulk-tag-panel');

    listEl.innerHTML = '';
    countBadge.innerText = inHouseTanks.length + '件';

    if (inHouseTanks.length === 0) {
      listEl.innerHTML = '<div class="text-center text-muted p-4 mt-3"><i class="bi bi-check-circle display-1 text-success d-block mb-3"></i><h5>自社使用中のタンクはありません</h5><p class="small">現在自社使用中のタンクは0件です。</p></div>';
      submitBtn.style.display = 'none';
      bulkPanel.style.display = 'none';
      return;
    }

    // 一括タグパネル・送信ボタンを表示
    bulkPanel.style.display = 'block';
    submitBtn.style.display = 'block';
    document.getElementById('ih-submit-label').innerText = inHouseTanks.length + '件 全て返却';

    // prefixグループ別に描画
    var currentPrefix = null;
    inHouseTanks.forEach(function (item, idx) {
      var m = String(item.id).replace(/[-\s]/g, '').toUpperCase().match(/^([A-Z]+)/);
      var prefix = m ? m[1] : '?';

      if (prefix !== currentPrefix) {
        currentPrefix = prefix;
        var header = document.createElement('div');
        header.className = 'inhouse-prefix-header';
        header.innerText = prefix + ' タンク';
        listEl.appendChild(header);
      }

      var tagCls = '';
      if (item.statusTag === 'unused') tagCls = 'tag-unused';
      if (item.statusTag === 'defect') tagCls = 'tag-defect';

      var val = (item.statusTag === 'defect') ? 0 : (item.statusTag === 'unused') ? 2 : 1;
      var defectLabelCls = (val === 0) ? 'text-danger fw-bolder' : 'text-muted';
      var normalLabelCls = (val === 1) ? 'text-dark fw-bolder' : 'text-muted';
      var unusedLabelCls = (val === 2) ? 'text-success fw-bolder' : 'text-muted';
      var thumbLeft = (val === 0) ? '2px' : ((val === 2) ? 'calc(66.666% + 2px)' : 'calc(33.333% + 2px)');

      var card = document.createElement('div');
      card.id = 'ih-card-' + idx;
      card.className = 'bulk-card position-relative ' + tagCls;
      card.style.cursor = 'pointer';
      card.setAttribute('ontouchstart', 'sStart(event)');
      card.setAttribute('ontouchend', "sEnd(event, '" + idx + "')");

      card.innerHTML =
        '<input type="hidden" id="card-slider-' + idx + '" value="' + val + '">' +
        '<div class="d-flex justify-content-between align-items-center w-100 position-relative" style="pointer-events: none; z-index: 1;">' +
        '  <div class="bulk-id">' + escapeHtml(item.id) + '</div>' +
        '  <div class="mini-slider-track" style="pointer-events: none;">' +
        '    <div class="mini-slider-thumb" id="card-thumb-' + idx + '" style="left: ' + thumbLeft + ';"></div>' +
        '    <div class="mini-slider-section"><span id="card-label-defect-' + idx + '" class="' + defectLabelCls + '">未充填</span></div>' +
        '    <div class="mini-slider-section"><span id="card-label-normal-' + idx + '" class="' + normalLabelCls + '">通常</span></div>' +
        '    <div class="mini-slider-section"><span id="card-label-unused-' + idx + '" class="' + unusedLabelCls + '">未使用</span></div>' +
        '  </div>' +
        '</div>';
      listEl.appendChild(card);
    });
  }

  function ihCardSwipe(idx, val, fromGlobal) {
    var v = parseInt(val, 10);
    var tag = 'normal';
    if (v === 0) tag = 'defect';
    if (v === 2) tag = 'unused';

    inHouseTanks[idx].statusTag = tag;

    var card = document.getElementById('ih-card-' + idx);
    if (card) {
      card.className = 'bulk-card ' + (tag === 'unused' ? 'tag-unused' : (tag === 'defect' ? 'tag-defect' : ''));
    }

    var defectLabel = document.getElementById('card-label-defect-' + idx);
    var normalLabel = document.getElementById('card-label-normal-' + idx);
    var unusedLabel = document.getElementById('card-label-unused-' + idx);
    if (defectLabel) defectLabel.className = (v === 0) ? 'text-danger fw-bolder' : 'text-muted';
    if (normalLabel) normalLabel.className = (v === 1) ? 'text-dark fw-bolder' : 'text-muted';
    if (unusedLabel) unusedLabel.className = (v === 2) ? 'text-success fw-bolder' : 'text-muted';

    var thumb = document.getElementById('card-thumb-' + idx);
    if (thumb) {
      if (v === 0) thumb.style.left = '2px';
      else if (v === 2) thumb.style.left = 'calc(66.666% + 2px)';
      else thumb.style.left = 'calc(33.333% + 2px)';
    }

    if (!fromGlobal) {
      var allUnused = inHouseTanks.length > 0 && inHouseTanks.every(function (t) { return t.statusTag === 'unused'; });
      var allDefect = inHouseTanks.length > 0 && inHouseTanks.every(function (t) { return t.statusTag === 'defect'; });

      var globalSlider = document.getElementById('inhouse-swipe-slider');
      var gv = 1;
      if (allUnused) gv = 2;
      if (allDefect) gv = 0;

      if (globalSlider && parseInt(globalSlider.value, 10) !== gv) {
        globalSlider.value = gv;
        document.getElementById('swipe-label-defect').className = (gv === 0) ? 'text-danger fw-bolder' : 'text-muted';
        document.getElementById('swipe-label-normal').className = (gv === 1) ? 'text-dark fw-bolder' : 'text-muted';
        document.getElementById('swipe-label-unused').className = (gv === 2) ? 'text-success fw-bolder' : 'text-muted';
        var globalThumb = document.getElementById('global-swipe-thumb');
        if (globalThumb) {
          if (gv === 0) globalThumb.style.left = '2px';
          else if (gv === 2) globalThumb.style.left = 'calc(66.666% + 2px)';
          else globalThumb.style.left = 'calc(33.333% + 2px)';
        }
      }
    }
  }

  function handleInHouseSwipe(val) {
    if (inHouseTanks.length === 0) return;
    var v = parseInt(val, 10);
    document.getElementById('swipe-label-defect').className = (v === 0) ? 'text-danger fw-bolder' : 'text-muted';
    document.getElementById('swipe-label-normal').className = (v === 1) ? 'text-dark fw-bolder' : 'text-muted';
    document.getElementById('swipe-label-unused').className = (v === 2) ? 'text-success fw-bolder' : 'text-muted';

    var globalThumb = document.getElementById('global-swipe-thumb');
    if (globalThumb) {
      if (v === 0) globalThumb.style.left = '2px';
      else if (v === 2) globalThumb.style.left = 'calc(66.666% + 2px)';
      else globalThumb.style.left = 'calc(33.333% + 2px)';
    }

    var tag = 'normal';
    if (v === 0) tag = 'defect';
    if (v === 2) tag = 'unused';

    inHouseTanks.forEach(function (t, idx) {
      t.statusTag = tag;
      var cslider = document.getElementById('card-slider-' + idx);
      if (cslider) {
        cslider.value = v;
        ihCardSwipe(idx, v, true);
      }
    });
  }

  function ihSubmit() {
    if (inHouseTanks.length === 0) return;

    var unusedCount = inHouseTanks.filter(function (t) { return t.statusTag === 'unused'; }).length;
    var defectCount = inHouseTanks.filter(function (t) { return t.statusTag === 'defect'; }).length;
    var normalCount = inHouseTanks.length - unusedCount - defectCount;

    var msg = inHouseTanks.length + '件を返却します。\n';
    if (normalCount > 0) msg += '・通常返却: ' + normalCount + '件\n';
    if (unusedCount > 0) msg += '・未使用返却: ' + unusedCount + '件\n';
    if (defectCount > 0) msg += '・未充填返却: ' + defectCount + '件\n';
    msg += '\n実行しますか？';

    if (!confirm(msg)) return;

    var btn = document.getElementById('ih-submit-btn');
    btn.disabled = true;
    document.getElementById('ih-submit-label').innerText = '送信中...';

    var payload = {
      action: '自社一括返却',
      items: inHouseTanks,
      userPasscode: (typeof GLOBAL_PASSCODE !== 'undefined') ? GLOBAL_PASSCODE : ''
    };

    google.script.run
      .withSuccessHandler(function (res) {
        btn.disabled = false;
        if (res.success) {
          inHouseTanks = [];
          ihRenderList();
          alert(res.message);
        } else {
          document.getElementById('ih-submit-label').innerText = inHouseTanks.length + '件 全て返却';
          var errMsg = 'エラー: ' + res.message + '\n';
          if (res.failedItems) res.failedItems.forEach(function (i) { errMsg += i.id + ': ' + i.reason + '\n'; });
          alert(errMsg);
        }
      })
      .withFailureHandler(function (e) {
        btn.disabled = false;
        document.getElementById('ih-submit-label').innerText = inHouseTanks.length + '件 全て返却';
        alert('システムエラー: ' + e.message);
      })
      .submitOperations(payload);
  }

  function escapeHtml(str) {
    return String(str)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;');
  }
</script>

</html>