<!DOCTYPE html>
<html>

<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <style>
    body {
      background-color: #f8f9fa;
      padding-bottom: 160px;
    }

    .bulk-card {
      background: #fff;
      border: 1px solid #dee2e6;
      border-radius: 12px;
      padding: 12px 10px;
      display: flex;
      flex-direction: row;
      align-items: center;
      margin-bottom: 8px;
      transition: background-color 0.2s, border-left-color 0.2s;
      box-shadow: 2px 2px 8px rgba(0, 0, 0, 0.02);
    }

    .bulk-id {
      font-size: 1.25rem;
      font-weight: 800;
      font-family: monospace;
      color: #212529;
    }

    .bulk-card.tag-unused {
      background: #f0fff4 !important;
      border-left: 5px solid #198754 !important;
    }

    .bulk-card.tag-defect {
      background: #fff5f5 !important;
      border-left: 5px solid #dc3545 !important;
    }

    .swipe-container-futuristic {
      background: linear-gradient(145deg, #ffffff, #f0f0f0);
      border-radius: 16px;
      padding: 12px 16px;
      border: 1px solid rgba(255, 255, 255, 0.8);
      box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.05), -4px -4px 10px #ffffff;
    }

    .swipe-track-futuristic {
      position: absolute;
      top: 50%;
      left: 0;
      right: 0;
      height: 8px;
      background: #2b2e35;
      border-radius: 10px;
      transform: translateY(-50%);
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.6), 0 1px 1px rgba(255, 255, 255, 0.8);
      z-index: 0;
    }

    .swipe-dots-futuristic {
      position: absolute;
      top: 50%;
      left: 14px;
      right: 14px;
      transform: translateY(-50%);
      display: flex;
      justify-content: space-between;
      pointer-events: none;
      z-index: 1;
    }

    .swipe-dot-f {
      width: 6px;
      height: 6px;
      background: #495057;
      border-radius: 50%;
      box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.5);
    }

    .swipe-dot-f.center {
      width: 8px;
      height: 8px;
      background: #6c757d;
    }

    .custom-slider-futuristic {
      appearance: none;
      -webkit-appearance: none;
      width: 100%;
      height: 32px;
      background: transparent;
      outline: none;
      z-index: 2;
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      margin: 0;
    }

    .custom-slider-futuristic::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: #1a1d24;
      cursor: pointer;
      border: 2px solid var(--thumb-color, #6c757d);
      box-shadow: 0 0 10px var(--thumb-color, #6c757d), inset 0 0 4px var(--thumb-color, #6c757d);
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    .inhouse-prefix-header {
      background: #f0f4ff;
      border-left: 4px solid #0d6efd;
      padding: 4px 10px;
      font-weight: bold;
      font-size: 0.85rem;
      color: #0d6efd;
      border-radius: 4px;
      margin-bottom: 4px;
      margin-top: 10px;
    }

    .submit-float {
      position: fixed;
      bottom: calc(75px + env(safe-area-inset-bottom));
      left: 5%;
      width: 90%;
      padding: 15px;
      font-size: 1.2rem;
      font-weight: bold;
      border-radius: 50px;
      border: none;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
      z-index: 900;
      background-color: #0dcaf0;
      color: #000;
    }

    .submit-float:disabled {
      opacity: 0.6;
    }
  </style>
</head>

<body>

  <div class="container-fluid mt-3">

    <!-- ヘッダー -->
    <div class="d-flex justify-content-between align-items-center mb-3">
      <div>
        <span class="fw-bold fs-6">自社使用中タンク</span>
        <span class="badge bg-info text-dark ms-2" id="ih-count-badge">0件</span>
      </div>
      <button class="btn btn-sm btn-outline-secondary" onclick="ihLoad()">
        <i class="bi bi-arrow-clockwise"></i> 再取得
      </button>
    </div>

    <!-- 一括タグパネル（スワイプ） -->
    <div class="d-flex mb-3" id="ih-bulk-tag-panel" style="display:none !important;">
      <div class="swipe-container-futuristic w-100">
        <div class="d-flex justify-content-between small fw-bold mb-2 px-1">
          <span id="swipe-label-defect" class="text-danger"
            style="text-shadow: 0 0 5px rgba(220,53,69,0.3);">未充填全て</span>
          <span id="swipe-label-normal" class="text-dark">通常</span>
          <span id="swipe-label-unused" class="text-success"
            style="text-shadow: 0 0 5px rgba(25,135,84,0.3);">未使用全て</span>
        </div>
        <div class="position-relative" style="height: 32px;">
          <div class="swipe-track-futuristic"></div>
          <div class="swipe-dots-futuristic">
            <div class="swipe-dot-f"></div>
            <div class="swipe-dot-f center"></div>
            <div class="swipe-dot-f"></div>
          </div>
          <input type="range" class="custom-slider-futuristic" min="0" max="2" step="1" id="inhouse-swipe-slider"
            value="1" oninput="handleInHouseSwipe(this.value)" onchange="handleInHouseSwipe(this.value)"
            style="--thumb-color: #6c757d;">
        </div>
      </div>
    </div>

    <!-- タンク一覧 -->
    <div id="ih-list">
      <div class="text-center text-muted p-4">
        <span class="spinner-border spinner-border-sm"></span> 読み込み中...
      </div>
    </div>

  </div>

  <!-- 固定フッター送信ボタン -->
  <button class="submit-float" id="ih-submit-btn" style="display:none;" onclick="ihSubmit()">
    <span id="ih-submit-label">全て返却</span>
  </button>

</body>

<script>
  var inHouseTanks = [];

  function initInHouse() {
    inHouseTanks = [];
    ihRenderList();
    ihLoad();
  }

  function ihLoad() {
    var listEl = document.getElementById('ih-list');
    listEl.innerHTML = '<div class="text-center text-muted p-4"><span class="spinner-border spinner-border-sm"></span> 取得中...</div>';
    document.getElementById('ih-submit-btn').style.display = 'none';
    document.getElementById('ih-bulk-tag-panel').style.display = 'none';

    google.script.run
      .withSuccessHandler(function (list) {
        inHouseTanks = ihSortTanks(
          list.map(function (item) { return { id: item.id, statusTag: 'normal' }; })
        );
        var slider = document.getElementById('inhouse-swipe-slider');
        if (slider) {
          slider.value = 1;
          handleInHouseSwipe(1);
        }
        ihRenderList();
      })
      .withFailureHandler(function (e) {
        listEl.innerHTML = '<div class="alert alert-danger py-2 small">取得エラー: ' + e.message + '</div>';
      })
      .getInHouseTanks();
  }

  function ihSortTanks(tanks) {
    return tanks.slice().sort(function (a, b) {
      var mA = String(a.id).replace(/[-\s]/g, '').toUpperCase().match(/^([A-Z]+)(\d+)$/);
      var mB = String(b.id).replace(/[-\s]/g, '').toUpperCase().match(/^([A-Z]+)(\d+)$/);
      if (!mA && !mB) return 0;
      if (!mA) return 1;
      if (!mB) return -1;
      if (mA[1] !== mB[1]) return mA[1] < mB[1] ? -1 : 1;
      return parseInt(mA[2], 10) - parseInt(mB[2], 10);
    });
  }

  function ihRenderList() {
    var listEl = document.getElementById('ih-list');
    var countBadge = document.getElementById('ih-count-badge');
    var submitBtn = document.getElementById('ih-submit-btn');
    var bulkPanel = document.getElementById('ih-bulk-tag-panel');

    listEl.innerHTML = '';
    countBadge.innerText = inHouseTanks.length + '件';

    if (inHouseTanks.length === 0) {
      listEl.innerHTML = '<div class="text-center text-muted p-4 mt-3"><i class="bi bi-check-circle display-1 text-success d-block mb-3"></i><h5>自社使用中のタンクはありません</h5><p class="small">現在自社使用中のタンクは0件です。</p></div>';
      submitBtn.style.display = 'none';
      bulkPanel.style.display = 'none';
      return;
    }

    // 一括タグパネル・送信ボタンを表示
    bulkPanel.style.display = 'block';
    submitBtn.style.display = 'block';
    document.getElementById('ih-submit-label').innerText = inHouseTanks.length + '件 全て返却';

    // prefixグループ別に描画
    var currentPrefix = null;
    inHouseTanks.forEach(function (item, idx) {
      var m = String(item.id).replace(/[-\s]/g, '').toUpperCase().match(/^([A-Z]+)/);
      var prefix = m ? m[1] : '?';

      if (prefix !== currentPrefix) {
        currentPrefix = prefix;
        var header = document.createElement('div');
        header.className = 'inhouse-prefix-header';
        header.innerText = prefix + ' タンク';
        listEl.appendChild(header);
      }

      var tagCls = '';
      if (item.statusTag === 'unused') tagCls = 'tag-unused';
      if (item.statusTag === 'defect') tagCls = 'tag-defect';

      var val = (item.statusTag === 'defect') ? 0 : (item.statusTag === 'unused') ? 2 : 1;
      var thumbColor = (val === 0) ? '#dc3545' : ((val === 2) ? '#198754' : '#6c757d');
      var defectLabelCls = (val === 0) ? 'text-danger fw-bolder' : 'text-muted';
      var normalLabelCls = (val === 1) ? 'text-dark fw-bolder' : 'text-muted';
      var unusedLabelCls = (val === 2) ? 'text-success fw-bolder' : 'text-muted';

      var card = document.createElement('div');
      card.id = 'ih-card-' + idx;
      card.className = 'bulk-card ' + tagCls;
      card.innerHTML =
        '<div class="d-flex w-100 align-items-center">' +
        '  <div class="d-flex flex-column pe-2" style="width: 85px; flex-shrink: 0;">' +
        '    <div class="bulk-id mb-1" style="line-height:1.1;">' + escapeHtml(item.id) + '</div>' +
        '    <div class="d-flex gap-1 fw-bold" style="font-size: 0.65rem;">' +
        '      <span id="card-label-defect-' + idx + '" class="' + defectLabelCls + '">未充填</span>' +
        '      <span id="card-label-normal-' + idx + '" class="' + normalLabelCls + '">通常</span>' +
        '      <span id="card-label-unused-' + idx + '" class="' + unusedLabelCls + '">未使用</span>' +
        '    </div>' +
        '  </div>' +
        '  <div class="flex-grow-1 position-relative" style="height: 32px;">' +
        '    <div class="swipe-track-futuristic"></div>' +
        '    <div class="swipe-dots-futuristic">' +
        '      <div class="swipe-dot-f"></div>' +
        '      <div class="swipe-dot-f center"></div>' +
        '      <div class="swipe-dot-f"></div>' +
        '    </div>' +
        '    <input type="range" class="custom-slider-futuristic" min="0" max="2" step="1" id="card-slider-' + idx + '" value="' + val + '" ' +
        '      oninput="ihCardSwipe(' + idx + ', this.value)" onchange="ihCardSwipe(' + idx + ', this.value)" ' +
        '      style="--thumb-color: ' + thumbColor + ';">' +
        '  </div>' +
        '</div>';
      listEl.appendChild(card);
    });
  }

  function ihCardSwipe(idx, val, fromGlobal) {
    var v = parseInt(val, 10);
    var tag = 'normal';
    if (v === 0) tag = 'defect';
    if (v === 2) tag = 'unused';

    inHouseTanks[idx].statusTag = tag;

    var card = document.getElementById('ih-card-' + idx);
    if (card) {
      card.className = 'bulk-card ' + (tag === 'unused' ? 'tag-unused' : (tag === 'defect' ? 'tag-defect' : ''));
    }

    var defectLabel = document.getElementById('card-label-defect-' + idx);
    var normalLabel = document.getElementById('card-label-normal-' + idx);
    var unusedLabel = document.getElementById('card-label-unused-' + idx);
    if (defectLabel) defectLabel.className = (v === 0) ? 'text-danger fw-bolder' : 'text-muted';
    if (normalLabel) normalLabel.className = (v === 1) ? 'text-dark fw-bolder' : 'text-muted';
    if (unusedLabel) unusedLabel.className = (v === 2) ? 'text-success fw-bolder' : 'text-muted';

    var slider = document.getElementById('card-slider-' + idx);
    if (slider) {
      if (v === 0) slider.style.setProperty('--thumb-color', '#dc3545');
      else if (v === 2) slider.style.setProperty('--thumb-color', '#198754');
      else slider.style.setProperty('--thumb-color', '#6c757d');
    }

    if (!fromGlobal) {
      var allUnused = inHouseTanks.length > 0 && inHouseTanks.every(function (t) { return t.statusTag === 'unused'; });
      var allDefect = inHouseTanks.length > 0 && inHouseTanks.every(function (t) { return t.statusTag === 'defect'; });

      var globalSlider = document.getElementById('inhouse-swipe-slider');
      var gv = 1;
      if (allUnused) gv = 2;
      if (allDefect) gv = 0;

      if (globalSlider && parseInt(globalSlider.value, 10) !== gv) {
        globalSlider.value = gv;
        document.getElementById('swipe-label-defect').className = (gv === 0) ? 'text-danger fw-bolder' : 'text-muted';
        document.getElementById('swipe-label-normal').className = (gv === 1) ? 'text-dark fw-bolder' : 'text-muted';
        document.getElementById('swipe-label-unused').className = (gv === 2) ? 'text-success fw-bolder' : 'text-muted';
        if (gv === 0) globalSlider.style.setProperty('--thumb-color', '#dc3545');
        else if (gv === 2) globalSlider.style.setProperty('--thumb-color', '#198754');
        else globalSlider.style.setProperty('--thumb-color', '#6c757d');
      }
    }
  }

  function handleInHouseSwipe(val) {
    if (inHouseTanks.length === 0) return;
    var v = parseInt(val, 10);
    document.getElementById('swipe-label-defect').className = (v === 0) ? 'text-danger fw-bolder' : 'text-muted';
    document.getElementById('swipe-label-normal').className = (v === 1) ? 'text-dark fw-bolder' : 'text-muted';
    document.getElementById('swipe-label-unused').className = (v === 2) ? 'text-success fw-bolder' : 'text-muted';

    var slider = document.getElementById('inhouse-swipe-slider');
    if (slider) {
      if (v === 0) slider.style.setProperty('--thumb-color', '#dc3545'); // red
      else if (v === 2) slider.style.setProperty('--thumb-color', '#198754'); // green
      else slider.style.setProperty('--thumb-color', '#6c757d'); // gray center
    }

    var tag = 'normal';
    if (v === 0) tag = 'defect';
    if (v === 2) tag = 'unused';

    inHouseTanks.forEach(function (t, idx) {
      t.statusTag = tag;
      var cslider = document.getElementById('card-slider-' + idx);
      if (cslider) {
        cslider.value = v;
        ihCardSwipe(idx, v, true);
      }
    });
  }

  function ihSubmit() {
    if (inHouseTanks.length === 0) return;

    var unusedCount = inHouseTanks.filter(function (t) { return t.statusTag === 'unused'; }).length;
    var defectCount = inHouseTanks.filter(function (t) { return t.statusTag === 'defect'; }).length;
    var normalCount = inHouseTanks.length - unusedCount - defectCount;

    var msg = inHouseTanks.length + '件を返却します。\n';
    if (normalCount > 0) msg += '・通常返却: ' + normalCount + '件\n';
    if (unusedCount > 0) msg += '・未使用返却: ' + unusedCount + '件\n';
    if (defectCount > 0) msg += '・未充填返却: ' + defectCount + '件\n';
    msg += '\n実行しますか？';

    if (!confirm(msg)) return;

    var btn = document.getElementById('ih-submit-btn');
    btn.disabled = true;
    document.getElementById('ih-submit-label').innerText = '送信中...';

    var payload = {
      action: '自社一括返却',
      items: inHouseTanks,
      userPasscode: (typeof GLOBAL_PASSCODE !== 'undefined') ? GLOBAL_PASSCODE : ''
    };

    google.script.run
      .withSuccessHandler(function (res) {
        btn.disabled = false;
        if (res.success) {
          inHouseTanks = [];
          ihRenderList();
          alert(res.message);
        } else {
          document.getElementById('ih-submit-label').innerText = inHouseTanks.length + '件 全て返却';
          var errMsg = 'エラー: ' + res.message + '\n';
          if (res.failedItems) res.failedItems.forEach(function (i) { errMsg += i.id + ': ' + i.reason + '\n'; });
          alert(errMsg);
        }
      })
      .withFailureHandler(function (e) {
        btn.disabled = false;
        document.getElementById('ih-submit-label').innerText = inHouseTanks.length + '件 全て返却';
        alert('システムエラー: ' + e.message);
      })
      .submitOperations(payload);
  }

  function escapeHtml(str) {
    return String(str)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;');
  }
</script>

</html>